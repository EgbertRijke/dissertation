\chapter{Type-valued equivalence relations}\label{chap:giraud}

We discussed in \cref{sec:set-quotients} the notion of an ordinary equivalence relation on a type $A$, which is specified as a reflexive, symmetric, and transitive $\prop$-valued binary relation on $A$. In \cref{thm:quotient_up} we established that for an equivalence relation $\mathcal{R}$ in this sense, the quotient $A/\mathcal{R}$ can be specified as the image of $\mathcal{R}:A\to (A\to \prop)$. Since $A\to \prop$ is a set, it follows that the set quotient $A/\mathcal{R}$ is also a set. 

Proposition-valued equivalence relations as described above are just one level in a hierarchy of equivalence relations. The next level up consists of `$1$-equivalence relations', or `pre-groupoid structures' on a type $A$, the data of which endows $A$ with the structure of a pre-groupoid in the sense of Ahrens, Kapulkin, Shulman \cite{AhrensKapulkinShulman}. In the case of pre-groupoid structures one also needs to account for associativity, unit laws, and inverse laws. Groupoid quotients have been defined as higher inductive types in homotopy type theory by Sojakova \cite{SojakovaPhD}.

\begin{table}\label{tab:hierarchy}
\caption{The truncation hierarchy of equivalence relations}
\begin{tabular}{cll}
\toprule
\emph{level} & \emph{equivalence structure} & \emph{quotient operation} \\
\midrule
$-1$ & trivial relation & propositional truncation \\
$0$ & $\prop$-valued equivalence relation & set-quotient \\
$1$ & pre-$1$-groupoid structure & Rezk completion \\
$\vdots$ & \qquad$\vdots$ & \qquad$\vdots$ \\
$\infty$ & `pre-$\infty$-groupoid structure' & $\infty$-quotient \\
\bottomrule
\end{tabular}
\end{table}

In order to formulate a notion of $2$-equivalence relations, one requires higher-dimensional structure analogous to that found in the notion of a bi-groupoid. As one goes higher up the hierarchy of general `$n$-equivalence relations we get a combinatorial explosion of data to be specified to account for all the higher coherences. In this work, we propose a way to bypass the problem of having to specify an infinite amount of coherence data by using a coinductive definition of $\infty$-equivalence relations involving involving homotopy pushouts.

\section{Systems of equivalence relations}

The identity type of any type is the initial reflexive type-valued binary relation on types.
By virtue of their (homotopy) initiality, they obtain the structure
of a higher groupoid. This can be made precise externally, as is done in the
work of Van den Berg and Garner \cite{VanDenBergGarner}, and LeFanu Lumsdaine 
\cite{Lumsdaine10}, but so far it has been an open problem to give in type theory
a satisfactory, sufficiently explicit description for a reflexive relation
to be an $\infty$-equivalence relation.

A more general class of examples that possess higher groupoid structure consist of pre-kernels of maps.
Recall that the pre-kernel $\prekersym_A(f)$ of a map $f:A\to B$ is the reflexive relation given by
\begin{equation*}
x,y\mapsto f(x)=f(y).
\end{equation*}
The proof of reflexivity is given by $\lam{x}\refl{f(x)}$.
We call $\prekersym_A(f)$ the pre-kernel of $f$, since it is only the underlying reflexive relation of the kernel but it lacks an explicit structure of an equivalence relation. Note that the image of $f$ is a model for the $\infty$-quotient $A/\prekersym_A(f)$, because the identity types of $\im(f)$ coincides with those of $X$.

We turn to the question of specifying what it means to define a notion of homotopy coherent equivalence relations in homotopy type theory, and thus the formal specification of the problem we set out to solve. In the following, we write 
$(A\mathbin{\downarrow_s}\UU)$ for the type of \emph{surjective} maps out of $A$, that is:
\begin{equation*}
(A\mathbin{\downarrow_s}\UU)\defeq \sm{B:\UU}{f:A\to B}\mathsf{isSurj}(f).
\end{equation*}
The operation that associates to a surjective map $f:A\to B$ the pre-kernel of $f$, is an operation of type
\begin{equation*}
\prekersym_A(f):(A\mathbin{\downarrow_s}\UU)\to \mathsf{rRel}_A,
\end{equation*}
where $\mathsf{rRel}_A$ is the type of all type-valued reflexive relations on $A$ \cref{defn:rrel}.
Our goal in this chapter is to define \emph{systems of equivalence relations}, which we are now able to define.

\begin{defn}\label{defn:system}
A \define{system of equivalence relations} consists of a structure
\begin{equation*}
\mathsf{isEqRel}_A:\mathsf{rRel}_A\to\UU
\end{equation*}
for each type $A:\UU$, equipped with the following additional structure:
\begin{enumerate}
\item A lift $\prekersym_A$ to an operation $\kersym_A$ as indicated in the diagram
\begin{equation*}
\begin{tikzcd}[column sep=large]
& \sm{\mathcal{R}:\mathsf{rRel}(A)}\mathsf{isEqRel}_A(\mathcal{R}) \arrow[d,->>] \\
(A \mathbin{{\downarrow}_s} U) \arrow[r,swap,"\prekersym_A"] \arrow[ur,densely dotted,"\kersym_A"] & \mathsf{rRel}(A)
\end{tikzcd}
\end{equation*}
In other words, every pre-kernel needs to be given the structure of an equivalence relation so that it becomes a kernel.
\item A term witnessing that the function $\kersym_A$ is an equivalence.
\end{enumerate}
\end{defn}

The first requirement just means that any pre-kernel must possess (in a canonical way) the structure of a homotopy coherent equivalence relation. The second requirement involves finding for every equivalence relation $\mathcal{R}$ on $A$, the quotient $A/\mathcal{R}$ and a surjective map $q_{\mathcal{R}} : A\to A/\mathcal{R}$. This gives the inverse $\qsym_A$ of $\kersym_A$. Then, to show that $\qsym_A\circ \kersym_A=1$, you need to show that there is a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
& A \arrow[dl,swap,"q_{\kersym_A(f)}"] \arrow[dr,"f"] & \phantom{A/\kersym_A(f)} \\
A/\kersym_A(f) \arrow[rr] & & B
\end{tikzcd}
\end{equation*}
in which the bottom map is an equivalence. Finally, the quotient operation $\qsym_A$ needs to be shown effective, i.e. it needs to be shown that \[\kersym_A\circ \qsym_A =1.\]
This involves first showing that, for any equivalence relation $\mathcal{R}:=(R,\rho,H)$ there is a fiberwise equivalence
\begin{equation*}
\prd{x,y:A} (q_{\mathcal{R}}(x)=q_{\mathcal{R}}(y)) \to{} R(x,y)
\end{equation*}
preserving reflexivity. This determines a path $p : \prekersym_A(q_{\mathcal{R}})=(R,\rho)$. To complete the proof of effectiveness, it needs to be shown that \[\trans{p}{\mathsf{pr}_2(\kersym_A(\qsym_A(\mathcal{R})))}= H.\] 
In other words, that the canonical structure of being an equivalence relation that the pre-kernel $\prekersym_A(\qsym_A(\mathcal{R}))$ possesses, agrees with the assumed structure $H$, that $(R,\rho)$ is an equivalence relation.

The problem of finding a structure $\mathsf{isEqRel}$ satisfying the described conditions, is in fact trivial when we drop the requirement that $\mathsf{isEqRel}_A$ is a family of \emph{small} types. The type of all such structures is contractible, with $\mathsf{fib}_{\prekersym_A}$ at the center of contraction. However, it should be noted that this is a completely uninformative solution, and our goal is to describe a \emph{small} structure equivalent to $\mathsf{fib}_{\prekersym_A}$. Another way of phrasing the main problem is therefore to show that $k_A$ is an essentially small map, and we recall from \cref{thm:classifier} that a map is essentially small if and only if it is classified by the universe.

As a final remark on \autoref{defn:system} we note that in the special case where the base type $A$ is taken to be the unit type $\unit$, the problem reduces to specifying what it means for a pointed type to possess in a homotopy coherent way the structure of a \emph{loop space}. Indeed, a reflexive relation on the unit type is nothing else than a pointed type, and the type of surjective maps out of the unit type is nothing else than the type of \emph{pointed connected types}.

\section{Principal equivalence relations}

\begin{defn}
A \define{principal equivalence relation} on a type $X$ consists of
\begin{enumerate}
\item A binary relation $R:X\to (X\to \UU)$ with a proof $\rho:\prd{x:X}R(x,x)$ of reflexivity,
\item A type family
\begin{equation*}
\mathcal{O}_R : \im(R)\to\UU \\
\end{equation*}
of \define{$R$-orientations} on the predicates $P:X\to \UU$ in the image of $R$, with a \define{canonical $R$-orientation}
\begin{equation*}
o_R : \prd{x:X}\mathcal{O}_R(R(x)),
\end{equation*}
\end{enumerate}
such that the type
\begin{equation*}
\sm{P:\im(R)}\mathcal{O}_R(P)\times P(x)
\end{equation*}
is contractible for every $x:X$. 
\end{defn}

\begin{eg}
A principal equivalence relation on $\unit$ is the same thing as a principal H-space.
\end{eg}

\begin{eg}
A $\prop$-valued equivalence relation on a type $X$ is a principal equivalence relation. The type of orientations is always contractible.
\end{eg}

\begin{eg}
Given any pre-category $\mathcal{C}$, the isomorphisms form a principal equivalence relation on $\mathrm{ob}(\mathcal{C})$. 
\end{eg}

\begin{defn}
Given a principal equivalence relation $R$ on $X$, we define the \define{quotient} 
\begin{equation*}
X/R\defeq\sm{P:\im(R)}\mathcal{O}_R(P).
\end{equation*}
The \define{quotient map} $q_R:X\to X/R$ is defined to be $x\mapsto\pairr{R(x),o_R(x)}$. 
\end{defn}

\begin{lem}
Let $R$ be a principal equivalence relation on $X$. Then the quotient map $q_R$ is surjective.
\end{lem}

\begin{proof}
Let $P:\im(R)$ and $o:\mathcal{O}_R(P)$. We need to show that
\begin{equation*}
\brck{\sm{x:X}\pairr{P,o}=\pairr{R(x),o_R(x)}}.
\end{equation*}
By the contractibility condition of principal equivalence relations, this is equivalent to
\begin{equation*}
\brck{\sm{x:X}P(x)}.
\end{equation*}
Since $P:\im(R)$, we get to assume $x:X$ and $e:P=R(x)$. Now, since $R$ is reflexive, we obtain $\brck{\sm{x:X}P(x)}$. 
\end{proof}

\subsection{The quotient as a classifier}

Recall that a span from $Y$ to $X$ in dependent type theory is equivalently described as a binary relation of type $Y\to (X\to \UU)$. 

\begin{defn}
Let $R$ be a principal equivalence relation on $X$, and let $Y$ be a type. An \define{$R$-span} on $Y$ is defined to be a span $S:Y\to (X\to\UU)$ so that $S(y):\im(R)$ for any $y:Y$. An \define{oriented $R$-span} from $Y$ to $X$ is an $R$-span $S$ with an $R$-orientation for each $S(y,x)$.
\end{defn}

\begin{rmk}
Equivalently, an oriented $R$-span from $Y$ to $X$ is a map $Y\to X/R$. 
\end{rmk}

\begin{thm}\label{thm:classifying}
Let $R$ be a principal equivalence relation on $X$. Then the quotient map $q_R$
classifies the oriented $R$-spans, in the sense that for each $R$-span $S$ from $Y$ to $X$, the type of maps $g:Y\to X/R$ such that the square
\begin{equation}\label{eq:classifier}
\begin{tikzcd}
\sm{x:X}{y:Y}S(y,x) \arrow[r,"\pi_1"] \arrow[d,swap,"\pi_2"] & X \arrow[d,"q_R"] \\
Y \arrow[r,swap,"g"] & X/R
\end{tikzcd}
\end{equation}
is a pullback square, is equivalent to the type of $R$-orientations of $S$.  
\end{thm}

\begin{proof}
Let $g\defeq\pairr{S',\gamma'}:Y\to X/R$ be a map, and let $K:g\circ\pi_2\htpy q_X\circ \pi_1$ such that the square in \autoref{eq:classifier} is a pullback. An equivalent way of saying that the square in \autoref{eq:classifier} is a pullback, is that the map
\begin{equation*}
K_{x,y}: S'(y,x)\to (\pairr{S(y),\gamma(y)}=q_R(x))
\end{equation*}
is an equivalence. By the contractibility condition of principal equivalence relations, the type of fiberwise equivalences $K_{x,y}$ is equivalent to the type of fiberwise equivalences
\begin{equation*}
K'_{x,y} : S'(y,x)\to S(y,x).
\end{equation*}
The type of pairs consisting of $S'$ and the equivalences $K'$ is contractible with $S$ at the center of contraction, so the type of triples $\pairr{S',\gamma',K}$ is equivalent to the type of orientations of $S$.
\begin{comment}
\begin{equation*}
\prd{y:Y}\mathcal{O}_R(S(y))
\end{equation*}

Let $\gamma$ be an $R$-orientation of $S$, and define $g\defeq\pairr{S,\gamma}:Y\to X/R$. 
By the contractibility condition of principal equivalence relations, we obtain a fiberwise equivalence
\begin{equation*}
H^\gamma_{x,y}:\eqv{S(y,x)}{(g(y)=q_R(x))}
\end{equation*}
which serves at the same time as a homotopy of type $\pi_2\circ g\htpy \pi_1\circ q_X$. 
From the fact that $H_{x,y}$ we see that the square is a pullback.

Now we need to show that the map $\varphi\defeq\gamma\mapsto\pairr{\pairr{S,\gamma},H^\gamma}$ is an equivalence. Consider a map $g\defeq\pairr{S',\gamma'}:Y\to X/R$ and a homotopy
$K:g\circ\pi_2\htpy q_X\circ \pi_1$ such that the square in \autoref{eq:classifier} is a pullback. An equivalent way of saying that the square in \autoref{eq:classifier} is a pullback, is that the map
\begin{equation*}
K_{x,y}: S'(y,x)\to (g(y)=q_R(x))
\end{equation*}
is an equivalence for each $x:X$ and $y:Y$.

The fiber of $\varphi$ at a pair $\pairr{g,K}$ consisting of a map $g:Y\to X/R$ and a homotopy $K: g\circ\pi_2\htpy q_X\circ \pi_2$ for which the square in \autoref{eq:classifier} is a pullback, is equivalent to the type
\begin{align*}
\sm{\gamma:\prd{y:Y}\mathcal{O}_R(S(y))} \pairr{g,K}=\pairr{S,\gamma,H^\gamma}
\end{align*}
This type is equivalent to
\begin{equation*}
\sm{\gamma:\prd{y:Y}\mathcal{O}_R(S(y))}{\alpha:\pi_1\circ g=S}{\beta:\trans{\alpha}{\pi_2\circ g}=\gamma} \trans{\pairr{\alpha,\beta}}{K}=H^\gamma.
\end{equation*}
Since $\gamma$ appears free on one side of an equality, this type is equivalent to the type
\begin{equation*}
\sm{\alpha:\pi_1\circ g=S} \trans{\alpha}{K}=H^{\trans{\alpha}{\pi_2\circ g}}.
\end{equation*}
This is equivalent to the type
\begin{equation*}
\pairr{\pi_1\circ g,K}=
\end{equation*}
This is an identity type in the fiber 
By type theoretic choice, this type is equivalent to the type
\begin{align*}
\prd{y:Y}\sm{\gamma(y):\mathcal{O}_R(S(y))} \pairr{S(y),\gamma(y)}=g(y)
\end{align*}
By the pullback square of \autoref{eq:classifier}, it follows that $\pi_1\circ g:Y\to \im(R)$ is equal to $S$. By transporting $\pi_2(g(y))$ along this equality, we see that the type $\pairr{S(y),\gamma(y)}=g(y)$ is equivalent to the type $\pairr{S(y),\gamma(y)}=\pairr{S(y),\beta(y)}$ for some orientation $\beta(y):\mathcal{O}_R(S(y))$. Hence we see that the fiber is contractible.
\end{comment}
\end{proof}

\subsection{The quotient approximation construction}

The quotient $X/R$, as stated, is not in $\UU$. The goal of the current section is to give a resizing argument, showing that for any principal equivalence relation $R$ on $X$, there is a type in $\UU$ which is equivalent to the quotient $X/R$. We do this via the quotient approximation construction, which constructs a type sequence with an equivalence from its sequential colimit to $X/R$.

\begin{defn}\label{defn:qac}
Let $R$ be a principal equivalence relation on $X$. The \define{quotient approximation construction} is an endomorphism on the type
\begin{equation*}
\sm{Y:\UU} Y\to X/R.
\end{equation*}
The empty type inhabits the above type, so we obtain a map of type
\begin{equation*}
\N_{-1}\to\Big(\sm{Y:\UU} Y\to X/R\Big).
\end{equation*}
We denote the types in this sequence by $(X/R)_n$. Furthermore, we get for each $n:\N_{-1}$ a relation $\tilde{R}_n:(X/R)_n\to (X\to\UU)$, and an orientation
\begin{equation*}
o_{\tilde{R}_n}:\prd{t:(X/R)_n} \mathcal{O}_R(\tilde{R}_n(t)).
\end{equation*}
\end{defn}

\begin{proof}[Construction]
Let $Y:\UU$ and $\pairr{S,\gamma}:Y\to X/R$. By pulling back along the tautological map $q_R$ and pushing out again, we obtain $Y^+$ and $\pairr{S^+,\gamma^+}$ as indicated in the following diagram
\begin{equation*}
\begin{tikzcd}
\sm{x:X}{y:Y}S(y,x) \arrow[r,"\pi_1"] \arrow[d,swap,"\pi_2"] & X \arrow[d,"\inl"] \arrow[ddr,bend left=15,"q_R"] \\
Y \arrow[r,"\inr"] \arrow[drr,bend right=15,swap,"{\pairr{S,\gamma}}"] & Y^+ \arrow[dr,densely dotted,near start,swap,"{\pairr{S^+,\gamma^+}}"] \\
& & X/R
\end{tikzcd}
\end{equation*}
\end{proof}

It will be useful in the examples below to abstract the above definition to a notion of `quotient approximation system' that does not directly involve a principal equivalence relation. 

\begin{thm}\label{thm:iteratedjoin}
Let $R$ be a principal equivalence relation on $X$, and consider $\pairr{S,\gamma}:Y\to X/R$. Then there is an equivalence
\begin{equation*}
\eqv{\Big(\sm{y:Y^+}S^+(y,x)\Big)}{\join{\Big(\sm{y:X}R(y,x)\Big)}{\Big(\sm{y:Y}S(y,x)\Big)}}.
\end{equation*}
\end{thm}

\begin{proof}
Let $x:X$, giving us the map $q_R(x):\unit\to X/R$. Since $q_R(x)\jdeq\pairr{R(x),o_R(x)}$. We will pull back the pushout square along $q_R(x):\unit\to X/R$. This gives the diagram
\begin{equation*}
\begin{tikzcd}
\sm{x':X}{y:Y} S(y,x)\times S(y,x') \arrow[r,densely dotted,"\alpha"] \arrow[d,swap,"\pi_2"] & \sm{x':X}R(x',x) \arrow[d,"\inl"] \arrow[ddr,bend left=15] \\
\sm{y:Y}S(y,x) \arrow[r,"\inr"] \arrow[drr,bend right=15] & \sm{y:Y^+}S^+(y,x) \arrow[dr] \\
& & \unit
\end{tikzcd}
\end{equation*}
where the $\alpha$ is uniquely determined by the universal property of the pullback, so that 
the triangle
\begin{equation*}
\begin{tikzcd}
\sm{x':X}{y:Y} S(y,x)\times S(y,x') \arrow[r,densely dotted,"\alpha"] \arrow[dr,swap,"\pi_1"] & \sm{x':X}R(x',x) \arrow[d,"\pi_1"] \\
& X
\end{tikzcd}
\end{equation*}
commutes. We assert that for any $p:S(y,x)$ and any $x':X$, there is an equivalence of type $\eqv{S(y,x')}{R(x',x)}$, inducing an equivalence such that the diagram
\begin{small}
\begin{equation*}
\begin{tikzcd}
\sm{x':X}{y:Y} S(y,x)\times S(y,x') \arrow[dr,densely dotted] \arrow[d,"\eqvsym"] \\
\Big(\sm{x':X}R(x',x)\Big)\times\Big(\sm{y:Y}S(y,x)\Big) \arrow[r] & \sm{x':X}R(x',x)
\end{tikzcd}
\end{equation*}
\end{small}
commutes. By the contractibility condition of principal equivalence relations, we have an equivalences of type 
\begin{align*}
S(y,x) & \eqvsym (\pairr{S(y),\gamma(y)}=q_R(x)) \\
S(y,x') & \eqvsym (\pairr{S(y),\gamma(y)}=q_R(x')).
\end{align*} 
The equivalence $\eqv{S(y,x')}{R(x',x)}$ is therefore given by concatenation with the path induced $p:S(y,x)$. This finishes the construction of the asserted equivalence.

Thus, we conclude that the outer square in the diagram
\begin{equation*}
\begin{tikzcd}
\Big(\sm{x':X}R(x',x)\Big)\times\Big(\sm{y:Y}S(y,x)\Big) \arrow[r,"\pi_1"] \arrow[d,swap,"\pi_2"] & \sm{x':X}R(x',x) \arrow[d,"\inl"] \arrow[ddr,bend left=15] \\
\sm{y:Y}S(y,x) \arrow[r,"\inr"] \arrow[drr,bend right=15] & \sm{y:Y^+}S^+(y,x) \arrow[dr] \\
& & \unit
\end{tikzcd}
\end{equation*}
is a pullback. By the descent theorem, the inner square is a pushout.
\end{proof}

Recall that by convention, the $0$-fold join of a type with itself is empty. Of course, for any type $A$ we have $\join{\emptyt}{A}\eqvsym A$. 

\begin{cor}
Let $R$ be a principal equivalence relation on $X$. Then, for any $x:X$, the type $\sm{y:(X/R)_n}\tilde{R}_n(y,x)$ is equivalent to the $(n+1)$-fold join of $\sm{y:X}R(y,x)$ with itself. 
\end{cor}

\begin{thm}\label{thm:quotients_are_small}
The map $\pairr{\tilde{R}_\infty,o_{\tilde{R}_n}}:(X/R)_\infty \to X/R$ is an equivalence. 
\end{thm}

\begin{proof}
Note that, since $q_R$ is surjective, we only need to prove contractibility of the fibers at $q_R(x)\jdeq\pairr{R(x),o_R(x)}$, for each $x:X$. 

The fiber of $\pairr{\tilde{R}_\infty,o_{\tilde{R}_\infty}}$ at a pair $\pairr{R(x),o_R(x)}$ in $X/R$ is given by
\begin{equation*}
\sm{t:(X/R)_\infty} \pairr{\tilde{R}_\infty(t),o_{\tilde{R}_\infty}(t)}=\pairr{R(x),o_R(x)}
\end{equation*}
By the flattening lemma, this fiber is equivalent to
\begin{equation*}
\tfcolim\Big(\sm{t:(X/R)_n} \pairr{\tilde{R}_n(t),o_{\tilde{R}_n}(t)}=\pairr{R(x),o_R(x)}\Big)
\end{equation*}
Of course, the type $\pairr{\tilde{R}_n(t),o_{\tilde{R}_n}(t)}=\pairr{R(x),o_R(x)}$ is equivalent to the type $\tilde{R}_n(t,x)$, so our goal is to show that
\begin{equation*}
\tfcolim\Big(\sm{t:(X/R)_n}\tilde{R}_n(t,x)\Big)
\end{equation*}
is contractible. This follows from the fact that $\sm{t:(X/R)_n}\tilde{R}_n(t,x)$ is equivalent to the $(n+1)$-fold join of $\sm{t:X}R(t,x)$ with itself.
\end{proof}

\subsection{Effectiveness of the quotient}

\begin{defn}
The type of all principal equivalence relations on $X$ is denoted by $\mathrm{PrER}(X)$. 
\end{defn}

\begin{defn}\label{defn:Q}
We define the map $\mathcal{Q}_X: \mathrm{PrER}(X)\to (X\,\downarrow_{x}\,\UU)$
by
\begin{equation*}
\mathcal{Q}_X(R)\defeq \pairr{X/R,q_R,\nameless}
\end{equation*}
where the proof that $q_R$ is surjective is left unnamed.
\end{defn}

\begin{defn}
Let $f:X\to B$ be a function. Then we define the principal equivalence relation $\mathcal{K}_X(f)$, the \define{kernel of $f$}. 
\end{defn}

\begin{proof}[Construction]
We first define the reflexive relation and the type of orientations.
\begin{enumerate}
\item We take $R(x,y)\defeq (f(x)=f(y))$, with $\rho(x)\defeq \refl{f(x)}$. 
\item To define the $R$-orientations, we will first define a comparison map $c_f : \im(f)\to\im(R)$ for which the triangle
\begin{equation}\label{eq:intro_cf}
\begin{tikzcd}
& X \arrow[dl,swap,"f"] \arrow[dr,"q_R"] \\
\im(f) \arrow[rr,swap,"c_f"] & & \im(R)
\end{tikzcd}
\end{equation}
commutes. We take $c_f(b)\defeq x\mapsto f(x)=b$, so it is obvious that the mentioned triangle commutes. To see that $c_f(b)$ is in the image of $R$, we have to show that $\brck{\sm{y:X} c_f(b)=R(y)}$. Since we have $\brck{\fib{f}{b}}$, it is equivalent to show that
\begin{equation*}
\fib{f}{b}\to\brck{\sm{y:X}c_f(b)=R(y)}.
\end{equation*}
For this, it suffices to show that
\begin{equation*}
\fib{f}{b}\to\sm{y:X}c_f(b)=R(y).
\end{equation*}
Let $\pairr{y,p}:\fib{f}{b}$. Then we have $c_f(b)=c_f(f(y))\defeq R(y)$, completing the definition of $c_f$. 

Now we can define 
\begin{equation*}
\mathcal{O}_R(P)\defeq \fib{c_f}{P}
\end{equation*}
Then we have $o_R(x)\defeq \pairr{x,\refl{R(x)}}:\mathcal{O}_R(R(x))$. 
\end{enumerate}
It remains to show that
\begin{equation*}
\sm{P:\im(R)}\mathcal{O}_R(P)\times P(x)
\end{equation*}
is contractible. Recall the canonical equivalence $b\mapsto\pairr{c_f(b),b,\refl{c_f(b)}}$, for which the triangle
\begin{equation*}
\begin{tikzcd}
\im(f) \arrow[dr,swap,"c_f"] \arrow[rr,"\eqvsym"] & & \sm{P:\im(R)}\mathcal{O}_R(P) \arrow[dl,"\proj1"] \\
& \im(R)
\end{tikzcd}
\end{equation*}
commutes. By this equivalence it follows that $\sm{P:\im(R)}\mathcal{O}_R(P)\times P(x)$ is equivalent to $\sm{b:\im(f)}c_f(b,x)$, which is contractible.
\end{proof}

\begin{defn}\label{defn:QKid}
Let $f:X\to B$ be a function. Then there is a commuting triangle
\begin{equation*}
\begin{tikzcd}
& X \arrow[dl,swap,"f"] \arrow[dr,"q_{\mathcal{K}_X(f)}"] \\
\im(f) \arrow[rr,swap,"\alpha_f"] & & X/\mathcal{K}_X(f)
\end{tikzcd}
\end{equation*}
in which the bottom map is an equivalence.
\end{defn}

\begin{proof}[Construction]
We already have the map $c_f:\im(f)\to\im(R)$, introduced in \autoref{eq:intro_cf}. Since $\mathcal{O}_R(P)\jdeq\fib{c_f}{P}$, we immediately obtain the term
\begin{equation*}
\delta_f\defeq \lam{b}\pairr{b,\refl{c_f(b)}}:\prd{b:\im(f)}\mathcal{O}_R(c_f(b)).
\end{equation*}
This gives us $\alpha_f\defeq\pairr{c_f,\delta_f}$. The triangle of the specification of $\alpha_f$ commutes trivially.

Now we need to show that $\alpha_f$ is an equivalence. We do this by showing that $\fib{\alpha_f}{P,o}$ is contractible for any $P:\im(R)$ and $o:\mathcal{O}_R(P)$. Since contractibility is a mere proposition, we get to use $x:X$ and $e:P= R(x)$ from the fact that $P:\im(R)$. Moreover, by the fact that $\eqv{(\pairr{R(x),o}=\pairr{R(x),o_R(x)})}{R(x,x)}$ and that $R$ is reflexive, we see that we have $\pairr{P,o}=\pairr{R(x),o_R(x)}$. So it suffices to show that
\begin{equation*}
\sm{b:\im(f)} \pairr{c_f(b),\delta_f(b)}=\pairr{R(x),o_R(x)}
\end{equation*}
is contractible. The summand is equivalent to $c_f(b)$, and it is immediate from the defintion of $c_f$ that $\sm{b:\im(f)}c_f(b)$ is contractible.
\end{proof}

\begin{thm}\label{thm:PrER_effective}
The map $\mathcal{Q}_X:\mathrm{PrER}(X)\to(X\downarrow_{\mathsf{surj}}\UU)$ is an equivalence, with inverse $\mathcal{K}_X$.
\end{thm}

\begin{proof}
\autoref{defn:QKid} gives us an equality $\mathcal{Q}_X(\mathcal{K}_X(B,f,\nameless))=\pairr{B,f,\nameless}$, for each surjective map $f:X\to B$. Hence it remains to show that $\mathcal{K}_X(q_R)=R$ for each principal equivalence relation $R$. 

Let $R$ be a principal equivalence relation on $X$. By the contractibility condition of principal equivalence relations, we get a fiberwise equivalence $\eqv{R(x,y)}{(q_R(x)=q_R(y))}$ which respects reflexivity.
So it remains to find a fiberwise equivalence $e_P:\eqv{\mathcal{O}_R(P)}{\mathcal{O}_{\mathcal{K}_X(q_R)}(P)}$ such that $e_{R(x)}(o_R(x))=o_{\mathcal{K}_X(q_R)}(x)$ for each $x:X$.

We first show that the bottom triangle in
\begin{equation*}
\begin{tikzcd} & X \arrow[dl,swap,"q_R"] \arrow[dr,"q_R"] \\
\im(q_R) \arrow[dr,swap,"c_{q_R}"] \arrow[rr,"\eqvsym"] & & X/R \arrow[dl,"\proj1"] \\
& \im(R)
\end{tikzcd}
\end{equation*}
commutes, where the horizontal map is the canonnical equivalence obtained from the fact that $q_R:X\to X/R$ is surjective. Recall that $c_{q_R}(P,o)$ is the type family $x\mapsto (q_R(x)=\pairr{P,o})$ over $X$. Since $q_R(x)\jdeq\pairr{R(x),o_R(x)}$, it follows that
\begin{equation*}
c_{q_R}(P,o)(x)\eqvsym P(x).
\end{equation*}
Hence it must be the case that $c_{q_R}(P,o)=P$, as desired. Now note that 
\begin{align*}
\mathcal{O}_R(P)
& \eqvsym \fib{\proj1}{P} \\
& \eqvsym \fib{c_{q_R}}{P} \\
& \jdeq \mathcal{O}_{\mathcal{K}_X(q_R)}(P),
\end{align*}
and since the top triangle commutes this equivalence maps $o_R(x)$ to $o_{\mathcal{K}_X(q_R)}(x)$. 
\end{proof}

\section{Saturated relations}

\subsection{Saturatedness of pre-kernels}
In this subsection we introduce the concept of saturated relations by using the join construction (\cref{sec:join_stage2}) to analyze the pre-kernel of a map.

Suppose we are given a map $f:A\to X$. The fiberwise join operation $g\mapsto \join{f}{g}$  can be used to define an operation
\begin{equation*}
\Big(\sm{B:\UU}{g:B\to X}\mathrm{hom}_X(f,g)\Big)\to\Big(\sm{B:\UU}{g:B\to X}\mathrm{hom}_X(f,g)\Big),
\end{equation*}
taking a commuting triangle of the form
\begin{equation}\label{eq:triangle}
\begin{tikzcd}[column sep=tiny]
A \arrow[dr,swap,"f"] \arrow[rr,"h"] & & B \arrow[dl,"g"] \\
\phantom{B} & X & \phantom{A}
\end{tikzcd}
\end{equation}
to the commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=0]
A \arrow[dr,swap,"f"] \arrow[rr,"\inl"] & & \join[X]{A}{B} \arrow[dl,"\join{f}{g}"] \\
\phantom{\join[X]{A}{B}} & X.
\end{tikzcd}
\end{equation*}
Given a commuting triangle as in \cref{eq:triangle}, with a homotopy $H:f\htpy g\circ h$, we define the \define{pullback relation} $E_{f,g}:A\to B\to \UU$ of $f$ and $g$ by
\begin{equation*}
E_{f,g}(a,b)\defeq f(a)=g(b).
\end{equation*}
Since we have a homotopy $H:f\htpy g\circ h$, we see that the pullback relation $E_{f,g}$ comes equipped with a term
\begin{equation*}
\prd{a:A}E_{f,g}(a,h(a)).
\end{equation*}
The pullback relation $E_{f,g}$ is therefore a \emph{graph extension} of $h$, in the following sense:

\begin{defn}
For any map $h:A\to (B\to \UU)$, the \define{graph} of $h$ is defined to be the relation
\begin{equation*}
\mathsf{graph}_h:A\to (B\to \UU)
\end{equation*}
given by $\mathsf{graph}_h(a,b)\defeq h(a)=b$, equipped with the term
\begin{equation*}
\lam{a}\refl{h(a)} : \prd{a:A}\mathsf{graph}_h(a,h(a)).
\end{equation*}
A \define{graph extension} of $h$ is a pair $\mathcal{R}\jdeq (R,\rho)$ consisting of
\begin{align*}
R & : A \to (B\to \UU) \\
\rho & : \prd{a:A} R(a,h(a)).
\end{align*}
We will write $\mathsf{gphExt}(h)$ for the type of all (small) graph extensions of $h$.
\end{defn}

\begin{rmk}
For any graph extension $\mathcal{R}$ of $h$, the map
\begin{equation*}
\mathsf{ev\usc{}refl}:\Big(\prd{b:B} \mathsf{graph}_h(a,b)\to R(a,b)\Big)\to R(a,h(a))
\end{equation*}
is an equivalence by the Yoneda lemma (\cref{lem:yoneda}), for any $a:A$. Therefore, the `reflexivity' term $\rho$ of a graph extension uniquely determines a map from the graph of $h$ to $\mathcal{R}$. In this sense the graph of $h$ is contained in any graph extension $R$ of $h$. 

Note that an ordinary reflexive relation is a graph extension of the identity function. In particular, the pullback relation $E_{f,f}$ is the pre-kernel of $f$. 
\end{rmk}

By the action on commuting triangles induced by the fiberwise join operation, we also obtain the pullback relation $E_{f,\join{f}{g}}$, which is a graph extension of the map $\inl:A\to \join[X]{A}{B}$. Note that we have a fiberwise transformation
\begin{equation*}
\prd{b:B}E_{f,g}(a,b)\to E_{f,\join{f}{g}}(a,\inr(b))
\end{equation*}
taking a path $p:f(a)=g(b)$ to the concatenation
\begin{equation*}
\begin{tikzcd}
f(a) \arrow[r,equals] & g(b) \arrow[r,equals,"\mathsf{right\usc{}comp}(b)"] &[3em] (\join{f}{g})(\inr(b)),
\end{tikzcd}
\end{equation*}
where the identification $\mathsf{right\usc{}comp}(b)$ comes from the (typal) computation rule of the pushout.
The trivial but important observation now is that path concatenation $\ct{\blank}{\mathsf{right\usc{}comp}(b)}$ is an equivalence for every $b:B$.

\begin{defn}
Let $\mathcal{R}$ be a graph extension of $h:A\to B$. We say that $\mathcal{R}$ is \define{pre-saturated} if it comes equipped with for every $a:A$ a \define{right extension} $(S,\sigma,p)$ of $\mathcal{R}$, consisting of
\begin{align*}
S & : A \to A\sqcup^{\mathcal{R}}B\to\UU, \\
\sigma & : \prd{a:A} S(a,\inl(a)),
\end{align*}
and a proof $p$ witnessing that the fiberwise transformation
\begin{equation*}
\epsilon_{\mathcal{R},\mathcal{S}}:\prd{b:B} R(a,b)\to S(a,\inr(b))
\end{equation*}
given by 
\begin{equation*}
\epsilon_{\mathcal{R},\mathcal{S}}(r)\defeq \mathsf{tr}_{S(a)}(\glue(r),\sigma(a))
\end{equation*}
is a fiberwise equivalence, for every $a:A$. We write $\mathsf{presat}(\mathcal{R})$ for the type of right extensions $(S,\sigma,p)$ of $\mathcal{R}$.
\end{defn}

\begin{rmk}
By \cref{thm:pb_fibequiv} there is another way of phrasing that $(S,\sigma)$ is a right extension of $(R,\rho)$: the canonical transformation $\varepsilon_{\mathcal{R},\mathcal{S}}$ from $R(a)$ to $S(a)$ induces a pullback square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\sm{b:B}R(a,b) \arrow[d,swap,"\proj 1"] \arrow[r,"{\total[\inr]{\varepsilon_{\mathcal{R},\mathcal{S}}}}"] & \sm{x:A\sqcup^{\mathcal{R}} B}S(a,x) \arrow[d,"\proj 1"] \\
B \arrow[r,swap,"\inr"] & A\sqcup^{\mathcal{R}} B.
\end{tikzcd}
\end{equation*}
From yet another point of view, we see that $S(a)$ is an extension of $R(a)$ along $\inr$, in the sense that the triangle
\begin{equation*}
\begin{tikzcd}
B \arrow[d,swap,"\inr"] \arrow[r,"R(a)"] & \UU \\
A\sqcup^{\mathcal{R}}B \arrow[ur,swap,"S(a)"]
\end{tikzcd}
\end{equation*}
commutes. Note, however, that this triangle commutes in a canonical way, because it is a particular fiberwise transformation that is required to be a fiberwise equivalence.
\end{rmk}

\begin{lem}\label{thm:pb_presat}
Consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=small]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with a homotopy $H:f\htpy g\circ h$. Then the graph extension $E_{f,g}$ of $h$ is presaturated.
\end{lem}

\begin{proof}
We will show that the pullback relation $E_{f,\join{f}{g}}:A\to \join[X]{A}{B}\to\UU$ is a right extension of $E_{f,g}$. 
To see this, we need to show that the map
\begin{equation*}
\epsilon_{E_{f,g},E_{f,\join{f}{g}}} : \prd{b:B} E_{f,g}(a,b)\to E_{f,\join{f}{g}}(a,\inr(b))
\end{equation*}
given by
\begin{equation*}
(p:f(a)=g(b))\mapsto \mathsf{tr}_{E_{f,\join{f}{g}}(a)}(\glue(p),\mathsf{left\usc{}comp}(a))
\end{equation*}
is an equivalence. Note that for any $p:f(a)=x$ we have a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
f(a) \arrow[rr,equals,"\mathsf{left\usc{}comp}(a)"] \arrow[dr,equals,swap,"{\mathsf{tr}(p,\mathsf{left\usc{}comp}(a))}"] & & (\join{f}{g})(\inl(a)) \arrow[dl,equals,"\ap{\join{f}{g}}{p}"] \\
\phantom{(\join{f}{g})(\inl(a))} & (\join{f}{g})(x),
\end{tikzcd}
\end{equation*}
by identification elimination. Therefore it follows that
\begin{equation*}
\epsilon(p)= \ct{\mathsf{left\usc{}comp}(a)}{\ap{\join{f}{g}}{p}}
\end{equation*}
for any $p:f(a)=g(b)$. Now observe that also the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
f(a) \arrow[r,equals,"\mathsf{left\usc{}comp}(a)"] \arrow[d,equals,swap,"p"] & (\join{f}{g})(\inl(a)) \arrow[d,equals,"\ap{\join{f}{g}}{p}"] \\
g(b) \arrow[r,equals,swap,"\mathsf{right\usc{}comp}(b)"] & (\join{f}{g})(\inr(b))
\end{tikzcd}
\end{equation*}
commutes. This shows that the function $\epsilon:E_{f,g}(a,b)\to E_{f,\join{f}{g}}(a,\inr(b))$ is homotopic to the concatenation function $\ct{\blank}{\mathsf{right\usc{}comp}(b)}$, which is an equivalence, for any $b:B$.
\end{proof}

Now we observe that not only $E_{f,g}$ is presaturated, its right extension is again a pullback relation so it is again presaturated. Moreover, the right extension of its right extension is again a pullback relation, so it is again presaturated, and so on. This leads to the concepts of $n$-saturatedness and ($\infty$-)saturatedness.

In the following definition we will write 
\begin{equation*}
\xi_{\mathcal{R}}: \mathsf{presat}(\mathcal{R})\to \mathsf{gphExt}(\inl)
\end{equation*}
for the forgetful map, i.e.~the map given by $(S,\sigma,p)\mapsto (S,\sigma)$.

\begin{defn}
We define a family
\begin{equation*}
\mathsf{sat} : \N\to \prd{A:\UU}{B:\UU}{h:A\to B} \mathsf{gphExt}(h)\to \UU
\end{equation*}
by $\mathsf{sat}_0(\mathcal{R})\defeq \unit$, and 
\begin{equation*}
\mathsf{sat}_{n+1}(\mathcal{R})\defeq \sm{t:\mathsf{presat}(\mathcal{R})} \mathsf{sat}_n(\xi_{\mathcal{R}}(t)).
\end{equation*}
\end{defn}

\begin{defn}
We will define for every $n:\N$ the furgetful map
\begin{equation*}
u_n:\mathsf{sat}_{n+1}(\mathcal{R})\to \mathsf{sat}_{n}(\mathcal{R}).
\end{equation*}
\end{defn}

\begin{proof}[Construction]
In the case $n\jdeq 0$ we take the unique map into $\unit$.
For the inductive step, assume that $\mathsf{sat}_{n+1}(\mathcal{R})\to \mathsf{sat}_{n}(\mathcal{R})$ for any graph extension $\mathcal{R}$ of $h$, for any $h:A\to B$. 
Then it suffices to show
\begin{equation*}
\prd{t:\mathsf{presat}(\mathcal{R})} \mathsf{sat}_{n+1}(\xi_{\mathcal{R}}(t))\to \mathsf{sat}_{n}(\xi_{\mathcal{R}}(t))
\end{equation*}
which we get immediately from the inductive hypothesis.
\end{proof}

Thus, we get for each graph extension $\mathcal{R}$ of $h:A\to B$ a type sequence
\begin{equation}\label{eq:sat}
\begin{tikzcd}
\cdots \arrow[r] & \mathsf{sat}_{2}(\mathcal{R}) \arrow[r] & \mathsf{sat}_1(\mathcal{R}) \arrow[r] & \unit.
\end{tikzcd}
\end{equation}

\begin{defn}
Let $\mathcal{R}$ be a graph extension of a map $h:A\to B$. We write $\mathsf{sat}(\mathcal{R})$ for the limit of the sequence displayed in \cref{eq:sat}, and we say that $\mathcal{R}$ is \define{saturated} if it comes equipped with a term of type $\mathsf{sat}(\mathcal{R})$. 

Moreover, a reflexive relation $\mathcal{R}$ on a type $A$ is said to be \define{saturated} if it is saturated in the previous sense as a graph extension of the identity function $\idfunc:A\to A$.
\end{defn}

\begin{thm}\label{thm:pb_sat}
Consider a commuting triangle
\begin{equation}\label{eq:pb_sat}
\begin{tikzcd}[column sep=small]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation}
with a homotopy $H:f\htpy g\circ h$. Then the pullback relation $E_{f,g}$ is saturated. In particular, the pre-kernel of any map $f:A\to X$ is saturated.
\end{thm}

\begin{proof}
We have to construct
\begin{align*}
s(f,g) & : \prd{n:\N} \mathsf{sat}_n(E_{f,g}) \\
t(f,g) & : \prd{n:\N} u_n(s(f,g)_{n+1})=s(f,g)_n. 
\end{align*}
for every commuting triangle as \cref{eq:pb_sat}. We will first show by induction on $n:\N$ that for every commuting triangle as in \cref{eq:pb_sat}, the relation $E_{f,g}$ is $n$-saturated. Since $\mathsf{sat}_0(\mathcal{R})$ is contractible for any $\mathcal{R}$, the base case is trivial.
Now suppose that every $E_{f,g}$ is $n$-saturated. We have seen in \cref{thm:pb_presat} that $E_{f,\join{f}{g}}$ is a right extension of $E_{f,g}$. By the induction hypothesis we have that $E_{f,\join{f}{g}}$ is $n$-saturated. Therefore we conclude that $E_{f,g}$ is $(n+1)$-saturated. This finishes the construction of $s$.

We will construct $t$ similarly by induction on $n:\N$, showing that 
\begin{equation*}
u_n(s(f,g)_{n+1})=s(f,g)_n
\end{equation*}
for every pullback relation $E_{f,g}$. Again, by the contractibility of $\mathsf{sat}_0(\mathcal{R})$, the base case is trivial. For the inductive step we assume that $u_n(s(f,g)_{n+1})=s(f,g)_n$ for every pullback relation $E_{f,g}$. Then we have
\begin{align*}
u_{n+1}(s(f,g)_{n+2}) & \jdeq u_n(s(f,\join{f}{g})_{n+1}) \\
& = s(f,\join{f}{g})_n \\
& \jdeq s(f,g)_{n+1},
\end{align*}
completing the construction of $t$. 
\end{proof}

For any function $h:A\to B$, write 
\begin{equation*}
E: (B\,{\downarrow}\,\UU) \to \mathsf{gphExt}(h)
\end{equation*}
for the operation $(g:B\to X)\mapsto E_{g\circ h,g}$.

\begin{cor}
For any function $h:A\to B$, the operation $E$ taking $g:B\to X$ to the pullback relation $E_{g\circ h,g}$ has a lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{gphExt}(h)}\mathsf{sat}(\mathcal{R}) \arrow[d,"\proj 1"] \\
(B\,{\downarrow}\,\UU) \arrow[r,swap,"E"] \arrow[ur,densely dotted,"\mathcal{E}"] & \mathsf{gphExt}(h).
\end{tikzcd}
\end{equation*}
\end{cor}

\begin{cor}
For any function $h:A\to B$, the operation $k$ taking $f:A\to X$ to its pre-kernel has a lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{rRel}}\mathsf{sat}(\mathcal{R}) \arrow[d,"\proj 1"] \\
(A\,{\downarrow}\,\UU) \arrow[r,swap,"k"] \arrow[ur,densely dotted,"\mathcal{K}"] & \mathsf{rRel}(A).
\end{tikzcd}
\end{equation*}
\end{cor}

\subsection{Quotients by saturated relations}

In order to construct the quotient operation, it is useful to consider the type of abstract graph extensions and their morphisms.

\begin{defn}\label{defn:seq_sat}
We define the category of graph extensions to consist of objects and morphisms as follows:
\begin{center}
\begin{tabular}{rlcrl}
\toprule
\multicolumn{2}{l}{\emph{Objects}} & & \multicolumn{2}{l}{\emph{Morphisms}} \\
\multicolumn{2}{l}{$(B,h,R,\rho)$} & & \multicolumn{2}{l}{$(i,H,\epsilon,\epsilon_\rho):(B,h,R,\rho)\to(B',h',R',\rho')$} \\
\midrule
$B$ & $:\UU$ & & $i$ & $:B\to B'$\\
$h$ & $:A\to B$ & & $I$ & $:i\circ h\htpy h'$ \\
$R$ & $:A\to B\to\UU$ & & $\epsilon$ & $: \prd{a:A}{b:B}R(a,b)\eqvsym R'(a,i(b))$ \\
$\rho$ & $: \prd{a:A}R(a,h(a))$ & & $\epsilon_\rho$ & $: \prd{a:A} \mathsf{tr}_{R'(a)}(H(a),\epsilon(\rho(a)))=\rho'(a)$ \\
\bottomrule
\end{tabular}
\end{center}
\end{defn}

\begin{eg}
Given a commuting triangle 
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[dr,swap,"f"] \arrow[rr,"h"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with $H:f\htpy g\circ h$, we have the morphism
\begin{equation*}
\begin{tikzcd}[column sep=huge]
(B,h,E_{f,g},H) \arrow[r,"{(i,H,\epsilon,\epsilon_\rho)}"] & (\join[X]{A}{B},\inl,E_{f,\join{f}{g}},\mathsf{left\usc{}comp})
\end{tikzcd}
\end{equation*}
consisting of
\begin{align*}
i & \defeq \inr \\
I & \defeq \lam{a}\glue(H(a)) \\
\epsilon & \defeq \epsilon_{E_{f,g},E_{f,\join{f}{g}}} \\
\epsilon_\rho & \defeq
\end{align*}
\end{eg}

\begin{defn}\label{defn:seq_sat}
Given a saturated graph extension $\mathcal{R}$ of $h:A\to B$, we define a sequence of graph extensions
\begin{equation*}
\begin{tikzcd}
(B_0,h_0,\mathcal{R}_0) \arrow[r] & (B_1,h_1,\mathcal{R}_1) \arrow[r] & (B_2,h_2,\mathcal{R}_2) \arrow[r] & \cdots
\end{tikzcd}
\end{equation*}
such that each $\mathcal{R}_n\jdeq(R_n,\rho_n)$ is a saturated graph extension of $h_n:A\to B_n$. 
\end{defn}

\begin{proof}[Construction]
We take $(B_0,h_0,R_0,\rho_0)\defeq (B,h,R,\rho)$.
For the inductive step, we define 
\begin{align*}
B_{n+1} & \defeq A \sqcup^{\mathcal{R}_n} B_n \\
h_{n+1} & \defeq \inl \\
\mathcal{R}_{n+1} & \defeq \xi(t_n)
\end{align*}
where $t_n$ witnesses that $\mathcal{R}_n$ is saturated. Next, we define a morphism from $(B_n,h_n,R_n,\rho_n)$ to $(B_{n+1},h_{n+1},R_{n+1},\rho_{n+1})$ by
\begin{align*}
i_n & \defeq \inr \\
H_n & \defeq \lam{a}\glue(\rho_n(a)) \\
\epsilon_n & \defeq \epsilon_{\mathcal{R}_n,\mathcal{R}_{n+1}},
\end{align*}
which preserves $\rho_n$ by construction.
\end{proof}

\begin{defn}
Let $\mathcal{R}$ be a saturated graph extension of $h:A\to B$. Then we define
\begin{equation*}
B/\mathcal{R}\defeq \mathsf{colim}_n(B_n)
\end{equation*}
and $q_\mathcal{R}:B\to B/\mathcal{R}$ is given by the cocone structure of $B/\mathcal{R}$.
\end{defn}

\begin{lem}
Let $\mathcal{R}$ be a graph extension of $h:A\to B$. Then the map
\begin{equation*}
\inr : B\to A\sqcup^{\mathcal{R}} B
\end{equation*}
is surjective.
\end{lem}

\begin{proof}
We have to show that 
\begin{equation*}
\prd{t:A\sqcup^{\mathcal{R}} B} \brck{\fib{\inr}{t}}.
\end{equation*}
We do this using the dependent elimination of $A\sqcup^{\mathcal{R}} B$.
Note that since we are eliminating into a family of mere propositions, there is nothing to show for the path constructors.
Moreover, the fibers of $\inr$ at points of the form $\inr(b)$ are clearly inhabited too.
Thus we only need to show that
\begin{equation*}
\prd{a:A}\brck{\fib{\inr}{\inl(a)}}.
\end{equation*}
However, we have $\glue(\rho(a)):\inl(a)=\inr(h(a))$. Thus we have $\fib{\inr}{\inl(a)}\eqvsym \fib{\inr}{\inr(h(a))}$, and the fiber on the right is inhabited for all $a:A$.
\end{proof}

\begin{defn}
We define an operation
\begin{equation*}
\mathcal{Q}_h : \Big(\sm{\mathcal{R}:\mathsf{gphExt}(h)}\mathsf{sat}(\mathcal{R})\Big)\to \sm{Q:\UU}{q:B\to Q}\mathsf{isSurj}(q).
\end{equation*}
by taking $\mathcal{Q}_h(\mathcal{R},\mathcal{H})\defeq\pairr{B/\mathcal{R},q_\mathcal{R},\usc{}}$.
\end{defn}

\begin{proof}[Construction]
We define
\begin{equation*}
B/\mathcal{R}\defeq \mathsf{colim}_n(B_n)
\end{equation*}
and $q_\mathcal{R}:B\to B/\mathcal{R}$ is given by the cocone structure of $B/\mathcal{R}$. Then $q_{\mathcal{R}}$ is surjective since each $i_n:B_n\to B_{n+1}$ is surjective.
\end{proof}

\begin{lem}\label{lem:join_fixed}
For any type $A$ the map
\begin{equation*}
\inl : \brck{A}\to \join{\brck{A}}{A}
\end{equation*}
is an equivalence.
\end{lem}

\begin{proof}
By the universal property of the join we also have a map $\join{\brck{A}}{A}\to \brck{A}$, so it suffices to show that $\join{\brck{A}}{A}$ is a proposition, i.e.~that $\join{\brck{A}}{A}\to\iscontr(\join{\brck{A}}{A})$. It is equivalent to show that
\begin{equation*}
A\to\iscontr(\join{\brck{A}}{A}),
\end{equation*}
which follows at once since $A\to\iscontr \brck{A}$, and joining with a contractible type results in a contractible type.
\end{proof}

\begin{cor}
Consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with $H:f\htpy g\circ h$, in which $h:A\to B$ is assumed to be surjective. Then the top map in the commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
\im(f) \arrow[rr,"\inl"] \arrow[dr,swap,"f^{\ast\infty}"] & & \join[X]{\im(f)}{B} \arrow[dl,"\join{f^{\ast\infty}}{g}"] \\
\phantom{\join[X]{\im(f)}{B}} & X
\end{tikzcd}
\end{equation*}
is an equivalence.
\end{cor}

\begin{proof}
It suffices to show that
\begin{equation*}
\inl:\brck{\fib{f}{x}}\to \join{\brck{\fib{f}{x}}}{\fib{g}{x}}.
\end{equation*}
To see this, we observe that $\brck{\fib{f}{x}}\eqvsym \brck{\fib{g}{x}}$, since we have
\begin{align*}
\brck{\fib{f}{x}} & \eqvsym \brck{\fib{g\circ h}{x}}\phantom{\Brck{~}} \\
& \eqvsym \Brck{\sm{(b,p):\fib{g}{x}}\fib{h}{b}} \\
& \eqvsym \Brck{\sm{(b,p):\fib{g}{x}}\brck{\fib{h}{b}}} \\
& \eqvsym \brck{\fib{g}{x}},\phantom{\Brck{~}}
\end{align*}
so the claim follows from \cref{lem:join_fixed}
\end{proof}

\begin{prp}
Consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with $H:f\htpy g\circ h$, in which $h:A\to B$ is assumed to be surjective. Then the map
\begin{equation*}
B/\mathcal{E}_{f,g} \to X
\end{equation*}
is an embedding. It follows that this embedding satisfies the universal property of the image inclusion of $f$. 
\end{prp}

\begin{proof}
Note that there is a natural equivalence of type sequences
\begin{equation*}
\begin{tikzcd}
B \arrow[d] \arrow[r] & \join[X]{A}{B} \arrow[d] \arrow[r] & \join[X]{A}{(\join[X]{A}{B})} \arrow[d] \arrow[r] & \join[X]{A}{(\join[X]{A}{(\join[X]{A}{B})})} \arrow[r] \arrow[d] & \cdots \\
B \arrow[r] & \join[X]{A}{B} \arrow[r] & \join[X]{(\join[X]{A}{A})}{B} \arrow[r] & \join[X]{(\join[X]{A}{(\join[X]{A}{A})})}{B} \arrow[r] & \cdots
\end{tikzcd}
\end{equation*}
Therefore we obtain commuting triangles
\begin{equation*}
\begin{tikzcd}
B/\mathcal{E}_{f,g} \arrow[r] \arrow[dr] & \join[X]{\im(f)}{B} \arrow[d] & \im(f) \arrow[dl] \arrow[l] \\
& X & \phantom{B/\mathcal{E}_{f,g}}
\end{tikzcd}
\end{equation*}
in which the top maps are equivalences, from which the claim follows.
\end{proof}

\begin{thm}
For any surjective map $h:A\to B$, the lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{gphExt}(h)}\mathsf{sat}(\mathcal{R}) \arrow[d,"\proj 1"] \\
(B\,{\downarrow_s}\,\UU) \arrow[r,swap,"E"] \arrow[ur,densely dotted,"\mathcal{E}"] & \mathsf{gphExt}(h)
\end{tikzcd}
\end{equation*}
is a section of the quotient operation
\begin{equation*}
\mathcal{Q} : \Big(\sm{\mathcal{R}:\mathsf{gphExt}(h)}\mathsf{sat}(\mathcal{R})\Big)\to (B\,{\downarrow_s}\,\UU).
\end{equation*}
\end{thm}

\begin{cor}
The lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{rRel}(A)}\mathsf{sat}(\mathcal{R}) \arrow[d,"\proj 1"] \\
(A\,{\downarrow_s}\,\UU) \arrow[r,swap,"k"] \arrow[ur,densely dotted,"\mathcal{K}"] & \mathsf{rRel}(A)
\end{tikzcd}
\end{equation*}
is a section of the quotient operation
\begin{equation*}
\mathcal{Q} : \Big(\sm{\mathcal{R}:\mathsf{rRel}(A)}\mathsf{sat}(\mathcal{R})\Big)\to (A\,{\downarrow_s}\,\UU).
\end{equation*}
\end{cor}

\subsection{The relational Hopf construction}

\begin{defn}
A \define{right H-structure} on a graph extension $\mathcal{R}$ of $h:A\to B$ consists of quadruples
\begin{align*}
\mu & :\prd{a,x:A}{y:B} R(x,y)\to (\eqv{R(a,h(x))}{R(a,y)}) \\
\mathsf{left\usc{}unit} & : \prd{a:A}{x:A}{r:R(a,h(x))} \mu(\rho(x),r)=r \\
\mathsf{right\usc{}unit} & : \prd{a:A}{y:B}{r:R(a,y)} \mu(r,\rho(a))=r \\
\mathsf{coh\usc{}unit} & : \prd{a:A}\mathsf{left\usc{}unit}(\rho(a))=\mathsf{right\usc{}unit}(\rho(a)).
\end{align*}
We will write $\mathsf{H\hyph Rel}(\mathcal{R})$ for the type of such quadruples, and $\mu$ is called the \define{composition} operation. If $\mathcal{R}$ comes equipped with a right H-structure, we also say that $\mathcal{R}$ is a \define{right H-relation}. An \define{H-relation} is a right H-relation for which $\mu(\blank,r)$ is an equivalence, for each $r:R(a,h(x))$. 
\end{defn}

\begin{eg}
We claim that a $\prop$-valued reflexive relation $\mathcal{R}$ on $A$ possesses a (right) H-structure if and only if it is symmetric and transitive, i.e.~it is an equivalence relation.

If $\mathcal{R}$ is a right H-relation, then we have in particular 
\begin{equation*}
R(x,a)\to (\eqv{R(a,x)}{R(a,a)}),
\end{equation*}
showing that $R(a,x)\leftrightarrow R(x,a)$ for any $x,a:A$. This proves that $\mathcal{R}$ is symmetric. Transitivity of $\mathcal{R}$ is immediate.
Conversely, if $\mathcal{R}$ is symmetric and transitive, then it is straightforward to see that $R(a,x)\leftrightarrow R(a,y)$ for any $p:R(x,y)$. Furthermore, the unit laws hold since $\mathcal{R}$ is $\prop$-valued, so $\mathcal{R}$ is pre-saturated. 

From the above observations it follows that if a reflexive relation $\mathcal{R}$ is a right H-relation, then the relation $x \sim_{\mathcal{R}} y \defeq \brck{R(x,y)}$ is a $\prop$-valued equivalence relation in the usual sense.
\end{eg}

\begin{eg}
Consider a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=tiny]
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& X
\end{tikzcd}
\end{equation*}
with a homotopy $H:f\htpy g\circ h$. Then we can describe direcly the H-relation structure of the pullback relation $E_{f,g}$. The composition operation $\mu$ is given by
\begin{equation*}
\lam{p}{q} \ct{q}{\ct{H(x)^{-1}}{p}} : (f(x)=g(y))\to (\eqv{(f(a)=g(h(x)))}{(f(a)=g(y))}).
\end{equation*}
It is immediate that this operation satisfies the left and right unit laws, with a coherence between them.
\end{eg}

\begin{eg}
A reflexive relation on the unit type is just a pointed type. 
Thus, we can specialize the notion of right H-relation to the case of a type $X$ with base point $1:X$, we obtain the following structure:
\begin{align*}
\mu & : X \to (\eqv{X}{X}) \\
\mathsf{right\usc{}unit} & : \prd{x:X} \mu(x,1)=x \\
\mathsf{left\usc{}unit} & : \prd{x:X} \mu(1,x)=x \\
\mathsf{coh\usc{}unit} & : \mathsf{right\usc{}unit}(1)=\mathsf{left\usc{}unit}(1).
\end{align*}
Thus we see that an H-structure on a pointed type is the structure of a coherent H-space.
\end{eg}

\begin{defn}
Let $\mathcal{R}$ be a graph extension of $h:A\to B$. We will define a map
\begin{equation*}
\mathsf{presat\usc{}hrel}:\mathsf{H\hyph Rel}(\mathcal{R})\to \mathsf{presat}(\mathcal{R}).
\end{equation*}
\end{defn}

\begin{proof}[Construction]
Given the structure of a right H-relation on $\mathcal{R}$ with composition operation $\mu$, we note that the outer square square in the diagram
\begin{equation*}
\begin{tikzcd}
\sm{x:A}{y:B}R(x,y) \arrow[r,"\pi_2"] \arrow[d,swap,"\pi_1"] & B \arrow[ddr,bend left=15,"R(a)"] \arrow[d,"\inr"] \\
A \arrow[r,"\inl"] \arrow[drr,bend right=15,swap,"{R(a,h(\blank))}"] & A\sqcup^{\mathcal{R}} B \arrow[dr,densely dotted,swap,"S(a)" near start] \\
& & \UU
\end{tikzcd}
\end{equation*}
commutes by the homotopy
\begin{equation*}
H\defeq \lam{(x,y,r)}\mathsf{eq\usc{}equiv}(\mu(r)),
\end{equation*}
so we obtain a family $S(a):A\sqcup^{\mathcal{R}} B\to \UU$ by the universal property of pushouts, equipped with homotopies
\begin{align*}
K & : R(a)\circ h \htpy S(a)\circ \inl \\
L & : R(a) \htpy S(a)\circ \inr \\
M & : \ct{(K\cdot \pi_1)}{(S(a)\cdot\glue)}\htpy \ct{H}{(R(a)\cdot\pi)}
\end{align*}
Now we see that $S$ is a graph extension of $\inl$, since we have
\begin{equation*}
\lam{a}\mathsf{equiv\usc{}eq}(K(a))(\rho(a)):\prd{a:A} S(a,\inl(a)).
\end{equation*}
It remains to show that
\begin{equation*}
\epsilon_{\mathcal{R},\mathcal{S}}:\prd{y:B}R(a,b)\to S(a,\inr(b))
\end{equation*}
which is given as
\begin{equation*}
(r:R(a,b))\mapsto \mathsf{tr}_{S(a)}(\glue(r),\mathsf{equiv\usc{}eq}(K(a))(\rho(a))),
\end{equation*}
is a fiberwise equivalence. To see this, it suffices to show that $\epsilon_{\mathcal{R},\mathcal{S}}$ is homotopic to $\mathsf{equi\usc{}eq}(L)$, which is clearly an equivalence. We note that we have a commuting square
\begin{equation*}
\begin{tikzcd}[column sep=6em]
R(a,h(a)) \arrow[r,"\mu(r)"] \arrow[d,swap,"\mathsf{equiv\usc{}eq}(K)(a)"] & R(a,b) \arrow[d,"\mathsf{equiv\usc{}eq}(L)(a)"] \\
S(a,\inl(a)) \arrow[r,swap,"\mathsf{tr}_{S(a)}(\glue(r))"] & S(a,\inr(b))
\end{tikzcd}
\end{equation*}
by the homotopy $M$. Thus we see that
\begin{align*}
\epsilon(r) & = \mathsf{equiv\usc{}eq}(L)(\mu(r,\rho(a))) \\
& = \mathsf{equiv\usc{}eq}(L)(r),
\end{align*}
where the second equality holds by the right unit law for $\mu$. This completes the proof that $\epsilon$ is a fiberwise equivalence.
\end{proof}

In the construction of the map $\mathsf{presat\usc{}hrel}$ we have not used the left unit law or the coherence between the left and right unit laws. However, as we will show below, the map $\mathsf{presat\usc{}hrel}$ is an equivalence when they are included in the definition of right H-relations. In the following theorem we show that the type of right extensions of $\mathcal{R}$ is equivalently described as the right H-relation structure on $\mathcal{R}$.

\begin{thm}\label{thm:hrel}
For any graph extension $\mathcal{R}$ of $h:A\to B$, the map
\begin{equation*}
\mathsf{presat\usc{}hrel}:\mathsf{H\hyph Rel}(\mathcal{R})\to \mathsf{presat}(\mathcal{R})
\end{equation*}
is an equivalence. In particular, the type $\mathsf{presat}(\mathcal{R})$ is essentially small.
\end{thm}

\begin{proof}
By the universal property of pushouts, the type of right extensions of $\mathcal{R}$ is equivalent to the type of
\begin{align*}
P & : A\to A \to \UU \\
Q & : A \to B \to \UU \\
\mu & : \prd{a:A}{x:A}{y:B} R(x,y)\to (P(a,x)\eqvsym Q(a,y)) \\
1 & : \prd{a:A} P(a,a)
\end{align*}
such that the map
\begin{equation*}
\epsilon : \prd{a:A}{b:B} R(a,b)\to Q(a,b)
\end{equation*}
given by $r\mapsto \mu(r,1_a)$ is a fiberwise equivalence. By \autoref{lem:coh_red} this type is equivalent to the type of
\begin{align*}
P & : A\to A \to \UU \\
\mu & : \prd{a:A}{x:A}{y:B} R(x,y)\to (P(a,x)\eqvsym R(a,y)) \\
1 & : \prd{a:A} P(a,a) \\
\mathsf{right\usc{}unit} & : \prd{a:A}{b:B}{r:R(a,b)} \mu(r,1_a)=r.
\end{align*}
Since we have $\mu(\rho(x)) : P(a,x) \eqvsym R(a,h(x))$ for any $a,x:A$, we see that by a second application of \autoref{lem:coh_red}, the type of right extensions of $\mathcal{R}$ is equivalent to the type
\begin{align*}
\mu & : \prd{a:A}{x:A}{y:B} R(x,y)\to (R(a,h(x))\eqvsym R(a,y)) \\
1 & : \prd{a:A} R(a,h(a)) \\
\mathsf{right\usc{}unit} & : \prd{a:A}{b:B}{r:R(a,b)} \mu(r,1_a)=r \\
\mathsf{left\usc{}unit} & : \prd{a,x:A}{r:R(a,h(x))} \mu(\rho(x),r)=r.
\end{align*}
Finally, we observe that $\ct{\beta_r(\rho(a))^{-1}}{\beta_l(1_a)}:\rho(a)=1_a$. Thus, by a last application of \autoref{lem:coh_red} we see that the type of right extensions of $\mathcal{R}$ is equivalent to the type
\begin{align*}
\mu & : \prd{a:A}{x:A}{y:B} R(x,y)\to (R(a,h(x))\eqvsym R(a,y)) \\
\mathsf{right\usc{}unit} & : \prd{a:A}{b:B}{r:R(a,b)} \mu(r,\rho(a))=r \\
\mathsf{left\usc{}unit} & : \prd{a,x:A}{r:R(a,h(x))} \mu(\rho(x),r)=r \\
\mathsf{coh\usc{}unit} & : \prd{a:A} \mathsf{left\usc{}unit}(\rho(a))=\mathsf{right\usc{}unit}(\rho(a)).\qedhere
\end{align*}
\end{proof}

We call the construction in the following theorem the \define{relational Hopf construction}. Note that we add the extra assumption of associativity, which automatically holds for $2$-pre-saturated graph extensions (\autoref{lem:2presat_coh})

\begin{thm}\label{thm:Hopf}
For any H-relation structure $\mu$ on a graph extension $\mathcal{R}$ of $h:A\to B$ there is an equivalence
\begin{equation*}
\eqv{\Big(\sm{t:A\sqcup^{\mathcal{R}} B}S(a,t)\Big)}{\join{\Big(\sm{x:A}R(a,h(x))\Big)}{\Big(\sm{b:B}R(a,b)\Big)}},
\end{equation*}
where $\mathcal{S}$ is the right extension $\mathcal{S}$ of $\mathcal{R}$ determined by $\mu$.
\end{thm}

\begin{proof}
By the descent property for pushouts, pulling back the pushout square
\begin{equation*}
\begin{tikzcd}
\sm{x:A}{y:B}R(x,y) \arrow[r] \arrow[d] & B \arrow[d] \\
A \arrow[r] & A\sqcup^{\mathcal{R}} B
\end{tikzcd}
\end{equation*}
along the projection map $\pi_1 : \sm{t:A\sqcup^{\mathcal{R}} B} S(a,t)$, we obtain a pushout square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\sm{x:A}{y:B}R(x,y)\times R(a,h(x)) \arrow[d,swap,"\pi_{1,4}"] \arrow[r,"\lam{x,y,s,r}\pairr{y,\mu(s,r)}" yshift=1ex] & \sm{y:B}R(a,y) \arrow[d] \\
\sm{x:A}R(a,h(x)) \arrow[r] & \sm{t:A\sqcup^{\mathcal{R}}B} S(a,t)
\end{tikzcd}
\end{equation*}
Since $\mu(\blank,r):R(x,y)\to R(a,y)$ is an equivalence for each $r:R(a,h(x))$ it follows that
\begin{equation*}
\begin{tikzcd}
\Big(\sm{x:A}R(a,h(x))\Big)\times\Big(\sm{y:B}R(a,y)\Big)  \arrow[d,swap,"\pi_1"] \arrow[r,"\pi_2"] & \sm{y:B}R(a,y) \arrow[d] \\
\sm{x:A}R(a,h(x)) \arrow[r] & \sm{t:A\sqcup^{\mathcal{R}}B} S(a,t)
\end{tikzcd}
\end{equation*}
is a pushout square. Thus we obtain that $\sm{t:A\sqcup^{\mathcal{R}}B} S(a,t)$ is the join of $\sm{x:A}R(a,h(x))$ and $\sm{y:B}R(a,y)$
\end{proof}

\begin{cor}
If $\mathcal{R}$ is an associative right H-relation, in the sense that
\begin{equation*}
\mu(r,\mu(q,p))=\mu(\mu(p,q),r)
\end{equation*}
for any $r:R(y,z)$, $q:R(x,h(y))$, and $p:R(a,h(x))$, then $\mu(\blank,p)$ is an equivalence, so we have
\begin{equation*}
\eqv{\Big(\sm{t:A\sqcup^{\mathcal{R}} B}S(a,t)\Big)}{\join{\Big(\sm{x:A}R(a,h(x))\Big)}{\Big(\sm{b:B}R(a,b)\Big)}}.
\end{equation*}
for the right extension $\mathcal{S}$ of $\mathcal{R}$ determined by $\mu$.
\end{cor}

\begin{proof}
We first show that every $p:R(a,h(x))$ is bi-invertible. Note that for every $p:R(a,h(x))$ we have the equivalence $\mu(p):R(x,h(a))\eqvsym R(x,h(x))$, and hence there is a unique right inverse $p^{-1}$ satisfying $\mu(p,p^{-1})=\rho(x)$. Now we calculate
\begin{align*}
\mu(\mu(p^{-1},p),\rho(a)) & = \mu(p^{-1},p) \\
& = \mu(p^{-1},\mu(\rho(x),p)) \\
& = \mu(p^{-1},\mu(\mu(p,p^{-1}),p)) \\
& = \mu(\mu(p^{-1},p),\mu(p^{-1},p)).
\end{align*}
In other words, multiplying $\mu(p^{-1},p)$ on the right by $\rho(a)$ gives the same result as multiplying by $\mu(p^{-1},p)$ on the right by $\mu(p^{-1},p)$. Since $\mu(\mu(p^{-1},p),\blank)$ is an equivalence (and in particular an embedding), it follows that $\mu(p^{-1},p)=\rho(a)$. Thus, we have established that every $p:R(a,h(x))$ is (bi-)invertible. 

Now we can show that $\mu(\blank,p)$ is an equivalence. Observe that $\mu(\blank,p^{-1})$ is the inverse of $\mu(\blank,p)$, since
\begin{align*}
\mu(\mu(\blank,p),p^{-1}) & \htpy \mu(\blank,\mu(p,p^{-1})) & \mu(\mu(\blank,p^{-1}),p) & \htpy \mu(\blank,\mu(p^{-1},p)) \\
& \htpy \mu(\blank,\rho(x)) & & \htpy \mu(\blank,\rho(a)) \\
& \htpy \idfunc & & \htpy \idfunc \qedhere
\end{align*}
\end{proof}

\subsection{The coherence laws for $2$-saturated graph extensions}

In the following theorem we establish that a $2$-saturated graph extension $\mathcal{R}$ of $h:A\to B$ is an associative right H-relation $\mathcal{R}$ satisfying further coherence laws that correspond to the cases where the associator (which has three edges as arguments) is applied to $\rho$. Thus the coherence laws organize themselves as follows:
\begin{enumerate}
\item the associator $\alpha_{111}$ itself,
\item three coherence laws $\alpha_{011}$, $\alpha_{101}$, and $\alpha_{110}$, corresponding to the cases where we take one of the three arguments to be $\rho$,
\item three coherence laws $\alpha_{001}$, $\alpha_{010}$, and $\alpha_{100}$, corresponding to the cases where we take two of the three arguments to be $\rho$,
\item a coherence law $\alpha_{000}$ where we take all three arguments to be $\rho$.
\end{enumerate}
The interdependencies among these coherence laws can be displayed concisely in a cube:
\begin{equation*}
\begin{tikzcd}
& \alpha_{000} \arrow[dl,-] \arrow[d,-] \arrow[dr,-] \\
\alpha_{001} \arrow[d,-] & \alpha_{010} \arrow[dl,-] \arrow[dr,-] & \alpha_{100} \arrow[d,-] \\
\alpha_{011} \arrow[dr,-] & \alpha_{101} \arrow[d,-] \arrow[from=ul,crossing over,-] \arrow[from=ur,crossing over,-] & \alpha_{110} \arrow[dl,-] \\
& \alpha_{111}
\end{tikzcd}
\end{equation*}
Following this scheme, we will also write
\begin{align*}
\mu_{01} & \defeq \mathsf{left\usc{}unit} \\
\mu_{10} & \defeq \mathsf{right\usc{}unit} \\
\mu_{00} & \defeq \mathsf{coh\usc{}unit}
\end{align*}
for the coherences of \autoref{thm:hrel}.

\begin{defn}
For any endomorphism $f:X\to X$ with $H:f\htpy \idfunc$, one has
\begin{equation*}
\mathsf{htpy\usc{}endo}(f,H,x):H(f(x))=\mathsf{ap}_f(H(x))
\end{equation*}
for any $x:X$.
\end{defn}

One can readily construct this identification by induction on $H$ (thus, using function extensionality). However, one can also make this construction without function extensionality, as follows:

\begin{proof}[Construction]
First, recall that homotopies are automatically natural with respect to identifications: given any homotopy $H:f\htpy g$ between $f,g:A\to B$, and $p:x=y$ in $A$, the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
f(x) \arrow[r,equals,"H(x)"] \arrow[d,equals,swap,"\mathsf{ap}_{f}(p)",""{name=A,right}] & g(x) \arrow[d,equals,"\ap{g}{p}",""{name=B,left}] \arrow[draw=none,from=A,to=B,"{\mathsf{htpy\usc{}nat}(H,p)}" description] \\
f(y) \arrow[r,equals,swap,"H(y)"] & g(y)
\end{tikzcd}
\end{equation*}
commutes (by path induction). 

Thus, in the situation at hand it follows by the naturality of homotopies that the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
ff(x) \arrow[d,swap,equals,"\mathsf{ap}_{f}(H(x))"] \arrow[r,equals,"H(f(x))"] & f(x) \arrow[d,equals,"H(x)"] \\
f(x) \arrow[r,swap,equals,"H(x)"] & x
\end{tikzcd}
\end{equation*}
commutes. By cancelling $H(x)$ on the right, this gives the desired identification $H(f(x))=\ap{f}{H(x)}$.
\end{proof}

\begin{rmk}
For functions taking more than one argument, or for functions written in infix notation, we write the action on paths of a function as $f(p)_{\mathsf{ap}}$. For example, we write $\mu((p)_{\mathsf{ap}},r)$ for $\mathsf{ap}_{\mu(\blank,r)}(p)$, and $\ct{(s)_{\mathsf{ap}}}{q}$ for the `whiskering' operation on $s:p=p'$ and $q:y=z$. 
\end{rmk}

\begin{defn}
Let $\mathcal{R}$ be a graph extension of $h:A\to B$. equipped with the structure $(\mu,\mu_{01},\mu_{10},\mu_{00})$ of an H-relation. A \define{coherent associator} on $\mathcal{R}$ consists of:
\begin{enumerate}
\item an \define{associator}
\begin{equation*}
\alpha_{111}(t,s,r) : \mu(t,\mu(s,r))=\mu(\mu(t,s),r)
\end{equation*}
for every $t:R(y,z)$, $s:R(x,h(y))$, and $r:R(a,h(x))$ (of which we will usually suppress the subscript $111$),
\item Coherence laws for the associator:
\begin{equation*}
\begin{tikzcd}
\mu(\rho_y,\mu(s,r)) \arrow[rr,equals,"{\alpha(\rho_y,s,r)}",""{name=A,below}] \arrow[dr,equals,swap,"{\mu_{01}(\mu(s,r))}"] & & \mu(\mu(\rho_y,s),r) \arrow[dl,equals,"{\mu((\mu_{01}(s))_{\mathsf{ap}},r)}"] \\
\phantom{\mu(\mu(\rho_y,s),r)} & \mu(s,r) \arrow[to=A,draw=none,"{\alpha_{011}(s,r)}" description] & \phantom{\mu(\rho_y,\mu(s,r))}
\end{tikzcd}
\end{equation*}
\begin{equation*}
\begin{tikzcd}
\mu(t,\mu(\rho_x,r)) \arrow[rr,equals,"{\alpha(t,\rho_x,r)}",""{name=A,below}] \arrow[dr,equals,swap,"{\mu(t,(\mu_{01}(r))_{\mathsf{ap}})}"] & & \mu(\mu(t,\rho_x),r) \arrow[dl,equals,"{\mu((\mu_{10}(t))_{\mathsf{ap}},r)}"] \\
& \mu(t,r) \arrow[to=A,draw=none,"{\alpha_{101}(t,r)}" description]
\end{tikzcd}
\end{equation*}
\begin{equation*}
\begin{tikzcd}
\mu(t,\mu(s,\rho_a)) \arrow[rr,equals,"{\alpha(t,s,\rho_a)}",""{name=A,below}] \arrow[dr,equals,swap,"{\mu(t,(\mu_{10}(s))_{\mathsf{ap}})}"] & & \mu(\mu(t,s),\rho_a) \arrow[dl,equals,"{\mu_{10}(\mu(t,s))}"] \\
& \mu(t,s) \arrow[to=A,draw=none,"{\alpha_{110}(t,s)}" description]
\end{tikzcd}
\end{equation*}
\item Coherence laws
\begin{equation*}
\begin{tikzcd}
\mu_{01}(\mu(\rho_x,r)) \arrow[r,equals,"{\alpha_{011}(\rho_x,r)}" yshift=1ex] \arrow[d,equals,"\mathsf{htpy\usc{}endo}_{\mu_{01}}(r)"{left},""{name=A,right}] & \ct{\alpha(\rho_x,\rho_x,r)}{\mu((\mu_{01}(\rho_x))_{\mathsf{ap}},r)} \arrow[d,equals,"{\ct{\alpha(\rho_x,\rho_x,r)}{\mu(((\mu_{00}(x))_{\mathsf{ap}})_{\mathsf{ap}},r)}}",""{name=B,left}] \arrow[from=A,to=B,draw=none,"\alpha_{001}(r)" description] \\
\mu({\rho_x},(\mu_{01}(r))_{\mathsf{ap}}) \arrow[r,equals,swap,"{\alpha_{101}(\rho_x,r)}" yshift=-1ex] & \ct{\alpha(\rho_x,\rho_x,r)}{\mu((\mu_{10}(\rho_x))_{\mathsf{ap}},r)}
\end{tikzcd}
\end{equation*}
\begin{equation*}
\begin{tikzcd}
\mu(t,(\mu_{01}(\rho_a))_{\mathsf{ap}}) \arrow[r,equals,"{\alpha_{101}(t,\rho_a)}" yshift=1ex] \arrow[d,equals,swap,"{\mu(t,((\mu_{00}(a))_{\mathsf{ap}})_{\mathsf{ap}})}",""{name=A,right}] & \ct{\alpha(t,\rho_a,\rho_a)}{\mu((\mu_{10}(t))_{\mathsf{ap}},\rho_a)} \arrow[d,equals,"\ct{\alpha(t,\rho_a,\rho_a)}{(\mathsf{htpy\underline~endo}(\mu_{10},t)^{-1})_{\mathsf{ap}}}",""{name=B,left}] \arrow[from=A,to=B,draw=none,"\alpha_{100}(t)" description] \\
\mu(t,(\mu_{10}(\rho_a))_{\mathsf{ap}}) \arrow[r,equals,swap,"{\alpha_{110}(t,\rho_a)}" yshift=-1ex] & \ct{\alpha(t,\rho_a,\rho_a)}{\mu_{10}(\mu(t,\rho_a))}
\end{tikzcd}
\end{equation*}
\begin{equation*}
\begin{tikzcd}
\ct{\mu(\rho_a,(\mu_{10}(s))_{\mathsf{ap}})}{\mu_{01}(s)} \arrow[r,equals,"{\ct{(\alpha_{110}(\rho_x,s))_{\mathsf{ap}}}{\mu_{01(s)}}}" yshift=1ex] \arrow[d,equals,swap,"{\mathsf{htpy\usc{}nat}(\mu_{01},\mu_{10}(s))^{-1}}",""{name=A,right}] & \ct{\alpha(\rho_x,s,\rho_a)}{\mu_{10}(\mu(\rho_x,s))}{\mu_{01}(s)} \arrow[d,equals,"{\ct{\alpha(\rho_x,s,\rho_a)}{(\mathsf{htpy\underline~nat}(\mu_{10},\mu_{01}(s)))_{\mathsf{ap}}}}",""{name=B,left}] \arrow[from=A,to=B,draw=none,"\alpha_{010}(s)" description] \\
\ct{\mu_{01}(\mu(s,\rho_a))}{\mu_{10}(s)} \arrow[r,equals,swap,"\ct{(\alpha_{011}(s,\rho_a))_{\mathsf{ap}}}{\mu_{10}(s)}" yshift=-1ex] & \ct{\alpha(\rho_x,s,\rho_a)}{\mu((\mu_{01}(s))_{\mathsf{ap}},\rho_a)}{\mu_{10}(s)}
\end{tikzcd}
\end{equation*}
\item A coherence law\marginnote{write down type of $\alpha_{000}$} 
\begin{equation*}
\alpha_{000}(a):
\end{equation*}
witnessing that the prism 
\begin{equation*}
\begin{tikzcd}[column sep=-2em]
\mu_{01}(\mu(\rho_a,\rho_a)) \arrow[rrr,equals] \arrow[dd,equals] \arrow[dr,equals] & & & \ct{\alpha(\rho_a,\rho_a,\rho_a)}{\mu((\mu_{01}(\rho_a))_{\mathsf{ap}},\rho_a)} \arrow[dr,equals] \arrow[dd,equals] \\
& \mu(\rho_a,(\mu_{01}(\rho_a))_{\mathsf{ap}}) \arrow[dl,equals] & & & \ct{\alpha(\rho_a,\rho_a,\rho_a)}{\mu((\mu_{10}(\rho_a))_{\mathsf{ap}},\rho_a)} \arrow[dl,equals] \arrow[from=lll,crossing over,equals] \\
\mu(\rho_a,(\mu_{10}(\rho_a))_{\mathsf{ap}}) \arrow[rrr,equals] & & & \ct{\alpha(\rho_a,\rho_a,\rho_a)}{\mu_{10}(\mu(\rho_a,\rho_a))}
\end{tikzcd}
\end{equation*}
commutes.
\end{enumerate}
We write $\mathsf{assoc}(\mathcal{R},\mu)$ for the type of coherent associators on $\mathcal{R}$.
\end{defn}

\begin{rmk}
The definition of coherent associators suggests that \define{coherently associative H-space} is a coherent H-space with a coherent associator.
\end{rmk}

\begin{prp}
\label{lem:2presat_coh}
Suppose $\mathcal{R}$ is a $1$-saturated graph extension of $h:A\to B$, with right extension $\mathcal{S}$.
Then there is an equivalence
\begin{equation*}
\eqv{\mathsf{presat}(\mathcal{S})}{\mathsf{assoc}(\mathcal{R},\mu)}.
\end{equation*}
\end{prp}

\begin{proof}
Suppose $\mathcal{R}$ is a graph extension of $h$, with a right extension $\mathcal{S}$ corresponding to the right H-relation structure $\pairr{\mu,\mu_{01},\mu_{10},\mu_{00}}$ on $\mathcal{R}$. Then by \autoref{thm:hrel}, the type $\mathsf{presat}(\mathcal{S})$ is equivalent to the type of
\begin{align*}
\alpha_{\ast\ast 1} & : \prd{a:A}{x:A}{w:A\sqcup^{\mathcal{R}}B} S(x,w)\to (R(a,h(x)) \eqvsym S(a,w)) \\
\alpha_{001} & : \prd{a:A}{x:A}{r:R(a,h(x))} \alpha_{\ast\ast 1}(\sigma_x,r)=r \\
\alpha_{\ast\ast 0} & : \prd{a:A}{w:A\sqcup^{\mathcal{R}} B}{s:S(a,w)} \alpha_{\ast\ast 1}(s,\rho_a)=s \\
\alpha_{000} & : \prd{a:A} \alpha_{001}(\rho_a)=\alpha_{\ast\ast 0}(\sigma_a)
\end{align*}
We first establish that the type of pairs $\pairr{\alpha_{\ast\ast 1},\alpha_{001}}$ as displayed here is equivalent to the type of quadruples $\pairr{\alpha,\alpha_{011},\alpha_{101},\alpha_{001}}$ as in the statement of the theorem.

By the universal property of pushouts, the type of pairs $\pairr{\alpha_{\ast\ast 1},\alpha_{001}}$ is equivalent to the data type consisting of
\begin{align*}
\alpha_{011} & : \prd{a:A}{x:A}{y:A} R(x,h(y))\to (R(a,h(x)) \eqvsym R(a,h(y))) \\
\alpha_{101} & : \prd{a:A}{x:A}{z:B} R(x,z)\to (R(a,h(x)) \eqvsym R(a,z)) \\
\alpha & : \prd{a,x,y:A}{z:B}{t:R(y,z)}{s:R(x,h(y))}{r:R(a,h(x))} \mu(t,\alpha_{011}(s,r)) = \alpha_{101}(\mu(t,s),r) \\
\alpha_{001} & : \prd{a:A}{x:A}{r:R(a,h(x))} \alpha_{011}(\rho_x,r)=r
\end{align*}
From this data we have the concatenation of paths
\begin{equation*}
\begin{tikzcd}[column sep=large]
\mu(t,r) \arrow[r,equals,"{(\mu(t,(\alpha_{001}(r))_{\mathsf{ap}}))^{-1}}" yshift=1ex]
& \mu(t,\alpha_{011}(\rho_x,r)) \arrow[r,equals,"{\alpha(t,\rho_x,r)}" yshift=1ex]
& \alpha_{101}(\mu(t,\rho_x),r) \arrow[r,equals,"{\alpha_{101}((\mu_{01}(r))_{\mathsf{ap}},r)}" yshift=1ex]
& \alpha_{101}(t,r),
\end{tikzcd}
\end{equation*}
showing that $\mu\htpy \alpha_{101}$. Thus, we can use \autoref{lem:coh_red} to obtain the equivalent data type
\begin{align*}
\alpha_{011} & : \prd{a:A}{x:A}{y:A} R(x,h(y))\to (R(a,h(x)) \eqvsym R(a,h(y))) \\
\alpha & : \prd{a,x,y:A}{z:B}{t:R(y,z)}{s:R(x,h(y))}{r:R(a,h(x))} \mu(t,\alpha_{011}(s,r)) = \mu(\mu(t,s),r) \\
\alpha_{001} & : \prd{a:A}{x:A}{r:R(a,h(x))} \alpha_{011}(\rho_x,r)=r \\
\alpha_{101} & : \prd{a,x:A}{z:B}{t:R(x,z)}{r:R(a,h(x))} \mu(t,(\alpha_{001}(r))_{\mathsf{ap}})=\ct{\alpha(t,\rho_x,r)}{\mu((\mu_{01}(t))_{\mathsf{ap}},r)}.
\end{align*}
From this data we obtain the concatenation of paths
\begin{equation*}
\begin{tikzcd}[column sep=large]
\alpha_{011}(s,r) \arrow[r,equals,"{(\mu_{01}(\alpha_{011}(s,r)))^{-1}}" yshift=1ex] & 
\mu(\rho_y,\alpha_{011}(s,r)) \arrow[r,equals,"{\alpha(\rho_y,s,r)}" yshift=1ex] & 
\mu(\mu(\rho_y,s),r) \arrow[r,equals,"{\mu((\mu_{01}(s))_{\mathsf{ap}},r)}" yshift=1ex] & 
\mu(s,r)
\end{tikzcd}
\end{equation*}
showing that $\alpha_{011}\htpy \mu$ (where $\mu$ is restricted appropriately). Thus, we can use \autoref{lem:coh_red} to obtain the equivalent data type
\begin{align*}
\alpha & : \prd{a,x,y:A}{z:B}{t:R(y,z)}{s:R(x,h(y))}{r:R(a,h(x))} \mu(t,\mu(s,r)) = \mu(\mu(t,s),r) \\
\alpha_{011} & : \prd{a,x,y:A}{s:R(x,h(y))}{r:R(a,h(x))} \mu_{01}(\mu(s,r))=\ct{\alpha(\rho_y,s,r)}{\mu((\mu_{01}(s))_{\mathsf{ap}},r)} \\
\alpha_{001} & : \prd{a:A}{x:A}{r:R(a,h(x))} \mu(\rho_x,r)=r \\
\alpha_{101} & : \prd{a,x:A}{z:B}{t:R(x,z)}{r:R(a,h(x))} \mu(t,(\alpha_{001}(r))_{\mathsf{ap}})=\ct{\alpha(t,\rho_x,r)}{\mu((\mu_{01}(t))_{\mathsf{ap}},r)}
\end{align*}
To see that we can identify $\alpha_{001}$ with $\mu_{01}$ from this data, note that since $\mu(\rho_x,\blank)$ is homotopic to the identity function, it is in particular an embedding. Therefore it suffices to show that
\begin{equation*}
\mu(\rho_x,(\alpha_{001}(r))_{\mathsf{ap}})= \mu(\rho_x,(\mu_{01}(r))_{\mathsf{ap}}).
\end{equation*}
To this end, we do a calculation:
\begin{align*}
\mu(\rho_x,(\alpha_{001}(r))_{\mathsf{ap}})
& = \ct{\alpha(\rho_x,\rho_x,r)}{\mu((\mu_{01}(\rho_x))_{\mathsf{ap}},r)} \\
& = \ct{\alpha(\rho_x,\rho_x,r)}{\mu((\mu_{10}(\rho_x))_{\mathsf{ap}},r)} \\
& = \mu_{01}(\mu(\rho_x,r)) \\
& = \mu(\rho_x,(\mu_{01}(r))_{\mathsf{ap}}).
\end{align*}
Now we can apply \autoref{lem:coh_red} once more to obtain the equivalent type
\begin{align*}
\alpha & : \prd{a,x,y:A}{z:B}{t:R(y,z)}{s:R(x,h(y))}{r:R(a,h(x))} \mu(t,\mu(s,r)) = \mu(\mu(t,s),r) \\
\alpha_{011} & : \prd{a,x,y:A}{s:R(x,h(y))}{r:R(a,h(x))} \mu_{01}(\mu(s,r))=\ct{\alpha(\rho_y,s,r)}{\mu((\mu_{01}(s))_{\mathsf{ap}},r)} \\
\alpha_{101} & : \prd{a,x:A}{z:B}{t:R(x,z)}{r:R(a,h(x))} \mu(t,(\mu_{01}(r))_{\mathsf{ap}})=\ct{\alpha(t,\rho_x,r)}{\mu((\mu_{01}(t))_{\mathsf{ap}},r)} \\
\alpha_{001} & : \prd{a:A}{x:A}{r:R(a,h(x))} \ct{\alpha_{011}(\rho_x,r)}{\ct{\alpha(\rho_x,\rho_x,r)}{\mu(((\mu_{00}(x))_{\mathsf{ap}})_{\mathsf{ap}},r)}}=\ct{\mathsf{htpy\usc{}endo}_{\mu_{01}}(r)}{\alpha_{101}(\rho_x,r)}
\end{align*}
This completes our first goal. Note that under the above transformations, the types of $\alpha_{\ast\ast 0}$ and $\alpha_{000}$ of the beginning of the proof, are now as follows:
\begin{align*}
\alpha_{\ast\ast 0} & : \prd{a:A}{w:A\sqcup^{\mathcal{R}} B}{s:S(a,w)} [\mu,\mu,\alpha](s,\rho_a)=s \\
\alpha_{000} & : \prd{a:A} \mu_{01}(\rho_a)=\alpha_{\ast\ast 0}(\sigma_a)
\end{align*}
\marginnote{Proof unfinished}
\end{proof}

Thus, if a reflexive relation $R$ is pre-groupoidal, then its $0$-truncation $x,y\mapsto\trunc{0}{R(x,y)}$ defines a pre-groupoid structure on the type $A$, as defined in \cite{AhrensKapulkinShulman}. 

The groupoidal laws formulated in the following definition are exactly the usual groupoid laws if one instantiates $h\jdeq \idfunc[A]$. 

\begin{defn}
Let $\mathcal{R}$ be a graph extension of $h:A\to B$. A \define{groupoidal structure} on $\mathcal{R}$ consists of
\begin{align*}
\sigma & : \prd{a,a':A} R(a,h(a'))\to R(a',h(a)) \\
\tau & : \prd{a,a':A}{b:B} R(a,h(a'))\to R(a',b)\to R(a,b)
\end{align*}
satisfying the following groupoidal laws:
\begin{align*}
\tau(p,\tau(q,r)) & =\tau(\tau(p,q),r) \tag{associativity}\\
\tau(\rho(a),q) & =q \tag{left unit law}\\
\tau(p,\rho(a')) & =p \tag{right unit law}\\
\tau(\sigma(q),q) & =q \tag{left inverse law}\\
\tau(p,\sigma(p)) & =p \tag{right inverse law}
\end{align*}
\end{defn}

\begin{prp}
Let $\mathcal{R}$ be reflexive relation, considered as a graph extension of $\idfunc[A]:A\to A$. If $\mathcal{R}$ is $2$-saturated, then $\mathcal{R}$ can be given a pre-groupoidal structure, and therefore the relation $x,y\mapsto \trunc{0}{R(x,y)}$ can be given the structure of a pre-groupoid on $A$, in the sense of \cite{AhrensKapulkinShulman}.
\end{prp}

\subsection{Effectiveness of saturated graph extensions}

\begin{comment}
Since we are working with general graph extensions of a function $h:A\to B$, we will generalize \autoref{defn:system}, and our goal in this section is to solve it.

\begin{prob}\label{prob:gphext}
For a surjective function $h:A\to B$,
\begin{enumerate}
\item to construct a lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{gphExt}(h)}\mathsf{sat}(\mathcal{R}) \arrow[d,->>] \\
(B{\downarrow_s}\UU) \arrow[r,"E"] \arrow[ur,densely dotted,"\mathcal{E}"] & \mathsf{gphExt}(h)
\end{tikzcd}
\end{equation*}
\item such that $\mathcal{E}$ is an equivalence.
\end{enumerate}
\end{prob}

Note that a solution of \autoref{prob:gphext} implies a solution of \autoref{defn:system} by restricting to the (surjective) function $\idfunc:A\to A$, since graph extensions of the identity map on $A$ are just reflexive graphs on $A$.

By \autoref{thm:pb_sat} we already know that for any $g:B\to X$ the pullback relation $E_{gh,g}$ is saturated. Therefore it remains to show that $\mathcal{E}$ is an equivalence.

\begin{lem}
Let $(A,B)$ and $(A',B')$ be two containers, and consider a (pullback) square
\begin{equation*}
\begin{tikzcd}
\sm{a:A}B(a) \arrow[d,->>] \arrow[r,"g"] & \sm{a':A'}B'(a') \arrow[d,->>] \\
A \arrow[r,swap,"f"] & A'
\end{tikzcd}
\end{equation*}
Then the induced map $M(A,B)\to M(A',B')$ is an embedding if and only if $f:A\to A'$ is an embedding. 
\end{lem}

\begin{proof}
This is intuitively true because it works on the defining type sequences, and limits of natural embeddings are embeddings. [TODO]
\end{proof}

The type of sequences of abstract graph extensions can be presented as the coinductive type
\begin{equation*}
\mathsf{seq}(B,h,\mathcal{R})\to\sm{(B',h',\mathcal{S}):\mathsf{gphExt}}{(i,H,\epsilon):(B,h,\mathcal{R})\to(B',h',\mathcal{S})}\mathsf{seq}(B',h',\mathcal{S}).
\end{equation*}
We use the following lemma to conclude that the map
\begin{equation*}
\mathsf{sat}(\mathcal{R})\to\mathsf{seq}(B,h,\mathcal{R})
\end{equation*}
is an embedding.

\begin{lem}
The map
\begin{equation*}
\varphi:\mathsf{presat}(\mathcal{R})\to \sm{(B',h',\mathcal{S}):\mathsf{gphExt}}(B,h,\mathcal{R})\to(B',h',\mathcal{S})
\end{equation*}
given by
\begin{equation*}
\cdots
\end{equation*}
is an embedding.
\end{lem}

\begin{proof}
Let $(i,H,\alpha):(B,h,\mathcal{R})\to(B',h',\mathcal{R}')$, and suppose that the fiber of $\varphi$ at $(B',h',\mathcal{R}',i,H,\alpha)$ is merely inhabited. 
\end{proof}

\begin{cor}
The map
\begin{equation*}
\mathsf{sat}(\mathcal{R})\to\mathsf{seq}(B,h,\mathcal{R})
\end{equation*}
defined in \autoref{defn:seq_sat} is an embedding.
\end{cor}
\end{comment}

\begin{prp}
Let $h:A\to B$ be a function, and let $\mathcal{R}$ be a saturated graph extension of $h$, with quotient
\begin{equation*}
q_{\mathcal{R}}:B\to B/\mathcal{R}.
\end{equation*}
Then the total space
\begin{equation*}
\sm{y:B/\mathcal{R}}R_\infty(a,y)
\end{equation*}
is contractible for any $a:A$.
\end{prp}

\begin{proof}
First we note that the graph extension $\mathcal{R}_n$ of $h_n:A\to B_n$ is saturated for each $n:\N$. In particular, they are $2$-separated, which implies that they can be given the structure of an (associative) H-relation. By the relational Hopf construction, it follows that 
\begin{equation*}
\Big(\sm{y:B_{n}}R_{n}(a,y)\Big)\eqvsym \join{\Big(\sm{x:A}R(a,h(x))\Big)^{\ast n}}{\Big(\sm{b:B}R(a,b)\Big)}
\end{equation*}
Now it follows that 
\begin{align*}
\Big(\sm{y:B_{\infty}}R_{\infty}(a,y)\Big) & \eqvsym \join{\Big(\sm{x:A}R(a,h(x))\Big)^{\ast \infty}}{\Big(\sm{b:B}R(a,b)\Big)} \\
& \eqvsym \join{\unit}{\Big(\sm{b:B}R(a,b)\Big)} \\
& \eqvsym \unit.\qedhere
\end{align*}
\end{proof}

\begin{cor}
Let $h:A\to B$ be a function, and let $\mathcal{R}$ be a saturated graph extension of $h$, with quotient
\begin{equation*}
q_{\mathcal{R}}:B\to B/\mathcal{R}.
\end{equation*}
Then the square
\begin{equation*}
\begin{tikzcd}
\sm{y:B}R(a,y) \arrow[r] \arrow[d,swap,"\proj 1"] & \unit \arrow[d,"\mathsf{const}_{h(a)}"] \\
B \arrow[r,swap,"q_{\mathcal{R}}"] & B/\mathcal{R}
\end{tikzcd}
\end{equation*}
is a pullback square, for any $a:A$. In particular, we obtain a fiberwise equivalence
\begin{equation*}
\varphi_{a} : \prd{y:B} R(a,y) \eqvsym q_{\mathcal{R}}(h(a))=q_{\mathcal{R}}(y)
\end{equation*}
equipped with an identification $\alpha_a:\varphi_a(\rho(a))=\refl{q_{\mathcal{R}}(h(a))}$.
\end{cor}

\begin{prp}
Let $h:A\to B$ be a function, and let $\mathcal{R}$ be a saturated graph extension of $h$, with quotient
\begin{equation*}
q_{\mathcal{R}}:B\to B/\mathcal{R}.
\end{equation*}
Then the right extension $\mathcal{S}$ of $\mathcal{R}$ is $E_{q\circ h,\mathsf{seq\usc{}in}_1}$. 
\end{prp}

\begin{proof}
Since $\mathcal{R}$ is saturated, it comes equipped with a right extension $\mathcal{S}$ which is again saturated. 
By \cref{lem:colim_shift}, it follows that the canonical map
\begin{equation*}
\begin{tikzcd}
B \arrow[d,swap,"q_{\mathcal{R}}"] \arrow[r,"\inr"] & A\sqcup^{\mathcal{R}} B \arrow[d,"q_{\mathcal{S}}"] \\
B/\mathcal{R} \arrow[r,densely dotted] & (A\sqcup^{\mathcal{R}} B)/\mathcal{S}
\end{tikzcd}
\end{equation*}
is an equivalence such that the square commutes. Therefore it follows that the square
\begin{equation*}
\begin{tikzcd}
\sm{y:A\sqcup^{\mathcal{R}} B} S(a,y) \arrow[d] \arrow[r] & \unit \arrow[d,"\mathsf{const}_{q(a)}"] \\
A\sqcup^{\mathcal{R}} B \arrow[r,"\mathsf{seq\usc{}in}_1"] & B/\mathcal{R}
\end{tikzcd}
\end{equation*}
is again a pulback square.
\end{proof}

\begin{cor}
Let $h:A\to B$ be a surjective function, and let $\mathcal{R}$ be a saturated graph extension of $h$, with quotient
\begin{equation*}
q_{\mathcal{R}}:B\to B/\mathcal{R}.
\end{equation*}
Then there is for any $r:R(x,y)$ a homotopy $\beta_r$ witnessing that the square
\begin{equation*}
\begin{tikzcd}
R(a,h(x)) \arrow[d,swap,"\mu(r)"] \arrow[r,"\varphi_{h(x)}"] & q(h(a))=q(h(x)) \arrow[d,"\ct{\blank}{\varphi_y(r)}"] \\
R(a,y) \arrow[r,swap,"\varphi_y"] & q(h(a))=q(y)
\end{tikzcd}
\end{equation*}
commutes. Moreover, the family $\beta$ of homotopies comes equipped with
\begin{align*}
\mathsf{left\usc{}unit}_\beta & : \\
\mathsf{right\usc{}unit}_\beta & : \\
\mathsf{coh\usc{}unit}_\beta & : 
\end{align*}
\end{cor}

\begin{thm}
For any surjective map $h:A\to B$, the lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{gphExt}(h)}\mathsf{sat}(\mathcal{R}) \arrow[d,"\proj 1"] \\
(B\,{\downarrow_s}\,\UU) \arrow[r,swap,"E"] \arrow[ur,densely dotted,"\mathcal{E}"] & \mathsf{gphExt}(h)
\end{tikzcd}
\end{equation*}
is an equivalence.
\end{thm}

\begin{proof}
We have already established that $\mathcal{Q}\circ\mathcal{E}\htpy \idfunc$. Therefore it remains to show that $\mathcal{E}\circ \mathcal{Q}\htpy\idfunc$. In other words: if $\mathcal{R}$ is a saturated graph extension of a surjective map $h:A\to B$, then $\mathcal{R}=\mathcal{E}_{q_{\mathcal{R}}\circ h,q_{\mathcal{R}}}$. 

We have seen that as presaturated relations, we have an identification
\end{proof}

\begin{cor}
For any type $A$, the lift
\begin{equation*}
\begin{tikzcd}
& \sm{\mathcal{R}:\mathsf{rRel}(A)}\mathsf{sat}(\mathcal{R}) \arrow[d,"\proj 1"] \\
(A\,{\downarrow_s}\,\UU) \arrow[r,swap,"k"] \arrow[ur,densely dotted,"\mathcal{K}"] & \mathsf{rRel}(A)
\end{tikzcd}
\end{equation*}
is an equivalence. In other words, the saturated reflexive relations form a system of equivalence relations, as defined in \cref{defn:system}.
\end{cor}

\subsection{Truncated saturated graph extensions}

\begin{lem}
Suppose $\mathcal{R}$ is a graph extension of $h:A\to B$, satisfying the following conditions:
\begin{enumerate}
\item The total space $\sm{y:B}R(a,b)$ is $(n+1)$-connected for each $a:A$.
\item Each $R(x,y)$ is $n$-truncated.
\end{enumerate}
Then $\mathcal{R}$ is presaturated. 
\end{lem}

\begin{proof}
Since the type $\sm{y:B}R(a,b)$ is $(n+1)$-connected for each $a:A$, it follows that the projection map
\begin{equation*}
\pi_1 : \Big(\sm{x:A}{y:B}R(x,y)\Big)\to A
\end{equation*}
is an $(n+1)$-connected map. Hence, the precomposition map
\begin{equation*}
\blank\circ\pi_1 : \Big(A\to \UU_{\leq n}\Big)\to \Big(\Big(\sm{x:A}{y:B}R(x,y)\Big)\to \UU_{\leq n}\Big)
\end{equation*}
is an equivalence, because the universe $\UU_{\leq n}$ of $n$-truncated types is $(n+1)$-truncated.
In particular, we have a unique extension of $R(a)\circ \pi_2$, as indicated in the diagram
\begin{equation*}
\begin{tikzcd}
\sm{x:A}{y:B}R(x,y) \arrow[r,"\pi_2"] \arrow[d,swap,"\pi_1"] & B \arrow[d,"R(a)"] \\
A \arrow[r,densely dotted] & \UU_{\leq n}
\end{tikzcd}
\end{equation*}
\end{proof}

\begin{lem}
Suppose $\mathcal{R}$ is a graph extension of $h:A\to B$ for which $\sm{y:B}R(a,b)$ is $n$-connected for each $a:A$. If $\mathcal{R}$ is presaturated with right extension $\mathcal{S}$, then $\sm{z:A\sqcup^{\mathcal{R}} B}S(a,z)$ is also $n$-connected.
\end{lem}

\begin{lem}
If $\mathcal{R}$ is an $(n+2)$-saturated graph extension of $h:A\to B$, then the type
\begin{equation*}
\sm{z:B_{n+1}}R_{n+1}(a,z)
\end{equation*}
is $(n+1)$-connected for each $a:A$.
\end{lem}

\begin{thm}
Suppose $\mathcal{R}$ is a graph extension of $h:A\to B$ for which $R(x,y)$ is $n$-truncated. If $\mathcal{R}$ is $(n+2)$-saturated, then $\mathcal{R}$ is saturated.
\end{thm}

\begin{proof}
First, we observe that the type
\begin{equation*}
\sm{y:B_n}R_{n}(x,y)
\end{equation*}
is $(n+1)$-connected. This holds since we have an equivalence
\begin{equation*}
\eqv{\Big(\Big)}{\Big(\Big)}
\end{equation*}

Recall that for any span $A \leftarrow S \rightarrow B$, if the map $S\to A$ is $n$-connected, then the map $\inr:B\to A\sqcup^S B$ is also $n$-connected.

Therefore, it follows that if $\mathcal{R}$ is a graph extension of $h:A\to B$, such that each $R(x,y)$ is $n$-truncated and $\sm{y:B}R(a,y)$ is $(n+1)$-connected, then $\mathcal{R}$ extends uniquely to a graph extension of $\inl:A\to A\sqcup^{\mathcal{R}} B$.
\end{proof}

\begin{conj}
Suppose $\mathcal{R}$ is an $n$-truncated graph extension of $h:A\to B$. Then the map
\begin{equation*}
\mathsf{sat}(\mathcal{R})\to \mathsf{sat}_{n+2-k}(\mathcal{R})
\end{equation*}
is $(k-2)$-truncated.
\end{conj}

\subsection{Coherence laws for presaturated reflexive relations}
Consider the type of \define{bi-extensions} of $\mathcal{R}$, consisting of
\begin{align*}
S & : A\sqcup^{\mathcal{R}}A \to A\sqcup^{\mathcal{R}} A \to \UU \\
\sigma & : \prd{t:A\sqcup^{\mathcal{R}} A} S(a,a)
\end{align*}
such that the map
\begin{equation*}
\epsilon_{\mathcal{R},\mathcal{S}} : \prd{a,b:A}R(a,b)\to S(\inl(a),\inr(b))
\end{equation*}
given by $r\mapsto \mathsf{tr}_{S(\inl(a))}(\glue(r),\sigma(\inl(a)))$ is a fiberwise equivalence.

By the universal property of reflexive coequalizers, the data of a bi-extension $\mathcal{S}$ of $\mathcal{R}$ is equivalent to
\begin{align*}
S_0 & : A \to A\sqcup^{\mathcal{R}} A \to \UU \\
S_1 & : \prd{x,x':A} R(x,x')\to \prd{t:A\sqcup^\mathcal{R}A} S_0(x,t) \simeq S_0(x',t) \\
S_r & : \prd{x:A}{t:A\sqcup^{\mathcal{R}} A} S_1(\rho(x),t)\htpy \idfunc \\
\sigma_0 & : \prd{x:A} S_0(x,\mathsf{in}(x)) \\
\sigma_1 & : \prd{x,y:A}{p:R(x,y)} S_1(p,\mathsf{in}(x),\sigma_0(x))=\sigma_1(y) \\
\sigma_r & : \prd{x:A} \sigma_1(\rho(x))=S_r(x,\mathsf{in}(x))
\end{align*}
such that the map
\begin{equation*}
\prd{x,y:A}R(x,y)\to S_0(x,\mathsf{in}(y))
\end{equation*}
given by $r\mapsto S_1(r,\sigma_0(x))$ is an equivalence. We apply the universal property of reflexive coequalizer again to see that the data type described above is equivalent to the type of
\begin{align*}
P_0 & : A \to A \to \UU \\
P_1 & : \prd{x,y,y':A} R(y,y')\to P_0(x,y) \simeq P_0(x,y') \\
P_r & : \prd{x,y:A} P_1(x,\rho(y))\htpy \idfunc \\
Q_0 & : \prd{x,x':A} R(x,x')\to \prd{y:A} P_0(x,y) \simeq P_0(x',y) \\
Q_1 & : \prd{x,x':A}{p:R(x,x')}{y,y':A}{q:R(y,y')} P_1(x',q)\circ Q_0(p,y)\htpy Q_0(p,y')\circ P_1(x,q) \\
Q_r & : \prd{x,x':A}{p:R(x,x')}{y:A} \ct{Q_1(p,\rho(y))}{P_r(x)Q_0(p,y)} \htpy P_r(x')Q_0(p,y) \\
H_0 & : \prd{x:A}{y:A} Q_0(\rho(x),y)\htpy \idfunc \\
H_1 & : \prd{x:A}{y,y':A}{q:R(y,y')} H_0(x,y)\htpy \ct{Q_1(\rho(x),q)}{H_0(x,y')} \\
H_r & : \prd{x:A}{y:A} H_1(x,\rho(y)) \cdots \\
\sigma_0 & : \prd{x:A} P_0(x,x) \\
\sigma_1 & : \prd{x,y:A}{p:R(x,y)} Q_0(p,x,\sigma_0(x))=\sigma_0(y) \\
\sigma_r & : \prd{x:A} \sigma_1(\rho(x))=H_0(x,x)
\end{align*}
such that the map
\begin{equation*}
\prd{x,y:A}R(x,y)\to P_0(x,y)
\end{equation*}
given by $r\mapsto Q_0(r,\sigma_0(x))$ is an equivalence.

By the coherence lemma this type is equivalent to the type
\begin{align*}
P_1 & : \prd{x,y,y':A} R(y,y')\to R(x,y) \simeq R(x,y') \\
P_r & : \prd{x,y:A} P_1(x,\rho(y))\htpy \idfunc \\
Q_0 & : \prd{x,x':A} R(x,x')\to \prd{y:A} R(x,y) \simeq R(x',y) \\
Q_1 & : \prd{x,x':A}{p:R(x,x')}{y,y':A}{q:R(y,y')} P_1(x',q)\circ Q_0(p,y)\htpy Q_0(p,y')\circ P_1(x,q) \\
Q_r & : \prd{x,x':A}{p:R(x,x')}{y:A} \ct{Q_1(p,\rho(y))}{P_r(x)Q_0(p,y)} \htpy P_r(x')Q_0(p,y) \\
H_0 & : \prd{x:A}{y:A} Q_0(\rho(x),y)\htpy \idfunc \\
H_1 & : \prd{x:A}{y,y':A}{q:R(y,y')} H_0(x,y)\htpy \ct{Q_1(\rho(x),q)}{H_0(x,y')} \\
H_r & : \prd{x:A}{y:A} H_1(x,\rho(y)) \cdots \\
\sigma_0 & : \prd{x:A} R(x,x) \\
\sigma_1 & : \prd{x,y:A}{p:R(x,y)} Q_0(p,x,\sigma_0(x))=\sigma_0(y) \\
\sigma_r & : \prd{x:A} \sigma_1(\rho(x))= H_0(x,x) \\
K_0 & : \prd{x,x':A}{p:R(x,x')} Q_0(r,\sigma_0(x))\htpy \idfunc
\end{align*}
