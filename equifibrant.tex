\chapter{The equifibrant replacement operation}

\section{Modal descent}\label{sec:modal_descent}
\subsection{\texorpdfstring{$\modal$}{â—‹}-\'etale maps}

\begin{defn}
We say that a map $f:A\to B$ is \define{$\modal$-\'etale} if the square
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"f"] \arrow[d,swap,"\eta"] & B \arrow[d,"\eta"] \\
\modal A \arrow[r,swap,"\modal f"] & \modal B
\end{tikzcd}
\end{equation*}
is a pullback square. We will write
\begin{equation*}
\isetale(f)\defeq\ispullback(f,\eta_A,\natunit_\modal(f)).
\end{equation*}
\end{defn}

It is immediate from the definition that any equivalence is $\modal$-\'etale, and that the $\modal$-\'etale maps are closed under composition.

\begin{eg}\label{eg:etale_prop}
We claim that a map $f:A\to B$ is $\brck{\blank}$-\'etale if and only if $A\to \isequiv(f)$. Examples of maps that satisfy this condition include equivalences, maps between propositions, and any map of the form $\emptyt\to B$.

To see that if $f:A\to B$ is $\modal$-\'etale, then $A\to\isequiv(f)$, consider the pullback square
\begin{equation*}
\begin{tikzcd}
A \arrow[r] \arrow[d,swap,"f"] & \brck{A} \arrow[d,"\brck{f}"] \\
B \arrow[r] & \brck{B},
\end{tikzcd}
\end{equation*}
and let $a:A$. Then both $\brck{A}$ and $\brck{B}$ are contractible, so $\brck{f}:\brck{A}\to\brck{B}$ is an equivalence. Since equivalences are stable under pullback it follows that $f$ is an equivalence.

Now suppose that $A\to \isequiv(f)$. Since $\isequiv(f)$ is a proposition, we also have $\brck{A}\to\isequiv(f)$. To see that the gap map
\begin{equation*}
A \to B\times_{\brck{B}}\brck{A}
\end{equation*}
is an equivalence, we will show that its fibers are contractible. Let $b:B$, $x:\brck{A}$ and $p:\bproj{b}=\brck{f}(x)$. Since $\brck{A}\to\isequiv(f)$, it follows that $f$ is an equivalence. Then $\brck{f}$ is also an equivalence, from which it follows that the naturality square is a pullback square. We conclude that the fibers of the gap map are contractible. 
\end{eg}

\begin{lem}\label{lem:etale_modal}
Any map between $\modal$-modal types is formaly \'etale.
\end{lem}

\begin{proof}
Suppose $f:X\to Y$ is a map between $\modal$-modal types. Then the top and bottom maps in the square
\begin{equation*}
\begin{tikzcd}
X \arrow[r] \arrow[d] & \modal X \arrow[d] \\
Y \arrow[r] & \modal Y
\end{tikzcd}
\end{equation*}
are equivalences. Therefore this square is a pullback square, so $f$ is $\modal$-\'etale.
\end{proof}

In this section our goal is to characterize the $\modal$-\'etale maps for the $n$-truncations. We call such maps \define{$n$-\'etale}. Note that the case of propositional truncation has already been addressed in \cref{eg:etale_prop}.

\begin{lem}\label{lem:etale_char}
Let $\modal$ be a modality for which all propositions are modal, and consider a map $f:A\to B$. The following are equivalent:
\begin{enumerate}
\item $f$ is $\modal$-\'etale.
\item The commuting square
\begin{equation*}
\begin{tikzcd}[column sep=large]
A\times_{\modal A} A \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times_{\modal f} f}"] & B\times_{\modal B} B \arrow[d,"\pi_1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{enumerate}
\end{lem}

\begin{rmk}
In the special case of $(-1)$-truncation, the characterization of \cref{lem:etale_char} asserts that a map $f:A\to B$ is $(-1)$-\'etale if and only if the square
\begin{equation*}
\begin{tikzcd}
A\times A \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times f}"] & B\times B \arrow[d,"\pi_1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{rmk}

\begin{proof}
Suppose first that $f$ is $\modal$-\'etale, and consider the commuting cube
\begin{equation*}
\begin{tikzcd}
& A\times_{\modal A} A \arrow[dl] \arrow[d] \arrow[dr] \\
A \arrow[d] & B\times_{\modal B} B \arrow[dl] \arrow[dr] & A \arrow[dl,crossing over] \arrow[d] \\
B \arrow[dr] & \modal A \arrow[from=ul,crossing over] \arrow[d] & B \arrow[dl] \\
& \modal B
\end{tikzcd}
\end{equation*}
Since the top, bottom, and both front squares are pullback squares, it follows that both back squares are pullback. This proves that (i) implies (ii).

Now suppose that (ii) holds. Then the map
\begin{equation*}
\fib{\modalunit}{\modalunit(a)}\to \fib{\modalunit}{\modalunit(f(a))}
\end{equation*}
is an equivalence for every $a:A$. Since all propositions are assumed to be modal, it follows that
\begin{equation*}
\fib{\modalunit}{t}\to \fib{\modalunit}{\modal f(t)}
\end{equation*}
is an equivalence for every $t:\modal A$. Thus it follows that the square
\begin{equation*}
\begin{tikzcd}
A \arrow[d,swap,"\modalunit"] \arrow[r] & B \arrow[d,"\modalunit"] \\
\modal A \arrow[r] & \modal B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{proof}

\begin{cor}
If $f:A\to B$ is $\modal$-\'etale, then the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
A \arrow[d,swap,"\delta_{\modalunit}"] \arrow[r,"f"] & B \arrow[d,"\delta_{\modalunit}"] \\
A\times_{\modal A} A \arrow[r,swap,"f\times_{\modal f}f"] & B\times_{\modal B} B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{cor}

\begin{proof}
Consider the diagram
\begin{equation*}
\begin{tikzcd}[column sep=large]
A \arrow[d,swap,"\delta_{\modalunit}"] \arrow[r,"f"] & B \arrow[d,"\delta_{\modalunit}"] \\
A\times_{\modal A} A \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times_{\modal f} f}"] & B\times_{\modal B} B \arrow[d,"\pi_1"] \\
A \arrow[r,"f"] & B
\end{tikzcd}
\end{equation*}
The bottom square is a pullback square by \cref{lem:etale_char}, and the outer rectangle is a pullback since both vertical composites are homotopic to the respective identity functions. Therefore the top square is a pullback.
\end{proof}

\begin{thm}
A map $f:A\to B$ is $0$-\'etale if and only if for each $a:A$ the restriction
\begin{equation*}
\begin{tikzcd}
\sm{x:A}\brck{a=x} \arrow[d,swap,"\proj 1"] \arrow[r,densely dotted,"f"] & \sm{y:B}\brck{f(a)=y} \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
of $f$ to the connected component at $a$ of $A$ is an equivalence. 
\end{thm}

\begin{proof}
By \cref{lem:etale_char} and the fact that $\eqv{(\tproj{0}{a}=\tproj{0}{x})}{\brck{a=x}}$, it follows that $f$ is $0$-\'etale if and only if the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\sm{a,x:A}\brck{a=x} \arrow[d,swap,"\pi_1"] \arrow[r,"\total{\brck{\apfunc{f}}}"] & \sm{b,y:B}\brck{b=y} \arrow[d,"\pi_1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square. Furhtermore, this square is a pullback if and only if the induced map
\begin{equation*}
\Big(\sm{x:A}\brck{a=x}\Big)\to\Big(\sm{y:B}\brck{f(a)=y}\Big)
\end{equation*}
is an equivalence, for each $a:A$.
\end{proof}

\subsection{Modal descent}

The following theorem can be seen as a `modal flattening lemma'.
\begin{thm}\label{thm:etale_flattening}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
E' \arrow[d,swap,"{p'}"] \arrow[r,"g"] & E \arrow[d,"p"] \\
B' \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
with $H:f\circ p'\htpy p\circ g$, where $X$ and $Y$ are modal types. Then the square
\begin{equation*}
\begin{tikzcd}
\modal E' \arrow[r,"\tilde{g}"] \arrow[d,swap,"{\modal p'}"] & E \arrow[d,"p"] \\
\modal B \arrow[r,swap,"\tilde{f}"] & B
\end{tikzcd}
\end{equation*}
is a pullback square, where $\tilde{f}$ and $\tilde{g}$ are the unique extensions of $f$ and $g$ along the modal units of $B'$ and $E'$, respectively.
\end{thm}

\begin{proof}
Consider the diagram
\begin{equation*}
\begin{tikzcd}
E' \arrow[r,"{\mathsf{gap}(p',g,H)}"] \arrow[d,swap,"{p'}"] &[2.5em] \modal B'\times_{B} E \arrow[r,"\pi_2"] \arrow[d,swap,"\pi_1"] & E \arrow[d,"p"] \\
B' \arrow[r,swap,"\modalunit"] & \modal B' \arrow[r,swap,"\tilde{f}"] & B
\end{tikzcd}
\end{equation*}
In this diagram, the square on the right is a pullback by definition, and the outer rectangle is a pullback by assumption, so the square on the left is also a pullback. Therefore the gap map $E'\to \modal B'\times_B E$ is $\modal$-connected. Moreover, since the modal types are closed under pullbacks it follows that $\modal B'\times_B E$ is modal, and therefore it follows that $\pi_2:\modal B'\times_B E\to E$ is a modal map. Therefore the composite
\begin{equation*}
\begin{tikzcd}
E' \arrow[r,"{\mathsf{gap}(p',g,H)}"] &[2.5em] \modal B'\times_{B} E \arrow[r,"\pi_2"] & E 
\end{tikzcd}
\end{equation*}
factors $g$ as a $\modal$-connected map followed by a $\modal$-modal map. Of course, another such factorization is the composite $g\htpy \tilde{g}\circ\modalunit$. Since factorizations are unique, the claim follows.
\end{proof}

Using modal flattening we establish partial left exactness of the modality.

\begin{cor}\label{cor:etale_lex}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
A' \arrow[d,swap,"{f'}"] \arrow[r] & A \arrow[d,"f"] \\
B' \arrow[r] & B,
\end{tikzcd}
\end{equation*}
where $f$ is assumed to be $\modal$-\'etale. Then the square
\begin{equation*}
\begin{tikzcd}
\modal A' \arrow[d,swap,"{\modal f'}"] \arrow[r] & \modal A \arrow[d,"\modal f"] \\
\modal B' \arrow[r] & \modal B,
\end{tikzcd}
\end{equation*}
is again a pullback square.
\end{cor}

\begin{proof}
Since $f$ is assumed to be $\modal$-\'etale, the square on the right in the diagram
\begin{equation*}
\begin{tikzcd}
A' \arrow[r] \arrow[d,swap,"{f'}"] & A \arrow[r] \arrow[d,swap,"f"] & \modal A \arrow[d,"\modal f"] \\
B' \arrow[r] & B \arrow[r] & \modal B
\end{tikzcd}
\end{equation*}
is a pullback square. Therefore the outer rectangle is a pullback square by the pullback pasting lemma. Now the claim follows from modal flattening \cref{thm:etale_flattening}, using the outer rectangle.
\end{proof}

\begin{cor}\label{cor:etale_pb}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
E' \arrow[d,swap,"{p'}"] \arrow[r,"g"] & E \arrow[d,"p"] \\
B' \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*} 
and suppose that $p:E\to B$ is $\modal$-\'etale. Then $p':E'\to B'$ is $\modal$-\'etale.
\end{cor}

\begin{proof}
Consider the commuting cube
\begin{equation*}
\begin{tikzcd}
&[-.5ex] E' \arrow[dr] \arrow[d] \arrow[dl] \\
\modal E' \arrow[d] & B' \arrow[dl] \arrow[dr] & E \arrow[dl,crossing over] \arrow[d] \\
\modal B' \arrow[dr] & \modal E \arrow[d] \arrow[from=ul,crossing over] & B \arrow[dl] \\
& \modal B.
\end{tikzcd}
\end{equation*}
The vertical squares on the back right and front right are pullback squares by assumption.
Then it follows from \cref{cor:etale_lex} that the vertical square on the front left is a pullback square.
Therefore the square on the back left is a pullback square by the pullback pasting property.
\end{proof}

\begin{defn}
Let $X$ be a type. We will define an operation
\begin{equation*}
\etmap:\Big(\sm{A:\UU_\modal}A\to\modal X\Big)\to\Big(\sm{Y:\UU}{g:Y\to X}\isetale(g)\Big)
\end{equation*}
\end{defn}

\begin{proof}[Construction]
Given a map $f:A\to \modal X$ we take the pullback
\begin{equation*}
\begin{tikzcd}
X\times_{\modal X}A \arrow[d,swap,"\pi_1"] \arrow[r,"\pi_2"] & A \arrow[d,"f"] \\
X \arrow[r,swap,"\modalunit"] & \modal X.
\end{tikzcd}
\end{equation*}
Then the map $\pi_1:X\times_{\modal X}A\to X$ is $\modal$-\'etale by \cref{lem:etale_modal,cor:etale_pb}.
\end{proof}

The following is a descent theorem for $\modal$-\'etale maps.

\begin{thm}[Modal descent]\label{thm:modal_descent}
For any modality $\modal$, and any type $X$, the operation
\begin{equation*}
\etmap:\Big(\sm{A:\UU_\modal}A\to\modal X\Big)\to\Big(\sm{Y:\UU}{g:Y\to X}\isetale(g)\Big)
\end{equation*}
is an equivalence.
\end{thm}

\begin{proof}
If $g:Y\to X$ is $\modal$-\'etale, then the square
\begin{equation*}
\begin{tikzcd}
Y \arrow[d,swap,"g"] \arrow[r,"\modalunit"] & \modal Y \arrow[d,"\modal g"] \\
X \arrow[r,swap,"\modalunit"] & \modal X
\end{tikzcd}
\end{equation*}
is a pullback square. Therefore $g:Y\to X$ is in the fiber of $\etmap$ at $\modal g : \modal Y\to\modal X$. 

It remains to show that for any map $f:A\to\modal X$ with modal domain, there is an equivalence $\eqv{A}{\modal (X\times_{\modal X} A)}$ such that the triangle
\begin{equation*}
\begin{tikzcd}
A \arrow[dr,swap,"f"] \arrow[rr,"\eqvsym"] & & \modal (X\times_{\modal X} A) \arrow[dl,"\modal(\etmap(f))"] \\
& \modal X
\end{tikzcd}
\end{equation*}
commutes. To see this, note that both $f\circ \pi_2$ and $\modal(\etmap(f))\circ \modalunit$ factor the same map as a $\modal$-connected map followed by a modal map, so the claim follows from uniqueness of factorizations.
\end{proof}

\begin{cor}
Suppose $P:X\to\UU_\modal$ is a family of modal types such that the projection map $\proj 1:\big(\sm{x:X}P(x)\big)\to X$ is $\modal$-\'etale. Then $P$ has a unique extension
\begin{equation*}
\begin{tikzcd}
X \arrow[d,swap,"\modalunit"] \arrow[r,"P"] & \UU_\modal. \\
\modal X \arrow[ur,densely dotted,swap,"\tilde{P}"] 
\end{tikzcd}
\end{equation*}
It follows that the square commuting square
\begin{equation*}
\begin{tikzcd}
\sm{x:X}P(x) \arrow[d,swap,"\proj 1"] \arrow[r] & \sm{t:\modal X}\tilde{P}(t) \arrow[d,"\proj 1"] \\
X \arrow[r,swap,"\modalunit"] & \modal X
\end{tikzcd}
\end{equation*}
is a pullback square. In particular the top map is $\modal$-connected, so this square is in fact a $\modal$-naturality square.
\end{cor}

\begin{lem}
If $f$ is $n$-\'etale, then it is right orthogonal to $\unit\to\sphere{n+1}$.
\end{lem}

\begin{proof}
Suppose $f:X\to Y$ is $n$-\'etale, and consider the commuting cube
\begin{equation*}
\begin{tikzcd}
&[-1ex] X^{\sphere{n+1}} \arrow[dl] \arrow[d] \arrow[dr] &[2ex] \\
\trunc{n}{X}^{\sphere{n+1}} \arrow[d] & Y^{\sphere{n+1}} \arrow[dl] \arrow[dr] & X \arrow[dl,crossing over] \arrow[d] \\
\trunc{n}{Y}^{\sphere{n+1}} \arrow[dr] & \trunc{n}{X} \arrow[d] \arrow[from=ul,crossing over] & Y \arrow[dl] \\
& \trunc{n}{Y}
\end{tikzcd}
\end{equation*}
In this cube the front right square is a pullback square by the assumption that $f$ is $n$-\'etale. The back left square is an exponent of this pullback square, so it is again pullback. The front left square is a pullback square because its top and bottom map are both equivalences. Therefore we conclude that the back right square is a pullback square, which shows that $f$ is right orthogonal to the map $\unit\to\sphere{n+1}$.
\end{proof}

\begin{conj}
Let $f:X\to Y$ be a map, and let $n\geq -1$. The following are equivalent:
\begin{enumerate}
\item $f$ is $n$-\'etale.
\item $f$ is right orthogonal to the maps $\sphere{n+1}\to 1$ and $\unit\to\sphere{n+1}$. 
\end{enumerate}
\end{conj}

\begin{proof}[Incomplete proof]
By \cref{thm:modal_descent} it suffices to show that the type $\trunc{n}{X}\to\UU^{\leq n}$ of families of $n$-types over $\trunc{n}{X}$ is equivalent to the type of families $P:X\to\UU^{\leq n}$ of $n$-types over $X$, for which the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\Big(\sm{x:X}P(x)\Big)^{\sphere{n+1}} \arrow[r,"{h\mapsto h(\base)}"] \arrow[d,swap,"\proj 1\circ\blank"] & \sm{x:X}P(x) \arrow[d,"\proj 1"] \\
X^{\sphere{n+1}} \arrow[r,swap,"{h\mapsto h(\base)}"] & X
\end{tikzcd}
\end{equation*}
is a pullback square. Note that this square is a pullback square if and only if the square
\begin{equation*}
\begin{tikzcd}[column sep=9em]
\sm{f:X^{\sphere{n+1}}}\prd{t:\sphere{n+1}}P(f(t)) \arrow[r,"{(f,g)\mapsto (f(\base),g(\base))}"] \arrow[d,swap,"\proj 1"] & \sm{x:X}P(x) \arrow[d,"\proj 1"] \\
X^{\sphere{n+1}} \arrow[r,swap,"{f\mapsto f(\base)}"] & X
\end{tikzcd}
\end{equation*}
is a pullback square. This is equivalent to showing that the map
\begin{equation*}
g\mapsto g(\base):\Big(\prd{t:\sphere{n+1}}P(f(t))\Big)\to P(f(\base))
\end{equation*}
is an equivalence for every $f:\sphere{n+1}\to X$. The fiber of this map at $p:P(f(\base))$ is equivalent to the type
\begin{equation*}
\sm{q:P(f(\base))}\prd{t:\sphere{n}}\mathsf{tr}_P(\glue(t)
\end{equation*}
....
\end{proof}

\subsection{The reflective factorization system of a modality}

In this subsection we investigate the reflective factorization system assiciated to a modality, of which the right class is the class of $\modal$-\'etale maps. The left class is the class of \emph{$\modal$-equivalences}.
\begin{defn}
We say that a map $f:A\to B$ is an \define{$\modal$-equivalence} if $L f:\modal A\to \modal B$ is an equivalence.
\end{defn}

\begin{rmk}
The difference between the notions of $\modal$-equivalences and $\modal$-connected maps is best explained by an example. In the case of $n$-truncation, the $n$-equivalences are precisely the maps that induce isomorphisms on the first $n$ homotopy groups. The $n$-connected maps are the maps that induce isomorphisms on the first $n$ homotopy groups, and moreover induce an epimorphism on the $(n+1)$-st homotopy group. 

We also note that the $n$-equivalences are not stable under pullbacks, whereas the $n$-connected maps are. Consider for instance the pullback square
\begin{equation*}
\begin{tikzcd}
\loopspace {\sphere{n+1}} \arrow[r] \arrow[d] & \unit \arrow[d] \\
\unit\arrow[r] & \sphere{n+1}
\end{tikzcd}
\end{equation*}
Here the map on the right is an $n$-equivalence, since $\sphere{n+1}$ is $n$-connected. However, the map on the left is not an $n$-equivalence, since the $n$-th homotpy group of $\loopspace{\sphere{n+1}}$ is not trivial: it is the $(n+1)$-st homotopy group of $\sphere{n+1}$, which is $\Z$.
\end{rmk}

\begin{defn}
The \define{reflective factorization system} associated to a modality $\modal$ consists of the $\modal$-equivalences as the left class, and the $\modal$-\'etale maps as the right class.
\end{defn}

Our goal in this section is to show that the reflective factorization system associated to a modality is an orthogonal factorization system.

\begin{lem}\label{lem:3for2_mequiv}
The $\modal$-equivalences satisfy the 3-for-2 property: given a commuting triangle
\begin{equation*}
\begin{tikzcd}
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& C,
\end{tikzcd}
\end{equation*}
if any two of $f$, $g$, and $h$ are $\modal$-equivalences, then so is the third.
\end{lem}

\begin{proof}
Apply $\modal$ to the commuting triangle, and use the 3-for-2 property of equivalences.
\end{proof}

\begin{lem}\label{lem:modal_equivalence}
For a map $f : A \to B$ the following are equivalent:
\begin{enumerate}
\item $f$ is an $\modal$-equivalence.
\item For any modal type $X$, the precomposition map
\begin{equation*}
\precomp{f} : (B \to X) \to (A \to X)
\end{equation*}
is an equivalence.
\end{enumerate}
\end{lem}

\begin{proof} 
Suppose first that $f$ is an $\modal$-equivalence, and let $X$ be $\modal$-modal. Then the square
\begin{equation*}
\begin{tikzcd}
X^B \arrow[r,"\precomp{f}"] \arrow[d,swap,"\precomp{\eta}"] & X^A \arrow[d,"\precomp{\eta}"] \\
X^{\modal B} \arrow[r,swap,"\precomp{\modal f}"] & X^{\modal A}
\end{tikzcd}
\end{equation*}
commutes. In this square the two vertical maps are equivalences by the universal property of modalization, and the bottom map is an equivalence since $\modal f$ is an equivalence. Therefore the map $\precomp{f}:X^B\to X^A$ is an equivalence, as desired.

Conversely, assume that $\precomp{f} : X^B \to X^A$ is an equivalence for every $\modal$-modal type $X$. By the square above it follows that $\precomp{\modal f}:X^{\modal B}\to X^{\modal A}$ is an equivalence for every $\modal$-modal type $X$. The fiber of $\modal A^{\modal B}\to \modal A^{\modal A}$ at $\idfunc:\modal A\to \modal A$ is contractible, so we obtain a retraction $g$ of $\modal f$. To see that $g$ is also a section observe that the fiber of $\modal B^{\modal B}\to \modal B^{\modal A}$ at $\modal f$ is contractible. This fiber contains $(\idfunc[\modal B],\refl{\modal f})$. However, we also have an identification $p:\precomp{\modal f}(\modal f\circ g)=\modal f$, since
\begin{equation*}
\precomp{\modal f}(\modal f\circ g)\jdeq (\modal f \circ g)\circ \modal f\jdeq \modal f \circ (g\circ \modal f) = \modal f. 
\end{equation*}
Therefore $(\modal f\circ g,p)$ is in the fiber of $\precomp{\modal f}:\modal B^{\modal B}\to \modal B^{\modal A}$ at $\modal f$. By the contractibility of the fibers it follows that $(\modal f\circ g,p)=(\idfunc[\modal B],\refl{\modal f})$, so it follows that $\modal f\circ g=\idfunc[\modal B]$. In other words, $g$ is both a retraction and a section of $\modal f$, so $\modal f$ is an equivalence.
\end{proof}

\begin{cor}\label{cor:mequiv_mconn}
Every $\modal$-connected map is a $\modal$-equivalence.
\end{cor}

\begin{lem}\label{lem:rfs_factor}
Every map factors as a $\modal$-equivalence followed by a $\modal$-\'etale map.
\end{lem}

\begin{proof}
Consider a map $f:A\to B$, and the diagram
\begin{equation*}
\begin{tikzcd}
A \arrow[ddr,bend right=15,swap,"f"] \arrow[drr,bend left=15,"\modalunit"] \arrow[dr,"\mathsf{gap}" description] \\
& B\times_{\modal B} \modal A \arrow[d,swap,"\pi_1"] \arrow[r,"\pi_2"] & \modal A \arrow[d,"\modal f"] \\
& B \arrow[r,swap,"\modalunit"] & \modal B.
\end{tikzcd}
\end{equation*}
Then $\pi_1:B\times_{\modal B} \modal A\to B$ is a pullback of a map between modal types, so it is $\modal$-\'etale by \cref{cor:etale_pb}. Furthermore, the map $\pi_2:B\times_{\modal B}\modal A\to \modal A$ is a pullback of a $\modal$-connected map, so it is $\modal$-connected. It follows from \cref{cor:mequiv_mconn} that it is a $\modal$-equivalence. Since the modal unit $\modalunit :A\to\modal A$ is also $\modal$-connected, and therefore a $\modal$-equivalence, we obtain by the 3-for-2 property of $\modal$-equivalences established in \cref{lem:3for2_mequiv} that the gap map is also a $\modal$-equivalence.
\end{proof}

Recall that a map $i:A\to B$ is said to be \define{left orthogonal} to a map $f:X\to Y$, or that the map $f$ is \define{right orthogonal} to the map $i$,
if each commuting square of the form
\begin{equation*}
\begin{tikzcd}
A \arrow[r] \arrow[d,swap,"i"] & X \arrow[d,"f"] \\
B \arrow[r] & Y
\end{tikzcd}
\end{equation*}
has a unique diagonal filler. Following \cite{AnelBiedermanFinsterJoyal}, we note that this can be expressed conviniently as the condition that the square
\begin{equation*}
\begin{tikzcd}
X^B \arrow[r,"f\circ\blank"] \arrow[d,swap,"\blank\circ i"] & Y^B \arrow[d,"\blank\circ i"] \\
X^A \arrow[r,swap,"f\circ\blank"] & Y^A
\end{tikzcd}
\end{equation*}
is a pullback square.

\begin{lem}\label{lem:rfs_orthogonal}
The class of $\modal$-equivalences is left orthogonal to the class of $\modal$-\'etale maps.
\end{lem}

\begin{proof}
We have to show that for every $\modal$-equivalence $i:A\to B$, and every $\modal$-\'etale map $f:X\to Y$, the square
\begin{equation*}
\begin{tikzcd}
X^B \arrow[r] \arrow[d] & Y^B \arrow[d] \\
X^A \arrow[r] & Y^A
\end{tikzcd}
\end{equation*}
is a pullback square. Consider the commuting cube
\begin{equation*}
\begin{tikzcd}
&[-1ex] X^B \arrow[dl] \arrow[d] \arrow[dr] \\
(\modal X)^B \arrow[d] & X^A \arrow[dl] \arrow[dr] & Y^B \arrow[d] \arrow[dl,crossing over] \\
(\modal X)^A \arrow[dr] & (\modal Y)^B \arrow[from=ul,crossing over] \arrow[d] & Y^A \arrow[dl] \\
& (\modal Y)^A
\end{tikzcd}
\end{equation*}
In this cube the top and bottom squares are pullback by the assumption that $f$ is $\modal$-\'etale and the fact that exponents of pullback squares are again pullback squares. Furthermore, the square in the front left is pullback, because the two vertical maps are equivalences by the assumption that $i:A\to B$ is a $\modal$-equivalence. Therefore we conclude that the square in the back right is also a pullback square, as desired.
\end{proof}

\begin{cor}
For any map $f:X\to Y$, the type of factorizations into a $\modal$-connected map followed by a $\modal$-\'etale map is contractible.
\end{cor}

\section{\texorpdfstring{$\Delta$}{Î”}-\'etale maps}

\begin{prp}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
\mathcal{C} \arrow[r] \arrow[d] & \mathcal{B} \arrow[d] \\
\mathcal{A} \arrow[r] & \mathcal{X}
\end{tikzcd}
\end{equation*}
of reflexive graphs. The following are equivalent:
\begin{enumerate}
\item The square is a pullback square.
\item The squares
\begin{equation*}
\begin{tikzcd}
\tilde{C}_0 \arrow[r] \arrow[d] & \tilde{B}_0 \arrow[d] & \tilde{C}_1 \arrow[r] \arrow[d] & \tilde{B}_1 \arrow[d] \\
\tilde{A}_0 \arrow[r] & \tilde{X}_0 & \tilde{A}_1 \arrow[r] & \tilde{X}_1
\end{tikzcd}
\end{equation*}
are pullback squares.
\end{enumerate}
\end{prp}

\begin{defn}
Let $f:\mathsf{rGph}(\mathcal{A},\mathcal{B})$ be a morphism of reflexive graphs. We say that $f$ is \define{$\Delta$-\'etale} if the square
\begin{equation*}
\begin{tikzcd}
\mathcal{A} \arrow[d] \arrow[r] & \Delta(\rcoeq(\mathcal{A})) \arrow[d] \\
\mathcal{B} \arrow[r] & \Delta(\rcoeq(\mathcal{B}))
\end{tikzcd}
\end{equation*}
is a pullback square of reflexive graphs. We write $\mathsf{is\usc{}etale}_\Delta(f)$ for the proposition that $f$ is $\Delta$-\'etale, and we also write $\mathcal{R}^\Delta$ for the class of $\Delta$-\'etale morphisms of reflexive graphs.
\end{defn}

\begin{thm}
Consider a morphism $f:\mathcal{A}\to\mathcal{B}$ of reflexive graphs. The following are equivalent:
\begin{enumerate}
\item The morphism $f$ is a fibration in the sense of \cref{defn:graph_fibration}.
\item The morphism $f$ is $\Delta$-\'etale.
\end{enumerate}
\end{thm}

\begin{proof}
Consider the diagram
\begin{equation*}
\begin{tikzcd}
& & \pts{\tilde A} \arrow[d] \arrow[dr] \\
& \edg{\tilde A} \arrow[dl] \arrow[d] \arrow[ur] & \pts{\tilde B} \arrow[dl] \arrow[dr] & \rcoeq(\mathcal{A}) \arrow[d] \\
\pts{\tilde A} \arrow[d] & \edg{\tilde B} \arrow[dl] \arrow[dr] \arrow[ur] & \rcoeq(\mathcal{A}) \arrow[from=ul,crossing over] \arrow[dl,crossing over] \arrow[d] \arrow[ur,crossing over] & \rcoeq(\mathcal{B}) \\
\pts{\tilde B} \arrow[dr] & \rcoeq(\mathcal{A}) \arrow[d] \arrow[from=ul,crossing over] & \rcoeq(\mathcal{B}) \arrow[dl] \arrow[ur] \\
\phantom{\rcoeq(\mathcal{B})} & \rcoeq(\mathcal{B})
\end{tikzcd}
\end{equation*}
\end{proof}

\begin{cor}
Let $\mathcal{B}$ be a family of reflexive graphs over $\mathcal{A}$. The following are equivalent:
\begin{enumerate}
\item The family $\mathcal{B}$ is equifibered.
\item The morphism $\proj 1 : \mathsf{rGph}(\msm{\mathcal{A}}{\mathcal{B}})$ is $\Delta$-\'etale.
\end{enumerate}
\end{cor}

\section{Equifibrant replacement}

\begin{defn}
Let $f:\Gamma'\to\Gamma$ be a morphism of reflexive graphs. We say that $f$ is a \define{$\Delta$-equivalence} if the map
\begin{equation*}
\begin{tikzcd}
\rcoeq(f):\rcoeq(\Gamma')\to \rcoeq(\Gamma)
\end{tikzcd}
\end{equation*}
is an equivalence. We also write $\mathcal{L}^\Delta$ for the class of $\Delta$-equivalences of reflexive graphs.
\end{defn}

\begin{thm}
The pair $(\mathcal{L}^\Delta,\mathcal{R}^\Delta)$ forms an orthogonal factorization system of reflexive graphs.
\end{thm}

\begin{thm}\label{thm:eqf_initial}
Consider a family $\mathcal{B}$ of reflexive graphs over $\mathcal{A}$, and let $\mathcal{E}$ be an equifibered family over $\mathcal{A}$. Then the pre-composition operation
\begin{equation*}
\mathsf{rGph}_{\mathcal{A}}(\mathsf{EqF}(\mathcal{B}),\mathcal{E})\to \mathsf{rGph}_{\mathcal{A}}(\mathcal{B},\mathcal{E})
\end{equation*}
is an equivalence for every equifibered family $\mathcal{E}$ over $\mathcal{A}$.
\end{thm}

\section{Identity types of colimits}
\subsection{Identity types of reflexive coequalizers}

\begin{defn}
Consider a reflexive graph $\mathcal{A}$ with a base point $a:A_0$. We define the \define{universal $\Delta$-bundle} $\mathcal{E}(a)$ over $\mathcal{A}$ at $a$ to be the equifibered family over $\mathcal{A}$ corresponding to the equifibrant replacement of the morphism $a:\mathsf{rGph}(\unit,\mathcal{A})$ corresponding to $a:A_0$. 
\end{defn}

\begin{thm}
Consider a reflexive graph $\mathcal{A}$ with a base point $a:A_0$. Then there are equivalences
\begin{equation*}
\pts{\mathcal{E}(a)}(x) \eqvsym (\mathsf{constr}_0(a)=\mathsf{constr}_0(x))
\end{equation*}
In particular, we have an equivalence $\eqv{\pts{\mathcal{E}(a)}(a)}{\loopspace{\rcoeq(\mathcal{A})}}$. 
\end{thm}

In the following theorem we establish the universal property of the identity type of $\rcoeq(\mathcal{A})$ as the initial reflexive relation $I$ on 

\begin{thm}
Consider a reflexive graph $\mathcal{A}$, and let
\begin{align*}
R & : A_0 \to A_0 \to\UU, \\
\rho & : \prd{x:A_0}R(x,x)
\end{align*}
be a reflexive relation on $A_0$ equipped with a `composition' operation
\begin{equation*}
\mu:\prd{a,x,y:\pts{A}} \edg{A}(x,y) \to (\eqv{R(a,x)}{R(a,y)}).
\end{equation*}
satisfying the unit law
\begin{align*}
\mathsf{left\usc{}unit}_\mu & : \prd{x,y:\pts{A}}{r:R(x,y)} \mu(\rfx{\mathcal{A}}(y),r)=r.
\end{align*}
Then there is a uniqe extension
\begin{equation*}
\begin{tikzcd}
\mathcal{A} \arrow[r,"\bar{\mu}"] \arrow[d] & (A_0,R,\rho) \\
k(\mathsf{constr}_0) \arrow[ur,densely dotted]
\end{tikzcd}
\end{equation*}
of the morphism $\bar{\mu}:\mathsf{rGph}(\mathcal{A},(A_0,R,\rho))$ consisting of
\begin{align*}
\pts{\bar{\mu}} & \defeq \mathsf{constr}_0 \\
\edg{\bar{\mu}}(e) & \defeq \mu(e,\rho(x)) \\
\rfx{\bar{\mu}}(x) & \defeq \mathsf{left\usc{}unit}_\mu(\rho(x)),
\end{align*}
where $k(\mathsf{constr}_0)$ is the pre-kernel of the function $\mathsf{constr}_0:A_0\to\rcoeq(\mathcal{A})$.
\end{thm}

\begin{cor}
The loop space of the suspension $\susp X$ of a pointed type $X$ is the initial pointed type $Y$ equipped with a pointed map 
\begin{equation*}
X\to_\ast (\eqv{Y}{Y}).
\end{equation*}
In particular, the loop space of the $(n+1)$-sphere is the initial pointed type $Y$ equipped with a a pointed map $\sphere{n}\to (\eqv{Y}{Y})$, or equivalently, an $(n+1)$-loop $\loopspace[n+1]{\mathrm{BAut}(Y)}$. Even more in particular, the loop space of the $2$-sphere is the initial pointed type $Y$ equipped with a homotopy $\idfunc[Y]\htpy\idfunc[Y]$. 
\end{cor}

\subsection{Identity types of sequential colimits}
