\chapter{Type theoretic descent}

\section{Martin-L\"of type theory}

\subsection{Notation}

We will write $\tr_{B}({p},{b})$ for the transport of $b:B(x)$ along $p:\id[A]{x}{y}$ with respect to a type family $B$ over $A$.

\subsection{The fundamental theorem of identity types}
Consider a family
\begin{equation*}
f : \prd{x:A}B(x)\to C(x)
\end{equation*}
of maps. Such $f$ is also called a \define{fiberwise map} or \define{fiberwise transformation}.

\begin{defn}[Definition 4.7.5 of \cite{hottbook}]
We define a map
\begin{equation*}
\total{f}:\sm{x:A}B(x)\to\sm{x:A}C(x).
\end{equation*}
by $\lam{(x,y)}(x,f(x,y))$.
\end{defn}

\begin{lem}[Theorem 4.7.6 of \cite{hottbook}]\label{lem:fib_total}
For any fiberwise transformation $f:\prd{x:A}B(x)\to C(x)$, and any $a:A$ and $c:C(a)$, there is an equivalence
\begin{equation*}
\eqv{\fib{f(a)}{c}}{\fib{\total{f}}{\pairr{a,c}}}.
\end{equation*}
\end{lem}

\begin{thm}[Theorem 4.7.7 of \cite{hottbook}]\label{thm:fib_equiv}
Let $f:\prd{x:A}B(x)\to C(x)$ be a fiberwise transformation. The following are logically equivalent:
\begin{enumerate}
\item For each $x:A$, the map $f(x)$ is an equivalence. In this case we say that $f$ is a \define{fiberwise equivalence}.
\item The map $\total{f}:\sm{x:A}B(x)\to\sm{x:A}C(x)$ is an equivalence.
\end{enumerate}
\end{thm}

\begin{thm}\label{thm:id_fundamental}
Let $A$ be a type with $a:A$, and let $B$ be be a type family over $A$ with $b:B(a)$.
Then  the following are logically equivalent:
\begin{enumerate}
\item The canonical family of maps
\begin{equation*}
\rec{a{=}}(b):\prd{x:A} (a=x)\to B(x)
\end{equation*}
is a fiberwise equivalence.
\item The total space
\begin{equation*}
\sm{x:A}B(x)
\end{equation*}
is contractible.
\end{enumerate}
\end{thm}

\begin{proof}
By \autoref{thm:fib_equiv} it follows that the fiberwise transformation $\rec{a{=}}(b)$ is a fiberwise equivalence if and only if it induces an equivalence
\begin{equation*}
\eqv{\Big(\sm{x:A}a=x\Big)}{\Big(\sm{x:A}B(x)\Big)}
\end{equation*}
on total spaces. We have that $\sm{x:A}a=x$ is contractible. Now it follows by the 3-for-2 property of equivalences, applied in the case
\begin{equation*}
\begin{tikzcd}
\sm{x:A}a=x \arrow[rr,"\total{\rec{a{=}}(b)}"] \arrow[dr,swap,"\eqvsym"] & & \sm{x:A}B(x) \arrow[dl] \\
& \unit
\end{tikzcd}
\end{equation*}
that $\total{\rec{a{=}}(b)}$ is an equivalence if and only if $\sm{x:A}B(x)$ is contractible.
\end{proof}

\section{Extensionality axioms}

\subsection{Function extensionality}
\begin{thm}\label{thm:funext_wkfunext}\specialindex{function extensionality}
The following are equivalent:
\begin{enumerate}
\item The principle of \define{homotopy induction}\index{homotopy induction}: for every $f:\prd{x:A}B(x)$ and every type family
\begin{equation*}
\Gamma,g:\prd{x:A}B(x), H:f\htpy g \vdash P(g,H)~\mathrm{type},
\end{equation*}
the map
\begin{equation*}
\Big(\prd{g:\prd{x:A}B(x)}{H:f\htpy g}P(g,H)\Big)\to P(f,\mathsf{htpy.refl}_f)
\end{equation*}
given by $s\mapsto s(f,\mathsf{htpy.refl}_f)$ has a section.
\item The \define{function extensionality principle}\index{function extensionality}: For every type family $B$ over $A$, and any two dependent functions $f,g:\prd{x:A}B(x)$, the canonical map\index{htpy_eq@{$\mathsf{htpy\usc{}eq}$}|textbf}
\begin{equation*}
\mathsf{htpy\usc{}eq}(f,g) : (\id{f}{g})\to (f\htpy g)
\end{equation*}
by path induction (sending $\refl{f}$ to $\lam{x}\refl{f(x)}$) is an equivalence. We will write $\mathsf{eq\usc{}htpy}$\index{eq_htpy@{$\mathsf{eq\usc{}htpy}$}} for its inverse.
\item The \define{weak function extensionality principle}\index{weak function extensionality} holds: For every type family $B$ over $A$ one has\index{contractible!weak function extensionality}
\begin{equation*}
\Big(\prd{x:A}\iscontr(B(x))\Big)\to\iscontr\Big(\prd{x:A}B(x)\Big).
\end{equation*}
\end{enumerate}
\end{thm}

\begin{proof}
To show that homotopy induction implies function extensionality, note that from homotopy induction and $\Sigma$-induction combined, we obtain that for any type family $P$ over $\sm{g:\prd{x:A}B(x)}f\htpy g$, the evaluation map
\begin{equation*}
\Big(\prd{t:\sm{g:\prd{x:A}B(x)}f\htpy g} P(t)\Big)\to P((f,\mathsf{htpy.refl}_f))
\end{equation*}
has a section. In other words, the type $\sm{g:\prd{x:A}B(x)}f\htpy g$ satisfies singleton induction and therefore it is contractible. Now we conclude by \cref{thm:id_fundamental} that the canonical map $(f=g)\to (f\htpy g)$ is an equivalence, i.e.~that function extensionality holds.

Conversely, to prove homotopy induction from function extensionality we again note that by function extensionality and \cref{thm:id_fundamental} the type 
\begin{equation*}
\sm{g:\prd{x:A}B(x)}f\htpy g
\end{equation*}
is contractible. Therefore it satisfies singleton induction, so homotopy induction follows.

To show that function extensionality implies weak function extensionality, suppose that each $B(a)$ is contractible with center of contraction $c(a)$ and contraction $C_a:\prd{y:B(a)}c(a)=y$. Then we take $c\defeq \lam{a}c(a)$ to be the center of contraction of $\prd{x:A}B(x)$. To construct the contraction we have to define a term of type
\begin{equation*}
\prd{f:\prd{x:A}B(x)}c=f.
\end{equation*}
Let $f:\prd{x:A}B(x)$. By function extensionality we have a map $(c\htpy f)\to (c=f)$, so it suffices to construct a term of type $c\htpy f$. Here we take $\lam{a}C_a(f(a))$. This completes the proof that function extensionality implies weak function extensionality.

To prove function extensionality from weak function extensionality, observe that it suffices by \autoref{thm:id_fundamental} to show that
\begin{equation*}
\sm{g:\prd{x:A}B(x)}f\htpy g
\end{equation*}
is contractible.

Since the type $\sm{b:B(x)}f(x)=b$ is contractible for each $x:X$, it follows by our assumption of weak function extensionality that the type $\prd{x:A}\sm{b:B(x)}f(x)=b$ is contractible. By \autoref{ex:contr_retr} it therefore suffices to show that
\begin{equation*}
\sm{g:\prd{x:A}B(x)}f\htpy g
\end{equation*}
is a retract of the type $\prd{x:A}\sm{b:B(x)}f(x)=b$. We have the functions
\begin{align*}
i & \defeq \ind{\Sigma}(\lam{g}{H}{x}\pairr{g(x),H(x)}) \\
r & \defeq \lam{p}\pairr{\lam{x}\proj 1(p(x)),\lam{x}\proj 2(p(x))}.
\end{align*}
It remains to show that $r\circ i\htpy \idfunc$. This homotopy is constructed by $\Sigma$-induction. Let $g:\prd{x:A}B(x)$ and let $H:f\htpy g$. Then we have
\begin{align*}
r(i(g,H)) & \jdeq r(\lam{x}\pairr{g(x),H(x)}) \\
& \jdeq \pairr{\lam{x}g(x),\lam{x}H(x)} \\
& \jdeq \pairr{g,H}.
\end{align*}
In other words, the homotopy $r\circ i\htpy \idfunc$ is given by $\ind{\Sigma}(\lam{g}{H}\refl{(\pairr{g,H})})$. 
\end{proof}

\begin{comment}
\begin{rmk}
Since we assumed the $\eta$-rule for $\Sigma$-types, we also have
\begin{align*}
\mathsf{pi\usc{}sigma}(\mathsf{sigma\usc{}pi}(p)) & \jdeq \mathsf{pi\usc{}sigma}(\pairr{\lam{x}\proj 1(p(x)),\lam{x}\proj 2(p(x))}) \\
& \jdeq \lam{x}\pairr{\proj 1(p(x)),\proj 2(p(x))} \\
& \jdeq \lam{x} p(x) \\
& \jdeq p.
\end{align*}
Therefore, the types $\sum_g f\htpy g$ and $\prod_x\sum_b f(x)=b$ are actually \emph{judgmentally isomorphic}. 
\end{rmk}
\end{comment}

\begin{comment}
\begin{thm}
Assume weak function extensionality. Then for any type $A$, the type $\iscontr(A)$ is a proposition.
\end{thm}

\begin{proof}
Let $A$ be a contractible type with center of contraction $c$, and contraction $C$. We want to show that
\begin{equation*}
\prd{d:A}{D:\prd{x:A}d=x} (c,C)=(d,D).
\end{equation*}
Since $A$ is contractible, we may proceed by singleton induction. Thus, it suffices to show that
\begin{equation*}
\prd{D:\prd{x:A}c=x}(c,C)=(c,D).
\end{equation*}
Now recall from \cref{ex:prop_contr} it follows that for any $x:A$ the type $c=x$ is contractible. By the principle of weak function extensionality it follows that the type $\prd{x:A}c=x$ is contractible. Therefore we may proceed by singleton induction on $D$. It suffices to show that
\begin{equation*}
(c,C)=(c,C),
\end{equation*}
which we have by reflexivity.
\end{proof}
\end{comment}

\begin{thm}\label{thm:trunc_pi}
Assume function extensionality. Then for any type family $B$ over $A$ one has\index{truncated}
\begin{equation*}
\Big(\prd{x:A}\istrunc{k}(B(x))\Big)\to \istrunc{k}\Big(\prd{x:A}B(x)\Big).
\end{equation*}
\end{thm}

\begin{proof}
The theorem is proven by induction on $k\geq -2$. The base case is just the weak function extensionality principle, which was shown to follow from function extensionality in \autoref{thm:funext_wkfunext}.

For the inductive hypothesis, assume that the $k$-types are closed under dependent function types. Assume that $B$ is a family of $(k+1)$-types. By function extensionality, the type $f=g$ is equivalent to $f\htpy g$ for any two dependent functions $f,g:\prd{x:A}B(x)$. Now observe that $f\htpy g$ is a dependent product of $k$-types, and therefore it is an $k$-type by our inductive hypotheses. Therefore, it follows by \autoref{thm:ktype_eqv} that $f=g$ is an $k$-type, and hence that $\prd{x:A}B(x)$ is an $(k+1)$-type.
\end{proof}

\begin{cor}\label{cor:funtype_trunc}
Suppose $B$ is a $k$-type. Then $A\to B$ is also a $k$-type, for any type $A$.
\end{cor}

The following theorem is sometimes called the \define{type theoretic principle of choice}. This terminology comes from the point of view of propositions as types, where the $\Sigma$-type has the role of the existential quantifier, and the $\Pi$-type has the role of the universal quantifier.

\begin{thm}\label{thm:choice}
Let $C(x,y)$ be a type in context $\Gamma,x:A,y:B(x)$. Then the map
\begin{equation*}
\varphi:\Big(\prd{x:A}\sm{y:B(x)}C(x,y)\Big)\to \Big(\sm{f:\prd{x:A}B(x)}\prd{x:A}C(x,f(x))\Big)
\end{equation*}
given by $\lam{h}(\lam{x}\proj 1(h(x)),\lam{x}\proj 2(h(x)))$ is an equivalence.
\end{thm}

\begin{proof}
The map $\psi$ in the converse direction is defined by
\begin{equation*}
\psi\defeq \ind{\Sigma}(\lam{f}{g}{x}(f(x),g(x))).
\end{equation*}
We need to define homotopies $\psi\circ\varphi\htpy \idfunc$ and $\varphi\circ\psi\htpy \idfunc$. 

For the first homotopy, let $h:\prd{x:A}\sm{y:B(x)}C(x,y)$. Then we have
\begin{align*}
\psi(\varphi(h)) & \jdeq \psi(\lam{x}\proj 1(h(x)),\lam{x}\proj 2(h(x))) \\
& \jdeq \lam{x}(\proj 1(h(x)),\proj 2(h(x))).
\end{align*}
Note that for each $x:A$ we have an identification
\begin{equation*}
(\proj 1(h(x)),\proj 2(h(x)))=h(x).
\end{equation*}
Therefore we obtain a \emph{homotopy} $\psi(\varphi(h))\htpy h$, but this suffices because function extensionality now provides us with an identification $\psi(\varphi(h))=h$.

The second homotopy is constructed by $\Sigma$-induction. Let $f:\prd{x:A}B(x)$ and let $g:\prd{x:A}C(x,f(x))$. 
Then we have
\begin{align*}
\varphi(\psi(f,g)) & \jdeq \varphi(\lam{x}(f(x),g(x))) \\
& \jdeq (\lam{x}f(x),\lam{x}g(x)) \\
& \jdeq (f,g)
\end{align*}
where the last judgmental equality holds by the $\eta$-rule for $\Pi$-types. In other words, the homotopy $\varphi\circ\psi\htpy \idfunc$ is given by
\begin{equation*}
\ind{\Sigma}(\lam{f}{g}\refl{(f,g)}).\qedhere
\end{equation*}
\end{proof}

\begin{cor}
For type $A$ and any type family $C$ over $B$, the map
\begin{equation*}
\Big(\sm{f:A\to B} \prd{x:A}C(f(x))\Big)\to\Big(A\to\sm{y:B}C(x)\Big)
\end{equation*}
given by $\lam{(f,g)}{x}(f(x),g(x))$ is an equivalence.
\end{cor}

\subsubsection{The Yoneda embedding}
The function extensionality principle allows us to prove \emph{universal properties}. The universal property of identity types is sometimes called the type theoretic Yoneda lemma: families of maps out of the identity type are uniquely determined by their action on the reflexivity identification.

\begin{thm}\label{thm:yoneda}
Let $B$ be a type family over $A$, and let $a:A$. Then the map
\begin{equation*}
\mathsf{ev\usc{}refl}:\Big(\prd{x:A} (a=x)\to B(x)\Big)\to B(a)
\end{equation*}
given by $\lam{f} f(a,\refl{a})$ is an equivalence. 
\end{thm}

\begin{proof}
The inverse $\varphi$ is defined by path induction, taking $b:B(a)$ to the function $f$ satisfying $f(a,\refl{a})\jdeq b$. It is immediate that $\mathsf{ev\usc{}refl}\circ\varphi\htpy \idfunc$.

To see that $\varphi\circ \mathsf{ev\usc{}refl}\htpy\idfunc$, let $f:\prd{x:A}(a=x)\to B(x)$. To show that $\varphi(f(a,\refl{a}))=f$ we use function extensionality (twice), so it suffices to show that
\begin{equation*}
\prd{x:A}{p:a=x} \varphi(f(a,\refl{a}),x,p)=f(x,p).
\end{equation*}
This follows by path induction on $p$, since $\varphi(f(a,\refl{a}),a,\refl{a})\jdeq f(a,\refl{a})$.
\end{proof}

\subsubsection{Composing with equivalences}

We show in this section that a map $f:A\to B$ is an equivalence if and only if for any type $X$ the precomposition map 
\begin{equation*}
\blank\circ f: (B\to X)\to (A\to X)
\end{equation*}
is an equivalence. Moreover, we will show in \cref{ex:equiv_precomp} that the `dependent version' of this statement also holds: a map $f:A\to B$ is an equivalence if and only if for any type family $P$ over $B$, the precomposition map
\begin{equation*}
\blank\circ f: \Big(\prd{y:B}P(y)\Big)\to\Big(\prd{x:A}P(f(x))\Big)
\end{equation*}
is an equivalence. However, in our proof of this fact we will rely on a piece of data that every equivalence satisfies in addition to being invertible.

\begin{defn}
We say that a map $f:A\to B$ is a \define{half-adjoint equivalence}\index{half-adjoint equivalence|textbf}, in the sense that there are
\begin{align*}
g & : B \to A\\
G & : f\circ g \htpy \idfunc[B] \\
H & : g\circ f \htpy \idfunc[A] \\
K & : G\cdot f \htpy f\cdot H.
\end{align*}
We write $\mathsf{half\usc{}adj}(f)$\index{half_adj(f)@{$\mathsf{half\usc{}adj}(f)$}|textbf} for the type of such quadruples $(g,G,H,K)$.
\end{defn}

To show that every equivalence is a half-adjoint equivalence, we also introduce the notion of \emph{path-split} maps, which were introduced by Rijke, Shulman, and Spitters in \cref{RSS}.

\begin{defn}
We say that a map $f:A\to B$ is \define{path-split}\index{path-split|textbf} if $f$ has a section, and for each $x,y:A$ the map
\begin{equation*}
\apfunc{f}(x,y):(x=y)\to (f(x)=f(y))
\end{equation*}
also has a section. We write $\mathsf{path\usc{}split}(f)$\index{path_split(f)@{$\mathsf{path\usc{}split}(f)$}|textbf} for the type
\begin{equation*}
\mathsf{sec}(f)\times\prd{x,y:A}\mathsf{sec}(\apfunc{f}(x,y)).
\end{equation*}
\end{defn}

\begin{thm}\label{ex:equiv_precomp}
For any map $f:A\to B$, the following are equivalent:
\begin{enumerate}
\item $f$ is an equivalence.
\item $f$ is path-split.
\item $f$ is a half-adjoint equivalence.
\item For any type family $P$ over $B$ the map
\begin{equation*}
\Big(\prd{y:B}P(y)\Big)\to\Big(\prd{x:A}P(f(x))\Big)
\end{equation*}
given by $s\mapsto s\circ f$ is an equivalence.
\item For any type $X$ the map
\begin{equation*}
(B\to X)\to (A\to X)
\end{equation*}
given by $g\mapsto g\circ f$ is an equivalence. 
\end{enumerate}
\end{thm}

\begin{proof}
To see that (i) implies (ii) we note that any equivalence has a section, and its action on paths is an equivalence by \cref{cor:emb_equiv} so again it has a section.

To show that (ii) implies (iii), assume that $f$ is path-split. Thus we have $(g,G):\mathsf{sec}(f)$, and the assumption that $\apfunc{f}:(x=y)\to (f(x)=f(y))$ has a section for every $x,y:A$ gives us a term of type
\begin{equation*}
\prd{x:A}\fib{\apfunc{f}}{G(f(x))}.
\end{equation*}
By \cref{thm:choice} this type is equivalent to
\begin{equation*}
\sm{H:\prd{x:A}g(f(x))=x}\prd{x:A}G(f(x))=\ap{f}{H(x)},
\end{equation*}
so we obtain $H:g\circ f\htpy \idfunc[A]$ and $K:G\cdot f\htpy f\cdot H$, showing that $f$ is a half-adjoint equivalence.

To show that (iii) implies (iv), suppose that $f$ comes equipped with $(g,G,H,K)$ witnessing that $f$ is a half-adjoint equivalence. Then we define the inverse of $\blank\circ f$ to be the map
\begin{equation*}
\varphi:\Big(\prd{x:A}P(f(x))\Big)\to\Big(\prd{y:B}P(y)\Big)
\end{equation*}
given by $s\mapsto \lam{y}\mathsf{tr}_P(G(y),sg(y))$. 

To see that $\varphi$ is a section of $\blank\circ f$, let $s:\prd{x:A}P(f(x))$. By function extensionality it suffices to construct a homotopy $\varphi(s)\circ f\htpy s$. In other words, we have to show that
\begin{equation*}
\mathsf{tr}_P(G(f(x)),s(g(f(x)))=s(x)
\end{equation*}
for any $x:A$. Now we use the additional homotopy $K$ from our assumption that $f$ is a half-adjoint equivalence. Since we have $K(x):G(f(x))=\ap{f}{H(x)}$ it suffices to show that
\begin{equation*}
\mathsf{tr}_P(\ap{f}{H(x)},sgf(x))=s(x).
\end{equation*}
A simple path-induction argument yields that
\begin{equation*}
\mathsf{tr}_P(\ap{f}{p})\htpy \mathsf{tr}_{P\circ f}(p)
\end{equation*}
for any path $p:x=y$ in $A$, so it suffices to construct an identification
\begin{equation*}
\mathsf{tr}_{P\circ f}(H(x),sgf(x))=s(x).
\end{equation*}
We have such an identification by $\apd{H(x)}{s}$.

To see that $\varphi$ is a retraction of $\blank\circ f$, let $s:\prd{y:B}P(y)$. By function extensionality it suffices to construct a homotopy $\varphi(s\circ f)\htpy s$. In other words, we have to show that
\begin{equation*}
\mathsf{tr}_P(G(y),sfg(y))=s(y)
\end{equation*}
for any $y:B$. We have such an identification by $\apd{G(y)}{s}$. This completes the proof that (iii) implies (iv).

Note that (v) is an immediate consequence of (iv), since we can just choose $P$ to be the constant family $X$.

It remains to show that (v) implies (i). Suppose that
\begin{equation*}
\blank\circ f:(B\to X)\to (A\to X)
\end{equation*}
is an equivalence for every type $X$. Then its fibers are contractible by \cref{thm:contr_equiv}. In particular, choosing $X\jdeq A$ we see that the fiber
\begin{equation*}
\fib{\blank\circ f}{\idfunc[A]}\jdeq \sm{h:B\to A}h\circ f=\idfunc[A]
\end{equation*}
is contractible. Thus we obtain a function $h:B\to A$ and a homotopy $H:h\circ f\htpy\idfunc[A]$ showing that $h$ is a retraction of $f$. We will show that $h$ is also a section of $f$. To see this, we use that the fiber
\begin{equation*}
\fib{\blank\circ f}{f}\jdeq \sm{i:B\to B} i\circ f=f
\end{equation*}
is contractible (choosing $X\jdeq B$). 
Of course we have $(\idfunc[B],\refl{f})$ in this fiber. However we claim that there also is an identification $p:(f\circ h)\circ f=f$, showing that $(f\circ h,p)$ is in this fiber, because
\begin{align*}
(f\circ h)\circ f & \jdeq f\circ (h\circ f) \\
& = f\circ \idfunc[A] \\
& \jdeq f
\end{align*}
Now we conclude by the contractibility of the fiber that $(\idfunc[B],\refl{f})=(f\circ h,p)$. In particular we obtain that $\idfunc[B]=f\circ h$, showing that $h$ is a section of $f$.
\end{proof}

\subsection{Homotopy pullbacks}
Suppose we are given a map $f:A\to B$, and type families $P$ over $A$, and $Q$ over $B$.
Then any fiberwise map
\begin{equation*}
g:\prd{x:A}P(x)\to Q(f(x))
\end{equation*}
gives rise to a commuting square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\sm{x:A}P(x) \arrow[r,"{\total[f]{g}}"] \arrow[d,swap,"\proj 1"] & \sm{y:B}Q(y) \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
where $\total[f]{g}$ is defined as $\lam{(x,p)}(f(x),g(x,y))$. 
We will show in \cref{thm:pb_fibequiv} that $g$ is a fiberwise equivalence\index{fiberwise equivalence} if and only if this square is a \emph{pullback square}\index{pullback square}. This generalization of \cref{thm:fib_equiv} is therefore abstracting away from the notion of fiberwise equivalence, and it serves as our motivating theorem to introduce pullbacks. The connection between pullbacks and fiberwise equivalences has an important role in the descent theorem\index{descent} in \cref{chap:descent}.

\subsubsection{Cartesian squares}

Recall that a square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"g"] & X
\end{tikzcd}
\end{equation*}
is said to \define{commute}\index{commuting square|textbf} if there is a homotopy $H:f\circ p\htpy g\circ q$. 
The pullback property is a \emph{universal property} of the upper left corner of a commuting square (in our case $C$), characterizing the maps \emph{into} it.

To describe the universal property of pullbacks we first need to have a closer look at the \emph{anatomy} of commuting squares.

\begin{defn}\label{defn:cospan}
A commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p\htpy g\circ q$ can be dissected into three parts, consisting of a \emph{cospan}, a type, and a \emph{cone}, where
\begin{enumerate}
\item A \define{cospan}\index{cospan|textbf} consists of three types $A$, $X$, and $B$, and maps $f:A\to X$ and $g:B\to X$.
\item Given a type $C$, a \define{cone}\index{cone!on a cospan|textbf} on the cospan $A \stackrel{f}{\rightarrow} X \stackrel{g}{\leftarrow} B$ with \define{vertex} $C$\index{vertex!of a cone|textbf} consists of maps $p:C\to A$, $q:C\to B$ and a homotopy $H:f\circ p\htpy g\circ q$. We write\index{cone(C)@{$\mathsf{cone}(\blank)$}|textbf}
\begin{equation*}
\mathsf{cone}(C)\defeq \sm{p:C\to A}{q:C\to B}f\circ p\htpy g\circ q
\end{equation*}
for the type of cones with vertex $C$.
\end{enumerate}
\end{defn}

Given a cone with vertex $C$ on a span $A\stackrel{f}{\rightarrow} X \stackrel{g}{\leftarrow} B$ and a map $h:C'\to C$, we construct a new cone with vertex $C'$ in the following definition.

\begin{defn}
For any cone $(p,q,H)$ with vertex $C$ and any type $C'$, we define a map\index{cone map@{$\mathsf{cone\usc{}map}$}|textbf}
\begin{equation*}
\mathsf{cone\usc{}map}(p,q,H):(C'\to C)\to\mathsf{cone}(C')
\end{equation*}
by $h\mapsto (p\circ h,q\circ h,H\circ h)$. 
\end{defn}

\begin{defn}
We say that a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p\htpy g\circ q$ is a \define{pullback square}\index{pullback square|textbf}, or that it is \define{cartesian}\index{cartesian square|textbf}, if it satisfies the \define{universal property} of pullbacks\index{universal property!of pullbacks}, which asserts that the map
\begin{equation*}
\mathsf{cone\usc{}map}(p,q,H):(C'\to C)\to\mathsf{cone}(C')
\end{equation*}
is an equivalence for every type $C'$. 
\end{defn}

We often indicate the universal property with a diagram as follows:
\begin{equation*}
\begin{tikzcd}
C' \arrow[drr,bend left=15,"{q'}"] \arrow[dr,densely dotted,"h"] \arrow[ddr,bend right=15,swap,"{p'}"] \\
& C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
& A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
since the universal property states that for every cone $(p',q',H')$ with vertex $C'$, the type of pairs $(h,\alpha)$ consisting of $h:C'\to C$ equipped with $\alpha:\mathsf{cone\usc{}map}((p,q,H),h)=(p',q',H')$ is contractible by \cref{thm:contr_equiv}.

In order to see what goes on in the universal property of pullbacks, we need to first characterize the identity type of $\mathsf{cone}(C)$, for any type $C$.

\begin{lem}\label{lem:id_cone}%
\index{identity type!of cone@{of $\mathsf{cone}(C)$}|textit}%
Let $(p,q,H)$ and $(p',q',H')$ be cones on a cospan $f:A\rightarrow X \leftarrow B:g$, both with vertex $C$. Then the type $(p,q,H)=(p',q',H')$ is equivalent to the type of triples $(K,L,M)$ consisting of
\begin{align*}
K & : p \htpy p' \\
L & : q \htpy q' \\
M & : \ct{H}{(g\cdot L)} \htpy \ct{(f\cdot K)}{H'}
\end{align*}
\end{lem}

\begin{rmk}
The homotopy $M$ witnesses that the square
\begin{equation*}
\begin{tikzcd}
f\circ p \arrow[r,"f\cdot K"] \arrow[d,swap,"H"] & f\circ p' \arrow[d,"{H'}"] \\
g\circ q \arrow[r,swap,"g\cdot L"] & g\circ q'
\end{tikzcd}
\end{equation*}
of homotopies commutes. Therefore $M$ is a homotopy of homotopies, and for each $z:C$ the identification $M(z)$ witnesses that the square of identifications
\begin{equation*}
\begin{tikzcd}[column sep=huge]
f(p(z)) \arrow[r,equals,"\ap{f}{K(z)}"] \arrow[d,equals,swap,"H(z)"] & f(p'(z)) \arrow[d,equals,"{H'(z)}"] \\
g(q(z)) \arrow[r,equals,swap,"\ap{g}{L(z)}"] & g(q'(z))
\end{tikzcd}
\end{equation*}
commutes. 
\end{rmk}

\begin{proof}[Proof of \cref{lem:id_cone}]
By the fundamental theorem of identity types (\cref{thm:id_fundamental}) and associativity of $\Sigma$-types (\cref{ex:sigma_assoc}) it suffices to show that the type
\begin{equation*}
\sm{p':C\to A}{q':C\to B}{H':f\circ p'\htpy g\circ q'}{K:p\htpy p'}{L:q\htpy q'} \ct{H}{(g\cdot L)} \htpy \ct{(f\cdot K)}{H'}
\end{equation*}
is contractible. Now we apply \cref{ex:sigma_swap} repeatedly to see that this type is equivalent to the type
\begin{equation*}
\sm{p':C\to A}{K: p\htpy p'}{q':C\to B}{L: q\htpy q'}{H':f\circ p'\htpy g\circ q'} \ct{H}{(g\cdot L)} \htpy \ct{(f\cdot K)}{H'}.
\end{equation*}
The types $\sm{p':C\to A} p\htpy p'$ and $\sm{q':C\to B} q\htpy q'$ are contractible by function extensionality, and  we have
\begin{samepage}
\begin{align*}
(p,\mathsf{htpy.refl}_p) & : \sm{p':C'\to A} p\htpy p' \\
(q,\mathsf{htpy.refl}_q) & : \sm{q':C'\to B} q\htpy q'.
\end{align*}%
\end{samepage}%
Thus we apply \cref{ex:contr_in_sigma} to see that the type of tuples $(p',K,q',L,H',M)$ is equivalent to the type
\begin{equation*}
\sm{H':f\circ p'\htpy g\circ q'} \ct{H}{\mathsf{htpy.refl}_{g\circ q}}\htpy \ct{\mathsf{htpy.refl}_{f\circ p}}{H'}.
\end{equation*}
Of course, the type $\ct{H}{\mathsf{htpy.refl}_{g\circ q}}\htpy \ct{\mathsf{htpy.refl}_{f\circ p}}{H'}$ is equivalent to the type $H\htpy H'$, and $\sm{H':f\circ p\htpy g\circ q} H\htpy H'$ is contractible.
\end{proof}

As a corollary we obtain the following characterization of the universal property of pullbacks.

\begin{thm}\label{thm:pullback_up}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p\htpy g\circ q$
Then the following are equivalent:\index{universal property!of pullbacks (characterization)|textit}
\begin{enumerate}
\item The square is a pullback square.
\item For every type $C'$ and every cone $(p',q',H')$ with vertex $C'$, the type of quadruples $(h,K,L,M)$ consisting of
\begin{align*}
h & : C'\to C \\
K & : p\circ h \htpy p' \\
L & : q\circ h \htpy q' \\
M & : \ct{(H\cdot h)}{(g\cdot L)} \htpy \ct{(f\cdot K)}{H'}
\end{align*}
is contractible.
\end{enumerate}
\end{thm}

\begin{rmk}
The homotopy $M$ in \cref{thm:pullback_up} witnesses that the square
\begin{equation*}
\begin{tikzcd}
f\circ p\circ h \arrow[r,"f\cdot K"] \arrow[d,swap,"H\cdot h"] & f\circ p' \arrow[d,"{H'}"] \\
g\circ q\circ h \arrow[r,swap,"g\cdot L"] & g\circ q'
\end{tikzcd}
\end{equation*}
of homotopies commutes.
\end{rmk}

\subsubsection{The unique existence of pullbacks}

\begin{defn}
Let $f:A\to X$ and $B\to X$ be maps. Then we define
\begin{align*}
A\times_X B & \defeq \sm{x:A}{y:B}f(x)=g(y) \\
\pi_1 & \defeq \proj 1 & & : A\times_X B\to A \\
\pi_2 & \defeq \proj 1\circ\proj 2 & & : A\times_X B\to B\\
\pi_3 & \defeq \proj 2\circ\proj 2 & & : f\circ \pi_1 \htpy g\circ\pi_2.
\end{align*}
The type $A\times_X B$ is called the \define{canonical pullback}\index{canonical pullback|textbf} of $f$ and $g$.
\end{defn}

Note that $A\times_X B$ depends on $f$ and $g$, although this dependency is not visible in the notation.

\begin{thm}
Given maps $f:A\to X$ and $g:B\to X$, the commuting square\index{canonical pullback|textit}
\begin{equation*}
\begin{tikzcd}
A\times_X B \arrow[r,"\pi_2"] \arrow[d,swap,"\pi_1"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X,
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{thm}

\begin{proof}
Let $C$ be a type. Our goal is to show that the map
\begin{equation*}
\mathsf{cone\usc{}map}(\pi_1,\pi_2,\pi_3): (C\to A\times_X B)\to \mathsf{cone}(C)
\end{equation*}
is an equivalence. 
By double application of \cref{thm:choice} we obtain equivalences
\begin{align*}
(C\to A\times_X B) & \jdeq C\to \sm{x:A}{y:B}f(x)=g(y) \\
& \eqvsym \sm{p:C\to A}\prd{z:C}\sm{y:B} f(p(z))= y \\
& \eqvsym \sm{p:C\to A}{q:C\to B}\prd{z:C} f(p(z))= g(q(z)) \\
& \jdeq \mathsf{cone}(C)
\end{align*}
The composite of these equivalences is the map
\begin{equation*}
\lam{f}(\lam{z}\proj 1(f(z)),\lam{z} \proj 1(\proj 2(f(z))),\lam{z}\proj 2(\proj 2(f(z)))),
\end{equation*}
which is \emph{exactly} the map $\mathsf{cone\usc{}map}(\pi_1,\pi_2,\pi_3)$, and since it is a composite of equivalences it follows that it is itself an equivalence.
\end{proof}

In the following lemma we establish the uniqueness of pullbacks up to equivalence via a \emph{3-for-2 property} for pullbacks.

\begin{lem}\label{lem:pb_3for2}\index{pullback!3-for-2 property|textit}\index{3-for-2 property!of pullbacks|textit}%
Consider the squares
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] & {C'} \arrow[r,"{q'}"] \arrow[d,swap,"{p'}"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X & A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with homotopies $H:f\circ p \htpy g\circ q$ and $H':f\circ p'\htpy g\circ q'$.
Furthermore, suppose we have a map $h:C'\to C$ equipped with
\begin{align*}
K & : p\circ h \htpy p' \\
L & : q\circ h \htpy q' \\
M & : \ct{(H\cdot h)}{(g\cdot L)} \htpy \ct{(f\cdot K)}{H'}.
\end{align*}
If any two of the following three properties hold, so does the third:
\begin{samepage}%
\begin{enumerate}
\item $C$ is a pullback.
\item $C'$ is a pullback.
\item $h$ is an equivalence.
\end{enumerate}%
\end{samepage}%
\end{lem}

\begin{proof}
By the characterization of the identity type of $\mathsf{cone}(C')$ given in \cref{lem:id_cone} we obtain an identification
\begin{equation*}
\mathsf{cone\usc{}map}((p,q,H),h)=(p',q',H')
\end{equation*}
from the triple $(K,L,M)$. 
Let $D$ be a type, and let $k:D\to C'$ be a map. We observe that
\begin{align*}
\mathsf{cone\usc{}map}((p,q,H),(h\circ k)) & \jdeq (p\circ (h\circ k),q\circ (h\circ k),H\circ (h\circ k)) \\
& \jdeq ((p\circ h)\circ k,(q\circ h)\circ k, (H\circ h)\circ k) \\
& \jdeq \mathsf{cone\usc{}map}(\mathsf{cone\usc{}map}((p,q,H),h),k) \\
& = \mathsf{cone\usc{}map}((p',q',H'),k).
\end{align*}
Thus we see that the triangle 
\begin{equation*}
\begin{tikzcd}[column sep=-1em]
(D\to C') \arrow[rr,"{h\circ \blank}"] \arrow[dr,swap,"{\mathsf{cone\usc{}map}(p',q',H')}"] & & (D\to C) \arrow[dl,"{\mathsf{cone\usc{}map}(p,q,H)}"] \\
& \mathsf{cone}(D)
\end{tikzcd}
\end{equation*}
commutes. Therefore it follows from the 3-for-2 property of equivalences established in \cref{ex:3_for_2}, that if any two of the following properties hold, then so does the third:
\begin{enumerate}
\item The map $\mathsf{cone\usc{}map}(p,q,H):(D\to C)\to \mathsf{cone}(D)$ is an equivalence,
\item The map $\mathsf{cone\usc{}map}(p',q',H'):(D\to C')\to \mathsf{cone}(D)$ is an equivalence,
\item The map $h\circ\blank : (D\to C')\to (D\to C)$ is an equivalence.
\end{enumerate}
Thus the 3-for-2 property for pullbacks follows from the fact that $h$ is an equivalence if and only if $h\circ\blank : (D\to C')\to (D\to C)$ is an equivalence for any type $D$, which was established in \cref{lem:postcomp_equiv}.
\end{proof}

Pullbacks are not only unique in the sense that any two pullbacks of the same cospan are equivalent, they are \emph{uniquely unique}\index{uniquely uniqueness!of pullbacks} in the sense that the type of quadruples $(h,K,L,M)$ as in \cref{lem:pb_3for2} is contractible.

\begin{cor}
Suppose both commuting squares
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] & {C'} \arrow[r,"{q'}"] \arrow[d,swap,"{p'}"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X & A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with homotopies $H:f\circ p \htpy g\circ q$ and $H':f\circ p'\htpy g\circ q'$ are pullback squares.
Then the type of quadruples $(e,K,L,M)$ consisting of an equivalence $e:\eqv{C'}{C}$ equipped with
\begin{align*}
K & : p\circ e \htpy p' \\
L & : q\circ e \htpy q' \\
M & : \ct{(g\cdot L)}{(H\cdot e)} \htpy \ct{(f\cdot K)}{H'}.
\end{align*}
is contractible.
\end{cor}

\begin{proof}
We have seen that the type of quadruples $(h,K,L,M)$ is equivalent to the fiber of $\mathsf{cone\usc{}map}(p,q,H)$ at $(p',q',H')$. By \cref{lem:pb_3for2} it follows that $h$ is an equivalence. Since $\isequiv(h)$ is a proposition (and hence contractible as soon as it is inhabited) it follows that the type of quadruples $(e,K,L,M)$ is contractible. 
\end{proof}

\begin{defn}
Given a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p \htpy g \circ q$, we define the \define{gap map}\index{gap map|textbf}\index{pullback!gap map|textbf}
\begin{equation*}
\mathsf{gap}(p,q,H):C \to A\times_X B
\end{equation*}
by $\lam{z}(p(z),q(z),H(z))$. Furthermore, we will write\index{is_pullback@{$\mathsf{is\usc{}pullback}$}|textbf}
\begin{equation*}
\mathsf{is\usc{}pullback}(f,g,H)\defeq \isequiv(\mathsf{gap}(p,q,H)).
\end{equation*}
\end{defn}

\begin{thm}\label{thm:is_pullback}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p \htpy g \circ q$. The following are equivalent:
\begin{enumerate}
\item The square is a pullback square
\item There is a term of type
\begin{equation*}
\mathsf{is\usc{}pullback}(p,q,H)\defeq \isequiv(\mathsf{gap}(p,q,H)).
\end{equation*}
\end{enumerate}
\end{thm}

\begin{proof}
Note that there are homotopies
\begin{align*}
K & : \pi_1\circ \mathsf{gap}(p,q,H) \htpy p \\
L & : \pi_2\circ \mathsf{gap}(p,q,H) \htpy q \\
M & : \ct{(\pi_3\cdot \mathsf{gap}(p,q,H))}{(g\cdot L)} \htpy \ct{(f\cdot K)}{H}.
\end{align*}
given by 
\begin{align*}
K & \defeq \lam{z}\refl{p(z)} \\
L & \defeq \lam{z}\refl{q(z)} \\
M & \defeq \lam{z}\ct{\mathsf{right\usc{}unit}(H(z))}{\mathsf{left\usc{}unit}(H(z))^{-1}}.
\end{align*}
Therefore the claim follows by \cref{lem:pb_3for2}.
\end{proof}

\subsubsection{Fiberwise equivalences}

\begin{lem}\label{lem:pb_subst}
Let $f:A\to B$, and let $Q$ be a type family over $B$. Then the square
\begin{equation*}
\begin{tikzcd}[column sep=6em]
\sm{x:A}Q(f(x)) \arrow[r,"{\lam{(x,q)}(f(x),q)}"] \arrow[d,swap,"\proj 1"] & \sm{y:B}Q(b) \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
commutes by $H\defeq \lam{(x,q)}\refl{f(x)}$. This is a pullback square.\index{substitution!as pullback|textit}
\end{lem}

\begin{proof}
By \cref{thm:is_pullback} it suffices to show that the gap map is an equivalence. The gap map is homotopic to the function
\begin{equation*}
\lam{(x,q)}(x,(f(x),q),\refl{f(x)}).
\end{equation*}
The inverse of this map is given by $\lam{(x,((y,q),p))}(x,\mathsf{tr}_Q(p^{-1},q))$, and it is straightforward to see that these maps are indeed mutual inverses.
\end{proof}

\begin{thm}\label{thm:pb_fibequiv}
Let $f:A\to B$, and let $g:\prd{a:A}P(a)\to Q(f(a))$ be a fiberwise transformation\index{fiberwise transformation|textit}. The following are equivalent:
\begin{enumerate}
\item The commuting square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\sm{a:A}P(a) \arrow[r,"{\total[f]{g}}"] \arrow[d,->>] & \sm{b:B}Q(b) \arrow[d,->>] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square.
\item $g$ is a fiberwise equivalence.\index{fiberwise equivalence|textit}
\end{enumerate}
\end{thm}

\begin{proof}
The gap map is homotopic to the composite
\begin{equation*}
\begin{tikzcd}[column sep=large]
\sm{x:A}P(x) \arrow[r,"\total{g}"] & \sm{x:A}Q(f(x)) \arrow[r,"{\mathsf{gap}'}"] & A \times_B \Big(\sm{y:B}Q(y)\Big)
\end{tikzcd}
\end{equation*}
where $\mathsf{gap}'$ is the gap map for the square in \cref{lem:pb_subst}. Since $\mathsf{gap}'$ is an equivalence, it follows by \cref{ex:3_for_2,thm:fib_equiv} that the gap map is an equivalence if and only if $g$ is a fiberwise equivalence.
\end{proof}

\begin{lem}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p\htpy g\circ q$, and consider the fiberwise transformation
\begin{equation*}
\fibf{(f,q,H)} : \prd{a:A} \fib{p}{a}\to \fib{g}{f(a)}
\end{equation*}
given by $\lam{a}{(c,u)}(q(c),\ct{H(c)^{-1}}{\ap{f}{u}})$. Then there is an equivalence
\begin{equation*}
\eqv{\fib{\mathsf{gap}(p,q,H)}{(a,b,\alpha)}}{\fib{\fibf{(f,q,H)}(a)}{(b,\alpha^{-1})}}
\end{equation*}
\end{lem}

\begin{proof}
To obtain an equivalence of the desired type we simply concatenate known equivalences:
\begin{align*}
\fib{h}{(a,b,\alpha)} & \jdeq \sm{z:C} (p(z),q(z),H(z))=(a,b,\alpha) \\
& \eqvsym \sm{z:C}{u:p(z)=a}{v:q(z)=b}\ct{H(z)}{\ap{g}{v}}=\ct{\ap{f}{u}}{\alpha} \\
& \eqvsym \sm{(z,u):\fib{p}{a}}{v:q(z)=b} \ct{H(z)^{-1}}{\ap{f}{u}}=\ct{\ap{g}{v}}{\alpha^{-1}} \\
& \eqvsym \fib{\varphi(a)}{(b,\alpha^{-1})}\qedhere
\end{align*}
\end{proof}

\begin{cor}\label{cor:pb_fibequiv}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X
\end{tikzcd}
\end{equation*}
with $H:f\circ p\htpy g\circ q$. The following are equivalent:
\begin{enumerate}
\item The square is a pullback square.\index{pullback square!characterized by fiberwise equivalence|textit}
\item The induced map on fibers
\begin{equation*}
\lam{x}{(z,\alpha)}(q(z),\ct{H(z)^{-1}}{\ap{f}{\alpha}}):\prd{x:A}\fib{p}{x}\to \fib{g}{f(x)}
\end{equation*}
is a fiberwise equivalence.
\end{enumerate}
\end{cor}

\begin{cor}\label{cor:pb_trunc}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X.
\end{tikzcd}
\end{equation*}
If $g$ is a $k$-truncated map, then so is $p$. In particular, if $g$ is an embedding then so is $p$.\index{truncated!map!pullbacks of truncated maps|textit}\index{embedding!pullbacks of embeddings|textit}
\end{cor}

\begin{proof}
Since the square is assumed to be a pullback square, it follows from \cref{cor:pb_fibequiv} that for each $x:A$, the fiber $\fib{p}{x}$ is equivalent to the fiber $\fib{g}{f(x)}$, which is $k$-truncated. Since $k$-truncated types are closed under equivalences by \cref{thm:ktype_eqv}, it follows that $p$ is a $k$-truncated map.
\end{proof}

\begin{cor}\label{cor:pb_equiv}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
C \arrow[r,"q"] \arrow[d,swap,"p"] & B \arrow[d,"g"] \\
A \arrow[r,swap,"f"] & X.
\end{tikzcd}
\end{equation*}
and suppose that $g$ is an equivalence. Then the following are equivalent:
\begin{enumerate}
\item The square is a pullback square.
\item The map $p:C\to A$ is an equivalence.\index{equivalence!pullback of|textit}
\end{enumerate}
\end{cor}

\begin{proof}
If the square is a pullback square, then by \cref{thm:pb_fibequiv} the fibers of $p$ are equivalent to the fibers of $g$, which are contractible by \cref{thm:contr_equiv}. Thus it follows that $p$ is a contractible map, and hence that $p$ is an equivalence.

If $p$ is an equivalence, then by \cref{thm:contr_equiv} both $\fib{p}{x}$ and $\fib{g}{f(x)}$ are contractible for any $x:X$. It follows by \cref{ex:contr_equiv} that the induced map $\fib{p}{x}\to\fib{g}{f(x)}$ is an equivalence. Thus we apply \cref{cor:pb_fibequiv} to conclude that the square is a pullback.
\end{proof}

\begin{thm}\label{thm:pb_fibequiv_complete}
Consider a diagram of the form
\begin{equation*}
\begin{tikzcd}
A \arrow[d,swap,"f"] & B \arrow[d,"g"] \\
X \arrow[r,swap,"h"] & Y.
\end{tikzcd}
\end{equation*}
Then the type of triples $(i,H,p)$ consisting of a map $i:A\to B$, a homotopy $H:h\circ f\htpy g\circ i$, and a term $p$ witnessing that the square
\begin{equation*}
\begin{tikzcd}
A \arrow[d,swap,"f"] \arrow[r,"i"] & B \arrow[d,"g"] \\
X \arrow[r,swap,"h"] & Y.
\end{tikzcd}
\end{equation*}
is a pullback square, is equivalent to the type of fiberwise equivalences
\begin{equation*}
\prd{x:X}\eqv{\fib{f}{x}}{\fib{g}{h(x)}}.
\end{equation*}
\end{thm}

\begin{cor}\label{cor:pb_fibequiv_complete}
Let $h:X\to Y$ be a map, and let $P$ and $Q$ be families over $X$ and $Y$, respectively.
Then the type of triples $(i,H,p)$ consisting of a map 
\begin{equation*}
i:\Big(\sm{x:X}P(x)\Big)\to \Big(\sm{y:Y}Q(y)\Big),
\end{equation*}
a homotopy $H:h\circ \proj 1\htpy \proj 1\circ i$, and a term $p$ witnessing that the square
\begin{equation*}
\begin{tikzcd}
\sm{x:X}P(x) \arrow[d,swap,"\proj 1"] \arrow[r,"i"] & \sm{y:Y}Q(y) \arrow[d,"\proj 1"] \\
X \arrow[r,swap,"h"] & Y.
\end{tikzcd}
\end{equation*}
is a pullback square, is equivalent to the type of fiberwise equivalences
\begin{equation*}
\prd{x:X}\eqv{P(x)}{Q(h(x))}.
\end{equation*}
\end{cor}

\subsubsection{The pullback pasting property}

The following theorem is also called the \define{pasting property} of pullbacks.\index{pasting property!of pullbacks|textit}

\begin{thm}\label{thm:pb_pasting}
Consider a commuting diagram of the form
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"k"] \arrow[d,swap,"f"] & B \arrow[r,"l"] \arrow[d,"g"] & C \arrow[d,"h"] \\
X \arrow[r,swap,"i"] & Y \arrow[r,swap,"j"] & Z
\end{tikzcd}
\end{equation*}
with homotopies $H:i\circ f\htpy g\circ k$ and $K:j\circ g\htpy h\circ l$, and the homotopy
\begin{equation*}
\ct{(j\cdot H)}{(K\cdot k)}:j\circ i\circ f\htpy h\circ l\circ k
\end{equation*}
witnessing that the outer rectangle commutes. Furthermore, suppose that the square on the right is a pullback square. Then the following are equivalent:
\begin{samepage}%
\begin{enumerate}
\item The square on the left is a pullback square.
\item The outer rectangle is a pullback square.
\end{enumerate}%
\end{samepage}%
\end{thm}

\begin{proof}
The commutativity of the two squares induces fiberwise transformations
\begin{align*}
& \prd{x:X}\fib{f}{x}\to \fib{g}{i(x)} \\
& \prd{y:Y}\fib{g}{y}\to \fib{h}{j(y)}.
\end{align*}
By the assumption that the square on the right is a pullback square, it follows from \cref{cor:pb_fibequiv} that the fiberwise transformation
\begin{equation*}
\prd{y:Y}\fib{g}{y}\to\fib{h}{j(y)}
\end{equation*}
is a fiberwise equivalence. Therefore it follows from 3-for-2 property of equivalences that the fiberwise transformation
\begin{equation*}
\prd{x:X}\fib{f}{x}\to\fib{g}{i(x)}
\end{equation*}
is a fiberwise equivalence if and only if the fiberwise transformation
\begin{equation*}
\prd{x:X}\fib{f}{x}\to\fib{h}{j(i(x))}
\end{equation*}
is a fiberwise equivalence. Now the claim follows from one more application of \cref{cor:pb_fibequiv}.
\end{proof}

\subsubsection{Fibers of squares}

\begin{thm}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
A \arrow[d,swap,"f"] \arrow[r,"i"] & B \arrow[d,"g"] \\
X \arrow[r,swap,"j"] & Y
\end{tikzcd}
\end{equation*}
with homotopy $H:j\circ f\htpy g\circ i$, and let $h:A \to X\times_Y B$ be the gap map.
Then the commuting square
\begin{equation*}
\begin{tikzcd}
\fib{h}{(x,b,p)} \arrow[d] \arrow[r] & \unit \arrow[d] \\
\fib{f}{x} \arrow[r] & \fib{g}{j(x)}
\end{tikzcd}
\end{equation*}
is a pullback square. We call $\fib{h}{(x,b,p)}$ the \define{fiber} of the square.
\end{thm}

\subsection{The univalence axiom}

The univalence axiom characterizes the identity type of the universe. Roughly speaking, it asserts that equivalent types are equal. It is considered to be an \emph{extensionality principle}\index{extensionality principle!types} for types. In the following theorem we introduce the univalence axiom and give two more equivalent ways of stating this.

\begin{thm}\label{thm:univalence}
The following are equivalent:
\begin{enumerate}
\item The \define{univalence axiom}\index{univalence axiom|textbf}: for any $A:\UU$ the map\index{equiv_eq@{$\equiveq$}|textbf}
\begin{equation*}
\equiveq\defeq \ind{A=}(\idfunc[A]) : \prd{B:\UU} (\id{A}{B})\to(\eqv{A}{B}).
\end{equation*}
is a fiberwise equivalence.\index{identity type!universe} If this is the case, we write
$\eqequiv$\index{eq equiv@{$\eqequiv$}|textbf}
for the inverse of $\equiveq$.
\item The type
\begin{equation*}
\sm{B:\UU}\eqv{A}{B}
\end{equation*}
is contractible for each $A:\UU$.
\item The principle of \define{equivalence induction}\index{equivalence induction}\index{induction principle!for equivalences}: for every $A:\UU$ and for every type family
\begin{equation*}
P:\prd{B:\UU} (\eqv{A}{B})\to \type,
\end{equation*}
the map
\begin{equation*}
\Big(\prd{B:\UU}{e:\eqv{A}{B}}P(B,e)\Big)\to P(A,\idfunc[A])
\end{equation*}
given by $f\mapsto f(A,\idfunc[A])$ has a section.
\end{enumerate}
\end{thm}

\begin{proof}
The equivalence of (i) and (ii) is a direct consequence of \cref{thm:id_fundamental}. 
To see that (ii) and (iii) are equivalent, note that we have a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=-1em]
\prd{t:\sm{B:\UU}\eqv{A}{B}}P(t) \arrow[rr,"\ind{\Sigma}"] \arrow[dr,"\varphi","{f\mapsto f((A,\idfunc[A]))}"'] & & \prd{B:\UU}{e:\eqv{A}{B}} P((B,e)) \arrow[dl,"{f\mapsto f(A,\idfunc[A])}","\psi"'] \\
& P((A,\idfunc[A]))
\end{tikzcd}
\end{equation*}
The map $\ind{\Sigma}$ has a section. Therefore it follows from \cref{ex:3_for_2} that $\varphi$ has a section if and only if $\psi$ has a section. By \cref{thm:contractible} it follows that $\varphi$ has a section if and only if $\sm{B:\UU}\eqv{A}{B}$ is contractible. 
\end{proof}

From now on we will assume that the univalence axiom holds. Our first application of the univalence axiom is to show that the identity type $\idtypevar{A}:A\to (A\to\UU)$ is an embedding. 

\begin{thm}
Assuming the univalence axiom on $\UU$, the map
\begin{equation*}
\idtypevar{A}:A\to (A\to\UU)
\end{equation*}
is an embedding, for any type $A:\UU$.\index{identity type!is an embedding|textit}
\end{thm}

\begin{proof}
Let $a:A$. By function extensionality it suffices to show that the canonical map
\begin{equation*}
(a=b)\to \idtypevar{A}(a)\htpy\idtypevar{A}(b)
\end{equation*}
that sends $\refl{a}$ to $\lam{x}\refl{(a=x)}$ is an equivalence for every $b:A$, and by univalence it therefore suffices to show that the canonical map
\begin{equation*}
(a=b)\to \prd{x:A}\eqv{(a=x)}{(b=x)}
\end{equation*}
that sends $\refl{a}$ to $\lam{x}\idfunc[(a=x)]$ is an equivalence for every $b:B$. To do this we employ the type theoretic Yoneda lemma, \autoref{thm:yoneda}.

By the type theoretic Yoneda lemma\index{Yoneda lemma} we have an equivalence
\begin{equation*}
\Big(\prd{x:A} (b=x)\to (a=x)\Big)\to (a=b)
\end{equation*}
given by $\lam{f} f(b,\refl{b})$, for every $b:A$. Note that any fiberwise map $\prd{x:A}(b=x)\to (a=x)$ induces an equivalence of total spaces by \autoref{ex:contr_equiv}, since their total spaces are are both contractible by \autoref{cor:contr_path}. It follows that we have an equivalence
\begin{equation*}
\varphi_b:\Big(\prd{x:A} \eqv{(b=x)}{(a=x)}\Big)\to (a=b)
\end{equation*}
given by $\lam{f} f(b,\refl{b})$, for every $b:A$. 

Note that $\varphi_a(\lam{x}\idfunc[(a=x)])\jdeq\refl{a}$. Therefore it follows by another application of \autoref{thm:yoneda} that the unique family of maps 
\begin{equation*}
\alpha_b:(a=b)\to \Big(\prd{x:A} \eqv{(b=x)}{(a=x)}\Big)
\end{equation*}
that satisfies $\alpha_a(\refl{a})=\lam{x}\idfunc[(a=x)]$ is a fiberwise section of $\varphi$. 
It follows that $\alpha$ is a fiberwise equivalence. Now the proof is completed by reverting the direction of the fiberwise equivalences in the codomain.
\end{proof}

It is a trivial observation, but nevertheless of fundamental importance, that by the univalence axiom the identity types of $\UU$ are equivalent to types in $\UU$, because it provides an equivalence $\eqv{(A=B)}{(\eqv{A}{B})}$, and the type $\eqv{A}{B}$ is in $\UU$ for any $A,B:\UU$. Since the identity types of $\UU$ are equivalent to types in $\UU$, we also say that the universe is \emph{locally small}.

\begin{defn}
\begin{enumerate}
\item A type $A$ is said to be \define{essentially small}\index{essentially small!type|textbf} if there is a type $X:\UU$ and an equivalence $\eqv{A}{X}$. We write\index{ess_small(A)@{$\esssmall(A)$}|textbf}
\begin{equation*}
\esssmall(A)\defeq\sm{X:\UU}\eqv{A}{X}.
\end{equation*}
\item A map $f:A\to B$ is said to be \define{essentially small}\index{essentially small!map|textbf} if for each $b:B$ the fiber $\fib{f}{b}$ is essentially small.
We write\index{ess_small(f)@{$\esssmall(f)$}|textbf}
\begin{equation*}
\esssmall(f)\defeq\prd{b:B}\esssmall(\fib{f}{b}).
\end{equation*}
\item A type $A$ is said to be \define{locally small}\index{locally small!type} if for every $x,y:A$ the identity type $x=y$ is essentially small.
We write\index{loc_small(A)@{$\locsmall(A)$}|textbf}
\begin{equation*}
\locsmall(A)\defeq \prd{x,y:A}\esssmall(x=y).
\end{equation*}
\end{enumerate}
\end{defn}

\begin{lem}\label{lem:isprop_ess_small}
The type $\esssmall(A)$ is a proposition for any type $A$.\index{essentially small!is a proposition|textit}
\end{lem}

\begin{proof}
Let $X$ be a type. Our goal is to show that the type
\begin{equation*}
\sm{Y:\UU}\eqv{X}{Y}
\end{equation*}
is a proposition. Suppose there is a type $X':\UU$ and an equivalence $e:\eqv{X}{X'}$, then the map
\begin{equation*}
(\eqv{X}{Y})\to (\eqv{X'}{Y})
\end{equation*}
given by precomposing with $e^{-1}$ is an equivalence. This induces an equivalence on total spaces
\begin{equation*}
\eqv{\Big(\sm{Y:\UU}\eqv{X}{Y}\Big)}{\Big(\sm{Y:\UU}\eqv{X'}{Y}\Big)}
\end{equation*}
However, the codomain of this equivalence is contractible by \cref{thm:univalence}. Thus it follows by \cref{cor:contr_prop} that the asserted type is a proposition.
\end{proof}

\begin{cor}
For each function $f:A\to B$, the type $\esssmall(f)$ is a proposition, and for each type $X$ the type $\locsmall(X)$ is a proposition.
\end{cor}

\begin{proof}
This follows from the fact that propositions are closed under dependent products, established in \cref{thm:trunc_pi}.
\end{proof}

\begin{thm}\label{thm:fam_proj}
For any small type $A:\UU$ there is an equivalence
\begin{equation*}
\eqv{(A\to \UU)}{\Big(\sm{X:\UU} X\to A\Big)}.
\end{equation*}
\end{thm}

\begin{proof}
Note that we have the function
\begin{equation*}
\varphi :\lam{B} \Big(\sm{x:A}B(x),\proj 1\Big) : (A\to \UU)\to \Big(\sm{X:\UU}X\to A\Big).
\end{equation*}
The fiber of this map at $(X,f)$ is by univalence and function extensionality equivalent to the type
\begin{equation*}
\sm{B:A\to \UU}{e:\eqv{(\sm{x:A}B(x))}{X}} \proj 1\htpy f\circ e.
\end{equation*}
By \cref{ex:triangle_fib} this type is equivalent to the type
\begin{equation*}
\sm{B:A\to \UU}\prd{a:A} \eqv{B(a)}{\fib{f}{a}},
\end{equation*}
and by `type theoretic choice', which was established in \cref{thm:choice}, this type is equivalent to
\begin{equation*}
\prd{a:A}\sm{X:\UU}\eqv{X}{\fib{f}{a}}.
\end{equation*}
We conclude that the fiber of $\varphi$ at $(X,f)$ is equivalent to the type $\esssmall(f)$. However, since $f:X\to A$ is a map between small types it is essentially small. Moreover, since being essentially small is a proposition by \cref{lem:isprop_ess_small}, it follows that $\fib{\varphi}{(X,f)}$ is contractible for every $f:X\to A$. In other words, $\varphi$ is a contractible map, and therefore it is an equivalence.
\end{proof}

\begin{rmk}
The inverse of the map
\begin{equation*}
\varphi : (A\to \UU)\to \Big(\sm{X:\UU}X\to A\Big).
\end{equation*}
constructed in \cref{thm:fam_proj} is the map $(X,f)\mapsto \fibf{f}$.
\end{rmk}

\begin{thm}\label{thm:classifier}
Let $f:A\to B$ be a map. Then there is an equivalence
\begin{equation*}
\eqv{\esssmall(f)}{\isclassified(f)},
\end{equation*}
where $\isclassified(f)$\index{is_classified(f)@{$\isclassified(f)$}|textbf} is the type of quadruples $(F,\tilde{F},H,p)$ consisting of maps
$F:B\to \UU$ and $\tilde{F}:A\to \sm{X:\UU}X$, a homotopy $H:F\circ f\htpy \proj 1\circ \tilde{F}$,  such that the commuting square
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"\tilde{F}"] \arrow[d,swap,"f"] & \sm{X:\UU}X \arrow[d,"\proj 1"] \\
B \arrow[r,swap,"F"] & \UU
\end{tikzcd}
\end{equation*}
is a pullback square, as witnessed by $p$\footnote{The universal property of the pullback is not expressible by a type. However, we may take the type of $p:\isequiv(h)$, where $h:A\to B\times_\UU\big(\sm{X:\UU}X\big)$ is the map obtained by the universal property of the canonical pullback.}. If $f$ comes equipped with a term of type $\isclassified(f)$, we also say that $f$ is \define{classified}\index{classified by the universal family|textbf} by the universal family. 
\end{thm}

\begin{proof}
From \cref{ex:sq_fib} we obtain that the type of pairs $(\tilde{F},H)$ is equivalent to the type of fiberwise transformations
\begin{equation*}
\prd{b:B}\fib{f}{b}\to F(b).
\end{equation*}
By \cref{cor:pb_fibequiv} the square is a pullback square if and only if the induced map
\begin{equation*}
\prd{b:B}\fib{f}{b}\to F(b)
\end{equation*}
is a fiberwise equivalence. Thus the data $(F,\tilde{F},H,pb)$ is equivalent to the type of pairs $(F,e)$ where $e$ is a fiberwise equivalence from $\fibf{f}$ to $F$. By \cref{thm:choice} the type of pairs $(F,e)$ is equivalent to the type $\esssmall(f)$. 
\end{proof}

\begin{rmk}
For any type $A$ (not necessarily small), and any $B:A\to \UU$, the square\index{Sigma-type@{$\Sigma$-type}!as pullback of universal family|textit}
\begin{equation*}
\begin{tikzcd}[column sep=6em]
\sm{x:A}B(x) \arrow[d,swap,"\proj 1"] \arrow[r,"{\lam{(x,y)}(B(x),y)}"] & \sm{X:\UU}X \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"B"] & \UU
\end{tikzcd}
\end{equation*}
is a pullback square. Therefore it follows that for any family $B:A\to\UU$ of small types, the projection map $\proj 1:\sm{x:A}B(x)\to A$ is an essentially small map.
To see that the claim is a direct consequence of \cref{lem:pb_subst} we write the asserted square in its rudimentary form:
\begin{equation*}
%\begin{gathered}[b]
\begin{tikzcd}[column sep=6em]
\sm{x:A}\mathrm{El}(B(x)) \arrow[d,swap,"\proj 1"] \arrow[r,"{\lam{(x,y)}(B(x),y)}"] & \sm{X:\UU}\mathrm{El}(X) \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"B"] & \UU.
\end{tikzcd}%\\[-\dp\strutbox]\end{gathered}\qedhere
\end{equation*}
\end{rmk}

In the following theorem we show that a type is small if and only if its diagonal is classified by $\UU$.

\begin{thm}
Let $A$ be a type. The following are equivalent:
\begin{enumerate}
\item $A$ is locally small.\index{locally small|textit}
\item There are maps $I:A\times A\to\UU$ and $\tilde{I}:A\to\sm{X:\UU}X$, and a homotopy $H:I\circ \delta_A\htpy \proj 1\circ\tilde{I}$
such that the commuting square
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"\tilde{I}"] \arrow[d,swap,"\delta_A"] & \sm{X:\UU}X \arrow[d,"\proj 1"] \\
A\times A \arrow[r,swap,"{I}"] & \UU
\end{tikzcd}
\end{equation*}
is a pullback square.\index{diagonal!of a type|textit}
\end{enumerate}
\end{thm}

\begin{proof}
In \cref{ex:diagonal} we have established that the identity type $x=y$ is the fiber of $\delta_A$ at $(x,y):A\times A$. Therefore it follows that $A$ is locally small if and only if the diagonal $\delta_A$ is essentially small.
Now the result follows from \cref{thm:classifier}.
\end{proof}

\subsubsection{Move from RPn to here}
Since the theorem is a statement about pointed $2$\nobreakdash-element sets, 
we will invoke the following general lemma which computes equality of pointed types.

\begin{lem}\label{lem:equiv_of_ptdtype}
For any $A,B:\UU$ and any $a:A$ and $b:B$, we have an equivalence of type
\begin{equation*}
\eqv{\Big(\pairr{A,a}=\pairr{B,b}\Big)}{\Big(\sm{e:\eqv{A}{B}}e(a)=b\Big)}.
\end{equation*}
\end{lem}

\begin{proof}[Construction]
By Theorem 2.7.2 of \cite{hottbook}, the type on the left hand side is
equivalent to the type $\sm{p:A=B}\tr_{\universalfam}({p},{a})=b$.
By the univalence axiom, the map 
\begin{equation*}
\equiveq_{A,B}:(A=B)\to (\eqv{A}{B})
\end{equation*}
is an equivalence for each $B:\UU$. 
Therefore, we have an equivalence of type
\begin{equation*}
\eqv{\Big(\sm{p:A=B}\tr_{\universalfam}({p},{a})=b\Big)}{\Big(\sm{e:\eqv{A}{B}}\tr_{\universalfam}({\eqequiv(e)},{a})=b\Big)}
\end{equation*} 
Moreover, by equivalence induction (the analogue of path induction for 
equivalences), we can compute the transport:
\begin{equation*}
\tr_{\universalfam}({\eqequiv(e)},{a})=e(a).
\end{equation*}
It follows that $\eqv{(\tr_{\universalfam}({\eqequiv(e)},{a})=b)}
{(e(a)=b)}$.
\end{proof}

Furthermore, we will invoke the following general lemma which computes equality of pointed
equivalences.

\begin{lem}\label{lem:equiv_of_ptdequiv}
For any $\pairr{e,p},\pairr{f,q}:\sm{e:\eqv{A}{B}}e(a)=b$, we have an equivalence of type
\begin{equation*}
\eqv{\Big(\pairr{e,p}=\pairr{f,q}\Big)}{\Big(\sm{h:e\htpy f} p=\ct{h(a)}{q}\Big)}.
\end{equation*}
\end{lem}

\begin{proof}[Construction]
The type $\pairr{e,p}=\pairr{f,q}$ is equivalent
to the type $\sm{h:e=f}\tr({h},{p})=q$.
Note that by the principle of function extensionality,
the map $\htpyeq:(e=f)\to(e\htpy f)$
is an equivalence. Furthermore, it follows by homotopy induction that for any 
$h:e\htpy f$ we have an equivalence of type
\begin{equation*}
\eqv{(\tr({\eqhtpy(h)},{p})=q)}
    {(p= \ct{h(a)}{q})}.\qedhere
\end{equation*}
\end{proof}

\section{Higher inductive types}
\subsection{Homotopy pushouts}

\subsubsection{Pushouts as higher inductive types}

The idea of pushouts is to glue two types $A$ and $B$ together using a mediating type $S$ and maps $f:S\to A$ and $g:S\to B$. In other words, we start with a diagram of the form
\begin{equation*}
\begin{tikzcd}
A & S \arrow[l,swap,"f"] \arrow[r,"g"] & B.
\end{tikzcd}
\end{equation*}
We call such a triple $\mathcal{S}\jdeq (S,f,g)$ a \define{span}\index{span} from $A$ to $B$.
A span from $A$ to $B$ can be thought of as a relation\index{relation} from $A$ to $B$, relating $f(x)$ to $g(x)$ for any $x:S$.
Indeed, an equivalence between the type of all spans and the type of relations from $A$ to $B$ is established in \cref{ex:span_rel}.

Given a span $\mathcal{S}$ from $A$ to $B$, we form the higher inductive type $A \sqcup^{\mathcal{S}} B$. It comes equipped with the following constructors\index{inl@{$\inl$}!for pushouts}\index{inr@{$\inr$}!for pushouts}\index{glue@{$\glue$}}
\begin{align*}
\inl & : A \to A \sqcup^{\mathcal{S}} B \\
\inr & : B \to A \sqcup^{\mathcal{S}} B \\
\glue & : \prd{x:S} \inl(f(x))=\inr(g(x))
\end{align*}
and we require that it satisfies an induction principle and computation rules.

To see what the induction principle has to be, consider first a dependent function $s:\prd{x:A\sqcup^{\mathcal{S}}B}P(x)$. When we evaluate this function at the constructors, we obtain
\begin{align*}
s\circ \inl & : \prd{a:A} P(\inl(a)) \\
s\circ \inr & : \prd{b:B} P(\inr(b)) \\
\apdfunc{s}\circ \glue & : \prd{x:S} \mathsf{tr}_P(\glue(x),s(f(x)))=s(g(x)).
\end{align*}

\begin{defn}
Consider a span $\mathcal{S}\jdeq (S,f,g)$ from $A$ to $B$, and let $P$ be a family over $A\sqcup^{\mathcal{S}} B$. The \define{dependent action on generators}\index{dependent action on generators!for pushouts|textbf} is defined to be the map\index{dgen_S@{$\mathsf{dgen}_{\mathcal{S}}$}|textbf}
\begin{align*}
\mathsf{dgen}_{\mathcal{S}}^P & : \Big(\prd{x:A\sqcup^{\mathcal{S}} B} P(x)\Big) \to \Big(\sm{f': \prd{a:A}P(\inl(a))}{g':\prd{b:B}P(\inr(b))}\Big.\\
& \qquad\qquad\qquad\qquad\qquad\qquad \Big.\prd{x:S} \mathsf{tr}_P(\glue(x),f'(f(x)))=g'(g(x))\Big).
\end{align*}
given by $s\mapsto (s\circ\inl,s\circ\inr,\apdfunc{s}\circ\glue)$.
\end{defn}

We can now fully specify homotopy pushouts.

\begin{defn}
Given a span $\mathcal{S}\jdeq (S,f,g)$, the \define{(homotopy) pushout}\index{pushout|textbf} $A\sqcup^{\mathcal{S}} B$ of $\mathcal{S}$ is defined to be the higher inductive\index{higher inductive types} type equipped with\index{inl@{$\inl$}!for pushouts|textbf}\index{inr@{$\inr$}!for pushouts|textbf}\index{glue@{$\glue$}|textbf}
\begin{align*}
\inl & : A \to A \sqcup^{\mathcal{S}} B \\
\inr & : B \to A \sqcup^{\mathcal{S}} B \\
\glue & : \prd{x:S} \inl(f(x))=\inr(g(x)),
\end{align*}
satisfying the \define{induction principle} for pushouts\index{induction principle!for pushouts|textbf}, which asserts that for each type family $P$ over $A\sqcup^{\mathcal{S}} B$ the map $\mathsf{dgen}_{\mathcal{S}}^P$ has a section.
\end{defn}

\begin{rmk}
The induction principle of the pushout $A\sqcup^{\mathcal{S}} B$ provides us with a dependent function
\begin{equation*}
\ind{\mathcal{S}}(f',g',G) : \prd{x:A\sqcup^{\mathcal{S}} B} P(x),
\end{equation*}
for every
\begin{align*}
f' & : \prd{a:A}P(\inl(a)) \\
g' & : \prd{b:B}P(\inr(b)) \\
G & : \prd{x:S} \mathsf{tr}_P(\glue(x),f'(f(x)))=g'(g(x))
\end{align*}
Moreover, the function $\ind{\mathcal{S}}(f',g',G)$ comes equipped with an identification
\begin{equation*}
\mathsf{dgen}_{\mathcal{S}}(\ind{\mathcal{S}}(f',g',G))=(f',g',G).
\end{equation*}
Writing $s\defeq \ind{\mathcal{S}}(f',g',G)$, we see that such an identification between triples is equivalently described by a triple $(H,K,L)$ consisting of
\begin{align*}
H : s\circ \inl \htpy f' \\
K : s\circ\inr \htpy g' 
\end{align*}
and a homotopy $L$ witnessing that the square
\begin{equation*}
\begin{tikzcd}[column sep=8em]
\mathsf{tr}_{P}(\glue(x),s(\inl(f(x)))) \arrow[r,equals,"\ap{\mathsf{tr}_P(\glue(x))}{H(x)}"] \arrow[d,equals,swap,"\apd{s}{\glue(x)}"] & \mathsf{tr}_{P}(\glue(x),f'(f(x))) \arrow[d,equals,"G(x)"] \\
s(\inr(g(x))) \arrow[r,equals,swap,"K(x)"] & g'(g(x))
\end{tikzcd}
\end{equation*}
commutes, for every $x:S$. These are the \define{computation rules} for pushouts\index{computation rules!for pushouts}.
\end{rmk}

\begin{comment}
The \define{formation rule} for pushouts simply states that for any span $\mathcal{S}\defeq (S,f,g)$ from $A$ to $B$, a type $A\sqcup^{\mathcal{S}} B$ can be formed. We call $A\sqcup^{\mathcal{S}} B$ the \define{canonical pushout} of $\mathcal{S}$. 

\begin{prooftree}
\AxiomC{$\Gamma\vdash f:S\to A$}
\AxiomC{$\Gamma\vdash g:S\to B$}
\BinaryInfC{$\Gamma\vdash A\sqcup^{\mathcal{S}} B~\mathrm{type}$}
\end{prooftree}

The \define{introduction rules} for pushouts provide ways to construct terms of the type $A\sqcup^{\mathcal{S}} B$, and ways to identify some of those.
\begin{prooftree}
\AxiomC{$\Gamma\vdash f:S\to A$}
\AxiomC{$\Gamma\vdash g:S\to B$}
\BinaryInfC{$\Gamma\vdash \inl : A \to A\sqcup^{\mathcal{S}} B$}
\end{prooftree}

\begin{prooftree}
\AxiomC{$\Gamma\vdash f:S\to A$}
\AxiomC{$\Gamma\vdash g:S\to B$}
\BinaryInfC{$\Gamma\vdash \inr : B \to A\sqcup^{\mathcal{S}} B$}
\end{prooftree}

\begin{prooftree}
\AxiomC{$\Gamma\vdash f:S\to A$}
\AxiomC{$\Gamma\vdash g:S\to B$}
\BinaryInfC{$\Gamma\vdash \glue : \inl\circ f \htpy \inr\circ g$}
\end{prooftree}
We assume that $A\sqcup^{\mathcal{S}} B$ is span inductive in the sense of \autoref{thm:pushout_up}. Moreover, if $A$, $B$, and $S$ are types in $\UU$, then we assume that also $A\sqcup^{\mathcal{S}} B$ is in $\UU$. In other words, we assume that the universe is \emph{closed under pushouts}.
\end{comment}

\subsubsection{Examples of pushouts}
Many interesting types can be defined as homotopy pushouts. 

\begin{defn}
Let $X$ be a type. We define the \define{suspension}\index{suspension|textbf} $\susp X$\index{SX@{$\susp X$}|textbf} of $X$ to be the pushout of the span
\begin{equation*}
\begin{tikzcd}
X \arrow[r] \arrow[d] & \unit \arrow[d,"\inr"] \\
\unit \arrow[r,swap,"\inl"] & \susp X 
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{defn}
We define the \define{$n$-sphere}\index{n-sphere@{$n$-sphere}|textbf} $\sphere{n}$\index{Sn@{$\sphere{n}$}|textbf} for any $n:\N$ by induction on $n$, by taking
\begin{align*}
\sphere{0} & \defeq \bool \\
\sphere{n+1} & \defeq \susp{\sphere{n}}.
\end{align*}
\end{defn}

\begin{defn}
Given a map $f:A\to B$, we define the \define{cofiber}\index{cofiber|textbf} $\mathsf{cofib}_f$\index{cofib_f@{$\mathsf{cofib}_f$}|textbf} of $f$ as the pushout
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"f"] \arrow[d] & B \arrow[d,"\inr"] \\
\unit \arrow[r,swap,"\inl"] & \mathsf{cofib}_f. 
\end{tikzcd}
\end{equation*}
The cofiber of a map is sometimes also called the \define{mapping cone}\index{mapping cone|textbf}.
\end{defn}

\begin{eg}
The suspension $\susp X$ of $X$ is the cofiber of the map $X\to \unit$.\index{suspension!as cofiber} 
\end{eg}

\begin{defn}
We define the \define{join}\index{join} $\join{X}{Y}$\index{join X Y@{$\join{X}{Y}$}|textbf} of $X$ and $Y$ to be the pushout 
\begin{equation*}
\begin{tikzcd}
X\times Y \arrow[r,"\proj 2"] \arrow[d,swap,"\proj 1"] & Y \arrow[d,"\inr"] \\
X \arrow[r,swap,"\inl"] & X \ast Y. 
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{defn}
Suppose $A$ and $B$ are pointed types, with base points $a_0$ and $b_0$, respectively. The \define{(binary) wedge}\index{wedge@(binary) wedge|textbf} $A\vee B$ of $A$ and $B$ is defined as the pushout
\begin{equation*}
\begin{tikzcd}
\bool \arrow[r] \arrow[d] & A+B \arrow[d] \\
\unit \arrow[r] & A\vee B.
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{defn}
Given a type $I$, and a family of pointed types $A$ over $i$, with base points $a_0(i)$. We define the \define{(indexed) wedge}\index{wedge@{(indexed) wedge}|textbf} $\bigvee_{(i:I)}A_i$ as the pushout
\begin{equation*}
\begin{tikzcd}[column sep=huge]
I \arrow[d] \arrow[r,"{\lam{i}(i,a_0(i))}"] & \sm{i:I}A_i \arrow[d] \\
\unit \arrow[r] & \bigvee_{(i:I)} A_i.
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{comment}
\begin{defn}
Let $X$ and $Y$ be types with base points $x_0$ and $y_0$, respectively.
We define the \define{wedge} $X\lor Y$ of $X$ and $Y$ to be the pushout
\begin{equation*}
\begin{tikzcd}[column sep=8em]
\bool \arrow[r,"{\ind{\bool}(\inl(x_0),\inr(y_0))}"] \arrow[d,swap,"\mathsf{const}_\ttt"] & X+Y \arrow[d,"\inr"] \\
\unit \arrow[r,swap,"\inl"] & X\lor Y
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{defn}
Let $X$ and $Y$ be types with base points $x_0$ and $y_0$, respectively.
We define a map
\begin{equation*}
\mathsf{wedge\usc{}incl} : X \lor Y \to X\times Y.
\end{equation*}
as the unique map obtained from the commutative square
\begin{equation*}
\begin{tikzcd}[column sep=8em]
\bool \arrow[r,"{\ind{\bool}(\inl(x_0),\inr(y_0))}"] \arrow[d,swap,"\mathsf{const}_\ttt"] & X+Y \arrow[d,"{\ind{X+Y}(\lam{x}\pairr{x,y_0},\lam{y}\pairr{x_0,y})}"] \\
\unit \arrow[r,swap,"\lam{t}\pairr{x_0,y_0}"] & X\times Y.
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{defn}
We define the \define{smash product} $X\wedge Y$ of $X$ and $Y$ to be the pushout
\begin{equation*}
\begin{tikzcd}[column sep=huge]
X\lor Y \arrow[r,"\mathsf{wedge\usc{}incl}"] \arrow[d,swap,"\mathsf{const}_\ttt"] & X\times Y \arrow[d,"\inr"] \\
\unit \arrow[r,swap,"\inl"] & X\wedge Y.
\end{tikzcd}
\end{equation*}
\end{defn}
\end{comment}

\subsubsection{The universal property of pushouts}

\begin{defn}
Consider a span $\mathcal{S}\jdeq (S,f,g)$ from $A$ to $B$, and let $X$ be a type.
A \define{cocone}\index{cocone|textbf} with vertex $X$ on $\mathcal{S}$ is a triple $(i,j,H)$ consisting of maps $i:A\to X$ and $j:B\to X$, and a homotopy $H:i\circ f\htpy j\circ g$ witnessing that the square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X
\end{tikzcd}
\end{equation*}
commutes.
We write $\mathsf{cocone}_{\mathcal{S}}(X)$\index{cocone_S(X)@{$\mathsf{cocone}_{\mathcal{S}}(X)$}|textbf} for the type of cocones on $\mathcal{S}$ with vertex $X$.
\end{defn}

\begin{defn}
Consider a cocone $(i,j,H)$ with vertex $X$ on the span $\mathcal{S}\jdeq (S,f,g)$, as indicated in the following commuting square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
For every type $Y$, we define the map\index{cocone_map@{$\mathsf{cocone\usc{}map}$}|textbf}
\begin{equation*}
\mathsf{cocone\usc{}map}(i,j,H):(X\to Y)\to \mathsf{cocone}(Y)
\end{equation*}
by $f\mapsto (f\circ i,f\circ j,f\cdot H)$.
\end{defn}

\begin{defn}
A commuting square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
with $H:i\circ f \htpy j\circ g$ is said to be a \define{(homotopy) pushout square}\index{pushout square} if the cocone $(i,j,H)$ with vertex $X$ on the span $\mathcal{S}\jdeq (S,f,g)$
satisfies the \define{universal property of pushouts}\index{universal property!of pushouts|textbf}, which asserts that the map
\begin{equation*}
\mathsf{cocone\usc{}map}(i,j,H):(X\to Y)\to \mathsf{cocone}(Y)
\end{equation*}
is an equivalence for any type $Y$. Sometimes pushout squares are also called \define{cocartesian squares}\index{cocartesian square|textbf}.
\end{defn}

\begin{comment}
\begin{rmk}
Given a pushout square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X,
\end{tikzcd}
\end{equation*}
we can view the cocone $(i,j,H)$ as \emph{structure} on $X$, in the sense that $X$ comes equipped with
\begin{align*}
i & : A\to X \\
j & : B\to X \\
H & : \prd{s:S} i(f(s))=j(g(s)).
\end{align*}
As we will see in \cref{thm:pushout_up}, the type $X$ is a pushout precisely when it satisfies an \emph{induction principle} formulated in terms of $(i,j,H)$. However, the homotopy $H$ provides \emph{path constructors} of $X$. 

The induction principle of pushouts is formulated with respect to families $P$ over $X$, and provides a way to construct sections of $P$. Note that from any section $s:\prd{x:X}P(x)$ we obtain
\begin{align*}
s\circ i & : \prd{a:A}P(i(a)) \\
s\circ j & : \prd{b:B}P(j(b)) \\
s\cdot H & : \prd{x:S}\mathsf{tr}_P(H(x),s(i(x)))=s(j(x)).
\end{align*}
It will be useful to write
\begin{equation*}
i' \htpy_H j' \defeq \prd{s:S} \mathsf{tr}_P(H(s),i'(f(s)))=j'(g(s))
\end{equation*}
for the type of $s\cdot H$. Thus we see that there is a map
\begin{equation*}
\Big(\prd{x:X}P(x)\Big)\to \sm{i':\prd{a:A}P(i(a))}{j':\prd{b:B}P(j(b))} i'\htpy_H j'
\end{equation*}
given by $s\mapsto (s\circ i,s\circ j,s\cdot H)$.
\end{rmk}
\end{comment}

\begin{lem}\label{lem:cocone_pb}
For any span $\mathcal{S}\jdeq (S,f,g)$ from $A$ to $B$, and any type $X$ the square\index{cocone_S(X)@{$\mathsf{cocone}_{\mathcal{S}}(X)$}!as a pullback|textit}
\begin{equation*}
\begin{tikzcd}
\mathsf{cocone}_{\mathcal{S}}(X) \arrow[r,"\pi_2"] \arrow[d,swap,"\pi_1"] & X^B \arrow[d,"\blank\circ g"] \\
X^A \arrow[r,swap,"\blank\circ f"] & X^S,
\end{tikzcd}
\end{equation*}
which commutes by the homotopy $\pi_3' \defeq\lam{(i,j,H)} \mathsf{eq\usc{}htpy}(H)$, is a pullback square.
\end{lem}

\begin{proof}
The gap map $\mathsf{cocone}_{\mathcal{S}}(X)\to X^A\times_{X^S} X^B$ is the function 
\begin{equation*}
\lam{(i,j,H)}(i,j,\mathsf{eq\usc{}htpy}(H)).
\end{equation*}
This is an equivalence by \cref{thm:fib_equiv}, since it is the induced map on total spaces of the fiberwise equivalence $\mathsf{eq\usc{}htpy}$. Therefore, the square is a pullback square by \cref{thm:is_pullback}.
\end{proof}

In the following theorem we establish an alternative characterization of the universal property of pushouts.
\begin{thm}\label{thm:pushout_up}
Consider a commuting square\index{universal property!of pushouts|textit}
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X,
\end{tikzcd}
\end{equation*}
with $H:i\circ f\htpy j\circ g$. The following are equivalent:
\begin{enumerate}
\item The square is a pushout square.
\item The square
\begin{equation*}
\begin{tikzcd}
T^X \arrow[r,"\blank\circ j"] \arrow[d,swap,"\blank\circ i"] & T^B \arrow[d,"\blank\circ g"] \\
T^A \arrow[r,swap,"\blank\circ f"] & T^S
\end{tikzcd}
\end{equation*}
which commutes by the homotopy
\begin{equation*}
\lam{h} \mathsf{eq\usc{}htpy}(h\cdot H)
\end{equation*}
is a pullback square, for every type $T$.
%\item The type $X$ satisfies \define{span induction} for the span $A\leftarrow S \rightarrow B$, in the sense that for any type family $P$ over $X$, the map
%\begin{equation*}
%\Big(\prd{x:X}P(x)\Big)\to \Big(\sm{i':\prd{a:A}P(i(a))}{j':\prd{b:B}P(j(b))} i'\htpy_H j'\Big)
%\end{equation*}
%given by $s\mapsto (s\circ i,s\circ j,s\cdot H)$ has a section.
\end{enumerate}
\end{thm}

\begin{proof}
It is straightforward to verify that the triangle
\begin{equation*}
\begin{tikzcd}
& T^X \arrow[dl,swap,"{\mathsf{cocone\usc{}map}(i,j,H)}"] \arrow[dr,"{\mathsf{gap}(\blank\circ i,\blank\circ j, \mathsf{eq\usc{}htpy}(\blank\cdot H))}"] \\
\mathsf{cocone}(T) \arrow[rr,swap,"{\mathsf{gap}(i,j,\mathsf{eq\usc{}htpy}(H))}"] & & T^A \times_{T^S} T^B
\end{tikzcd}
\end{equation*}
commutes. Since the bottom map is an equivalence by \cref{lem:cocone_pb}, it follows that if either one of the remaining maps is an equivalence, so is the other. The claim now follows by \cref{thm:is_pullback}.
\end{proof}

\begin{eg}\label{eg:circle_pushout}
By \autoref{ex:circle_up_pushout} and the second characterization of pushouts in \autoref{thm:pushout_up} it follows that the circle is a pushout\index{circle!S1 equiv susp 2@{$\eqv{\sphere{1}}{\susp\bool}$}|textit}
\begin{equation*}
\begin{tikzcd}
\bool \arrow[r] \arrow[d] & \unit \arrow[d] \\
\unit \arrow[r] & \sphere{1}.
\end{tikzcd}
\end{equation*}
In other words, $\eqv{\sphere{1}}{\susp{\bool}}$. 
\end{eg}

\begin{thm}\label{thm:pushout}
Consider a span $\mathcal{S}\jdeq (S,f,g)$ from $A$ to $B$. Then the square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"\inr"] \\
A \arrow[r,swap,"\inl"] & A \sqcup^{\mathcal{S}} B
\end{tikzcd}
\end{equation*}
is a pushout square.\index{pushout!universal property|textit}
\end{thm}

\begin{proof}
Let $X$ be a type. Our goal is to show that the map
\begin{equation*}
\mathsf{cocone\usc{}map}(\inl,\inr,\glue):(A\sqcup^{\mathcal{S}} B \to X)\to \mathsf{cocone}_{\mathcal{S}}(X)
\end{equation*}
is an equivalence. For notational breveity we will just write $\mathsf{gen}_{\mathcal{S}}$\index{gen_S@{$\mathsf{gen}_{\mathcal{S}}$}} for $\mathsf{cocone\usc{}map}_{\mathcal{S}}(\inl,\inr,\glue)$, because $\mathsf{cocone\usc{}map}_{\mathcal{S}}(\inl,\inr,\glue)$ is just the action on generators.

We first note that by \cref{ex:trans_triv} there is a commuting triangle
\begin{equation*}
\begin{tikzcd}[column sep=0]
& X^{A\sqcup^{\mathcal{S}} B} \arrow[dl,swap,"\mathsf{gen}_{\mathcal{S}}"] \arrow[dr,"\mathsf{dgen}_{\mathcal{S}}"] \\
\mathsf{cocone}_{\mathcal{S}}(X) \arrow[rr,"\eqvsym"] & & \mathsf{cocone}'_{\mathcal{S}}(X)
\end{tikzcd}
\end{equation*}
where we write
\begin{align*}
\mathsf{cocone}'_{\mathcal{S}}(X) & : \Big(\sm{f': A\to X}{g':A\to X}\Big.\\
& \qquad\qquad\Big.\prd{x:S} \mathsf{tr}_{W_{A\sqcup^{\mathcal{S}}B}(X)}(\glue(x),f'(f(x)))=g'(g(x))\Big).
\end{align*}
By the induction principle for $A\sqcup^{\mathcal{S}} B$ we have a section $\ind{\mathcal{S}}$ of $\mathsf{dgen}_{\mathcal{S}}$. Thus we obtain a section $\rec{\mathcal{S}}$ of $\mathsf{gen}_{\mathcal{S}}$. Our goal is now to show that $\rec{\mathcal{S}}$ is also a retraction of $\mathsf{gen}_{\mathcal{S}}$. We establish in \cref{lem:pushout_up_htpy} that
\begin{equation*}
(\mathsf{gen}_{\mathcal{S}}(\rec{\mathcal{S}}(\mathsf{gen}_{\mathcal{S}}(h)))= \mathsf{gen}_{\mathcal{S}}(h))
\to (\rec{\mathcal{S}}(\mathsf{gen}_{\mathcal{S}}(h))= h)
\end{equation*}
Then we obtain that $\rec{\mathcal{S}}$ is a retraction of $\mathsf{gen}_{\mathcal{S}}$ by using this implication and the fact that $\rec{\mathcal{S}}$ is a section of $\mathsf{gen}_{\mathsf{S}}$.
\end{proof}

\begin{lem}\label{lem:pushout_up_htpy}
Let $h,h':A\sqcup^{\mathcal{S}}B\to X$ be two functions. Then we have
\begin{equation*}
(\mathsf{gen}_{\mathcal{S}}(h)=\mathsf{gen}_{\mathcal{S}}(h'))\to (h=h').
\end{equation*}
\end{lem}

\begin{proof}
Suppose we have $\mathsf{gen}_{\mathcal{S}}(h)=\mathsf{gen}_{\mathcal{S}}(h')$. This type of equalities between triples is equivalent to the type of triples $(K,L,M)$ consisting of
\begin{align*}
K & : h\circ \inl \htpy h'\circ \inl \\
L & : h\circ \inr \htpy h'\circ \inr,
\end{align*}
and a homotopy $M$ witnessing that the square 
\begin{equation*}
\begin{tikzcd}
h\circ \inl\circ f \arrow[r,"{K\cdot f}"] \arrow[d,swap,"{h\cdot\glue}"] & h'\circ\inl\circ f \arrow[d,"{h'\cdot\glue}"] \\
h\circ \inr\circ f \arrow[r,swap,"{L\cdot g}"] & h'\circ\inr\circ g
\end{tikzcd}
\end{equation*}
of homotopies commutes. By function extensionality, our goal is equivalent to constructing a homotopy (i.e.~a dependent function) of type
\begin{equation*}
\prd{t:A\sqcup^{\mathcal{S}} B} f(t)=g(t).
\end{equation*}
We will construct such a function by the induction principle for $A\sqcup^{\mathcal{S}} B$. Therefore it suffices to construct
\begin{align*}
K & : h\circ \inl \htpy h'\circ \inl \\
L & : h\circ \inr \htpy h'\circ \inr \\
M' & : \mathsf{tr}_{E_{h,h'}}(\glue,K)=L
\end{align*}
The type of $M'$ is equivalent to the type of $M$, so we obtain the requested structure from our assumptions.
\end{proof}

\begin{comment}
\begin{cor}
Consider two commuting squares
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] & S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"{j'}"] \\
A \arrow[r,swap,"i"] & X & A \arrow[r,swap,"{i'}"] & {X'}
\end{tikzcd}
\end{equation*}
with homotopies $H:i\circ f\htpy j\circ g$ and $H':i'\circ f\htpy j'\circ g$. Furthermore, consider a map
\begin{equation*}
h:X\to X'
\end{equation*}
equipped with
\begin{align*}
K & : h\circ i\htpy i' \\
L & : h\circ j\htpy j' \\
M & : \ct{(h\cdot H)}{(L\cdot g)} \htpy \ct{(K\cdot f)}{H'}.
\end{align*}
If any two of the following three properties hold, then so does the third:
\begin{enumerate}
\item $X$ is a pushout.
\item $X'$ is a pushout.
\item $h$ is an equivalence.
\end{enumerate}
\end{cor}
\end{comment}

As a basic application we establish the universal property of suspensions.
\begin{cor}
Let $X$ and $Y$ be types. Then the map\index{universal property!of suspensions|textit}
\begin{equation*}
(\susp{X}\to Y)\to \sm{y,y':Y} X\to (y=y')
\end{equation*}
given by $f\mapsto (f(\inl(\ttt)),f(\inr(\ttt)),\ap{f}{\glue(\blank)})$ is an equivalence.
\end{cor}

\begin{proof}
We have equivalences
\begin{align*}
(\susp{X}\to Y) & \eqvsym \sm{y,y':\unit \to Y} X\to (y(\ttt)=y'(\ttt)) \\
& \eqvsym \sm{y,y':Y} X\to (y=y').\qedhere
\end{align*}
\end{proof}

\subsubsection{The pasting property for pushouts}
\begin{thm}\label{thm:pushout_pasting}
Consider the following configuration of commuting squares:\index{pushout!pasting property|textit}\index{pasting property!for pushouts|textit}
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"i"] \arrow[d,swap,"f"] & B \arrow[r,"k"] \arrow[d,swap,"g"] & C \arrow[d,"h"] \\
X \arrow[r,swap,"j"] & Y \arrow[r,swap,"l"] & Z
\end{tikzcd}
\end{equation*}
with homotopies $H:j\circ f\htpy g\circ i$ and $K:l\circ g\htpy h\circ k$, and suppose that the square on the left is a pushout square. 
Then the square on the right is a pushout square if and only if the outer rectangle is a pushout square.
\end{thm}

\begin{proof}
Let $T$ be a type. Taking the exponent $T^{(\blank)}$ of the entire diagram of the statement of the theorem, we obtain the following commuting diagram
\begin{equation*}
\begin{tikzcd}
T^Z \arrow[r,"\blank\circ l"] \arrow[d,swap,"\blank\circ h"] & T^Y \arrow[d,swap,"\blank\circ g"] \arrow[r,"\blank\circ j"] & T^X \arrow[d,"\blank\circ f"] \\
T^C \arrow[r,swap,"\blank\circ k"] & T^B \arrow[r,swap,"\blank\circ i"] & T^A.
\end{tikzcd}
\end{equation*}
By the assumption that $Y$ is the pushout of $B\leftarrow A \rightarrow X$, it follows that the square on the right is a pullback square. It follows by \autoref{thm:pb_pasting} that the rectangle on the left is a pullback if and only if the outer rectangle is a pullback. Thus the statement follows by the second characterization in \autoref{thm:pushout_up}.
\end{proof}

\begin{lem}
Consider a map $f:A\to B$. Then the cofiber of the map $\inr:B\to \mathsf{cofib}_f$ is equivalent to the suspension $\susp{A}$ of $A$. 
\end{lem}

\subsection{Sequential colimits}

\subsubsection{The universal property of sequential colimits}

Type sequences are diagrams of the following form.
\begin{equation*}
\begin{tikzcd}
A_0 \arrow[r,"f_0"] & A_1 \arrow[r,"f_1"] & A_2 \arrow[r,"f_2"] & \cdots.
\end{tikzcd}
\end{equation*}
Their formal specification is as follows.

\begin{defn}
An \define{(increasing) type sequence} $\mathcal{A}$ consists of
\begin{align*}
A & : \N\to\UU \\
f & : \prd{n:\N} A_n\to A_{n+1}. 
\end{align*}
\end{defn}

In this section we will introduce the sequential colimit of a type sequence.
The sequential colimit includes each of the types $A_n$, but we also identify each $x:A_n$ with its value $f_n(x):A_{n+1}$. 
Imagine that the type sequence $A_0\to A_1\to A_2\to\cdots$ defines a big telescope, with $A_0$ sliding into $A_1$, which slides into $A_2$, and so forth.

As usual, the sequential colimit is characterized by its universal property.

\begin{defn}
\begin{enumerate}
\item A \define{(sequential) cocone} on a type sequence $\mathcal{A}$ with vertex $B$ consists of
\begin{align*}
h & : \prd{n:\N} A_n\to B \\
H & : \prd{n:\N} f_n\htpy f_{n+1}\circ H_n.
\end{align*}
We write $\mathsf{cocone}(B)$ for the type of cones with vertex $X$.
\item Given a cone $(h,H)$ with vertex $B$ on a type sequence $\mathcal{A}$ we define the map
\begin{equation*}
\mathsf{cocone\usc{}map}(h,H) : (B\to C)\to \mathsf{cocone}(B)
\end{equation*}
given by $f\mapsto (f\circ h,\lam{n}{x}\mathsf{ap}_f(H_n(x)))$. 
\item We say that a cone $(h,H)$ with vertex $B$ is \define{colimiting} if $\mathsf{cocone\usc{}map}(h,H)$ is an equivalence for any type $C$. 
\end{enumerate}
\end{defn}

\begin{thm}\label{thm:sequential_up}
Consider a cocone $(h,H)$ with vertex $B$ for a type sequence $\mathcal{A}$. The following are equivalent:
\begin{enumerate}
\item The cocone $(h,H)$ is colimiting.
\item The cocone $(h,H)$ is inductive in the sense that for every type family $P:B\to \UU$, the map
\begin{align*}
\Big(\prd{b:B}P(b)\Big)\to {}& \sm{h:\prd{n:\N}{x:A_n}P(h_n(x))}\\ 
& \qquad \prd{n:\N}{x:A_n} \mathsf{tr}_P(H_n(x),h_n(x))={h_{n+1}(f_n(x))}
\end{align*}
given by
\begin{equation*}
s\mapsto (\lam{n}s\circ h_n,\lam{n}{x} \mathsf{apd}_{s}(H_n(x)))
\end{equation*}
has a section.
\item The map in (ii) is an equivalence.
\end{enumerate}
\end{thm}

\subsubsection{The construction of sequential colimits}

We construct sequential colimits using pushouts.

\begin{defn}
Let $\mathcal{A}\jdeq (A,f)$ be a type sequence. We define the type $A_\infty$ as a pushout
\begin{equation*}
\begin{tikzcd}[column sep=large]
\tilde{A}+\tilde{A} \arrow[r,"{[\idfunc,\sigma_{\mathcal{A}}]}"] \arrow[d,swap,"{[\idfunc,\idfunc]}"] & \tilde{A} \arrow[d,"\inr"] \\
\tilde{A} \arrow[r,swap,"\inl"] & A_\infty.
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{defn}
The type $A_\infty$ comes equipped with a cocone structure consisting of
\begin{align*}
\mathsf{seq\usc{}in} & : \prd{n:\N} A_n\to A_\infty \\
\mathsf{seq\usc{}glue} & : \prd{n:\N}{x:A_n} \mathsf{in}_n(x)=\mathsf{in}_{n+1}(f_n(x)).
\end{align*}
\end{defn}

\begin{constr}
We define
\begin{align*}
\mathsf{seq\usc{}in}(n,x)\defeq \inr(n,x) \\
\mathsf{seq\usc{}glue}(n,x)\defeq \ct{\glue(\inl(n,x))^{-1}}{\glue(\inr(n,x))}.
\end{align*}
\end{constr}

\begin{thm}
Consider a type sequence $\mathcal{A}$, and write $\tilde{A}\defeq\sm{n:\N}A_n$. Moreover, consider the map
\begin{equation*}
\sigma_{\mathcal{A}}:\tilde{A}\to\tilde{A}
\end{equation*}
defined by $\sigma_{\mathcal{A}}(n,a)\defeq (n+1,f_n(a))$. Furthermore, consider a cocone $(h,H)$ with vertex $B$.
The following are equivalent:
\begin{enumerate}
\item The cocone $(h,H)$ with vertex $B$ is colimiting.
\item The defining square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\tilde{A}+\tilde{A} \arrow[r,"{[\idfunc,\sigma_{\mathcal{A}}]}"] \arrow[d,swap,"{[\idfunc,\idfunc]}"] & \tilde{A} \arrow[d,"{\lam{(n,x)}h_n(x)}"] \\
\tilde{A} \arrow[r,swap,"{\lam{(n,x)}h_n(x)}"] & A_\infty,
\end{tikzcd}
\end{equation*}
of $A_\infty$ is a pushout square.
\end{enumerate}
\end{thm}

\subsection{Reflexive coequalizers}

\subsubsection{Reflexive graphs}
\begin{defn}
A \define{reflexive pair} consists of maps $s$, $t$, and $r$ between types $V$ and $E$, as indicated in the diagram
\begin{equation*}
\begin{tikzcd}[column sep=large]
E \arrow[r,yshift=1.5ex,"s"] \arrow[r,yshift=-1.5ex,swap,"t"] & V, \arrow[l,"r" description]
\end{tikzcd}
\end{equation*}
such that $H_{sr}:\idfunc[V]\htpy s\circ r$ and $H_{tr}:\idfunc[V]\htpy t\circ r$.
\end{defn} 

A reflexive pair determines the following structure, consisting of
a type $\pts{\Gamma}$, a type family $\edg{\Gamma}:\pts{\Gamma}\to\pts{\Gamma}\to\UU$,
and a term $\rfx{\Gamma}:\prd{i:\pts{\Gamma}}\edg{\Gamma}(i,i)$.
\begin{align*}
\pts{\Gamma} & \defeq V \\
\edg{\Gamma}(v,w) & \defeq \sm{e:E} (v=s(e))\times (w=t(e)) \\
\rfx{\Gamma}(v) & \defeq \pairr{r(v),H_{sr}(v),H_{tr}(v)}.
\end{align*}
This is what we call a reflexive type-valued graph:

\begin{defn}\label{defn:graphs_ctx}
A \define{reflexive graph} $\Gamma$ in $\UU$ is a triple $\pairr{\pts{\Gamma},\edg{\Gamma},\rfx{\Gamma}}$ consisting of
\begin{align*}
\pts{\Gamma} & : \UU \\
\edg{\Gamma} & : \pts{\Gamma}\to\pts{\Gamma}\to\UU \\
\rfx{\Gamma} & : \prd{i:\pts{\Gamma}}\edg{\Gamma}(i,i).
\end{align*}
When $\Gamma$ is a reflexive graph in $\UU$, we say that $\pts{\Gamma}$ is its type of \define{vertices}, that $\edg{\Gamma}$ is its family of \define{edges}, and that $\rfx{\Gamma}$ is the \define{proof of reflexivity} of $\Gamma$. We write
\begin{equation*}
\mathsf{rGph}\defeq \sm{V:\UU}{E:V\to (V\to\UU)}\prd{v:V}E(v,v)
\end{equation*}
for the type of (small) reflexive graphs. 
\end{defn}

\begin{thm}\label{thm:rpairs_rgraphs}
There function $\mathsf{rgph\usc{}rpair}:\mathsf{rPair}\to\mathsf{rGph}$ defined by
\begin{align*}
\pts{\mathsf{rgph\usc{}rpair}(V,E,s,t,r,H_{sr},H_{tr})} & \defeq V \\
\edg{\mathsf{rgph\usc{}rpair}(V,E,s,t,r,H_{sr},H_{tr})}(v,w) & \defeq \sm{e:E} (v=s(e))\times (w=t(e)) \\
\rfx{\Gamma}(v) & \defeq \pairr{r(v),H_{sr}(v),H_{tr}(v)},
\end{align*}
is an equivalence.
\end{thm}

\begin{proof}
Straightforward.
\end{proof}

We choose to work with reflexive graphs instead of reflexive pairs, because reflexive graphs are slightly easier to handle in dependent type theory. For instance, when working with a reflexive pair, one might have to deal with the fact that $H_{sr}$ and $H_{tr}$ are only homotopies, whereas in the case of reflexive graphs we use the type dependency to make sure that the source and target of $\rfx{\Gamma}(i)$ is exactly the vertex $i:\pts{\Gamma}$.

\begin{eg}\label{eg:running_graphs}
We will use the following basic examples throughout this article to illustrate the exposition.
\begin{enumerate}
\item \label{eg:disc_codisc} Given a type $X$, we have the \define{discrete graph} $\Delta(X)$ on $X$ consisting of
\begin{align*}
\pts{\Delta(X)} & \defeq X \\
\edg{\Delta(X)} & \defeq \idtypevar{X} \\
\rfx{\Delta(X)} & \defeq \refl{},
\end{align*}
and we have the \define{indiscrete graph} $\nabla(X)$ on $X$ consisting of
\begin{align*}
\pts{\nabla(X)} & \defeq X \\
\edg{\nabla(X)} & \defeq \lam{x}{y}\unit \\
\rfx{\nabla(X)} & \defeq \ttt.
\end{align*}
In particular, we have the \define{unit} graph $\unit\defeq\nabla(\unit)$, which happens to be equal to $\Delta(\unit)$. 
\item \label{eg:freerfx} Given a non-reflexive graph $\Gamma\jdeq\pairr{\pts{\Gamma},\edg{\Gamma}}$, we can obtain a reflexive graph $F(\Gamma)$ by freely adjoin reflexivity edges by taking
\begin{align*}
\pts{F(\Gamma)} & \defeq \pts{\Gamma} \\
\edg{F(\Gamma)}(i,j) & \defeq \edg{\Gamma}(i,j)+(i=j) \\
\rfx{F(\Gamma)}(i) & \defeq \inr(\refl{i}).
\end{align*}
Because of this construction, we restrict our attention to reflexive
graphs, with ordinary graphs as a special case. However, as we will see in \autoref{sec:refl-graph-quot} there are some essential differences that occur between graph quotients and reflexive graph quotients. For example, the graph quotient of the terminal non-reflexive graph is the circle, whereas the graph quotient of the terminal reflexive graph is contractible.
\item To give an example where one might use the non-trivial
  homotopical structure of a type in a graph, consider the graphs
  $\Gamma(n)$ given by
\begin{align*}
\pts{\Gamma(n)} & \defeq \bool \\
\edg{\Gamma(n)}(\bfalse,\btrue) & \defeq \sphere{n}
\end{align*}
and no other edges. Equivalently, the edges can be given as an inductive family of types over $\pts{\Gamma(n)}$ with a constructor of type $\sphere{n}\to\edg{\Gamma(n)}(\bfalse,\btrue)$. 
\item A span $X \leftarrow A \rightarrow Y$ consisting of $f:A\to X$ and $g:A\to Y$ defines a non-reflexive graph $\Gamma$ by
\begin{align*}
\pts{\Gamma} & \defeq X + Y \\
\edg{\Gamma}(\inl(x),\inr(y)) & \defeq \sm{a:A}\pairr{x,y}=\pairr{f(a),g(a)},
\end{align*}
and no other edges. Equivalently, the edges can be given as an inductive family of types over $\pts{\Gamma}$ with a constructor of type
\begin{equation*}
\prd{a:A}\edg{\Gamma}(\inl(f(a)),\inr(g(a))).
\end{equation*}
\item A \define{type sequence} in $\UU$ consists of a family $A:\N\to\UU$ and a family $f:\prd{n:\N} A_n\to A_{n+1}$. In other words, a type sequence represents data of the form
\begin{equation*}
\begin{tikzcd}
A_0 \arrow[r,"f_0"] & A_1 \arrow[r,"f_1"] & A_2 \arrow[r,"f_2"] & \cdots
\end{tikzcd}
\end{equation*}
From a type sequence we obtain a graph $\Gamma$ given by
\begin{align*}
\pts{\Gamma} & \defeq \sm{n:\N} A_n \\
\edg{\Gamma}(\pairr{n,x},\pairr{m,y}) & \defeq \pairr{m,y}=\pairr{n+1,f_n(x)}.
\end{align*}
Equivalently, the edges can be given as an inductive family of types over $\pts{\Gamma}$ with a constructor of type
\begin{equation*}
\prd{n:\N}{x:A_n}\edg{\Gamma}(\pairr{n,x},\pairr{n+1,f_n(x)}).
\end{equation*}
\item \label{eg:prekernel} The \define{pre-kernel} $\mathcal{K}(f)$ of a map $f:A\to X$ is defined to be the reflexive relation on $A$ given by
\begin{align*}
\edg{\mathcal{K}(f)}(a,a') & \defeq f(a) = f(a') \\
\rfx{\mathcal{K}(f)}(a) & \defeq \refl{f(a)}
\end{align*}
We call this relation the \emph{pre}-kernel, because we would like to reserve the name `kernel' for the pre-kernel together with the structure that it is an $\infty$-equivalence relation, according to some internal notion of $\infty$-equivalence relation.
\end{enumerate}
\end{eg}

\subsection{Colimits of diagrams over graphs}

\section{Descent}\label{sec:descent}

\subsection{Descent for pushouts}

\subsubsection{Type families over pushouts}

Given a pushout square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
with $H:i\circ f\htpy j\circ g$, and a family $P:X\to\UU$, we obtain
\begin{align*}
P\circ i & : A \to \UU \\
P\circ j & : B \to \UU \\
\lam{x}\mathsf{tr}_P(H(x)) & : \prd{x:S} \eqv{P(i(f(x)))}{P(j(g(x)))}.
\end{align*}
Our goal in the current section is to show that the triple $(P_A,P_B,P_S)$ consisting of $P_A\defeq P\circ i$, $P_B\defeq P\circ j$, and $P_S\defeq \lam{x}\mathsf{tr}_P(H(x))$ characterizes the family $P$ over $X$.

\begin{defn}
Consider a commuting square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
with $H:i\circ f\htpy j\circ g$, where all types involved are in $\UU$. The type $\mathsf{Desc}(\mathcal{S})$\index{Desc@{$\mathsf{Desc}(\mathcal{S})$}|textbf} of \define{descent data}\index{descent data|textbf} for $X$, is defined defined to be the type of triples $(P_A,P_B,P_S)$ consisting of
\begin{align*}
P_A & : A \to \UU \\
P_B & : B \to \UU \\
P_S & : \prd{x:S} \eqv{P_A(f(x))}{P_B(g(x))}.
\end{align*}
\end{defn}

\begin{defn}
Given a commuting square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
with $H:i\circ f\htpy j\circ g$, we define the map\index{desc_fam@{$\mathsf{desc\usc{}fam}_{\mathcal{S}}$}|textbf}
\begin{equation*}
\mathsf{desc\usc{}fam}_{\mathcal{S}}(i,j,H) : (X\to \UU)\to \mathsf{Desc}(\mathcal{S})
\end{equation*}
by $P\mapsto (P\circ i,P\circ j,\lam{x}\mathsf{tr}_P(H(x)))$.
\end{defn}

\begin{thm}\label{thm:desc_fam}
Consider a pushout square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
with $H:i\circ f\htpy j\circ g$, where all types involved are in $\UU$, and suppose we have
\begin{align*}
P_A & : A \to \UU \\
P_B & : B \to \UU \\
P_S & : \prd{x:S} \eqv{P_A(f(x))}{P_B(g(x))}.
\end{align*}
Then the function\index{desc_fam@{$\mathsf{desc\usc{}fam}_{\mathcal{S}}$}!is an equivalence|textit}
\begin{equation*}
\mathsf{desc\usc{}fam}_{\mathcal{S}}(i,j,H) : (X\to \UU)\to \mathsf{Desc}(\mathcal{S})
\end{equation*}
is an equivalence.
\end{thm}

\begin{proof}
By the 3-for-2 property of equivalences it suffices to construct an equivalence $\varphi:\mathsf{cocone}_{\mathcal{S}}(\UU)\to\mathsf{Desc}(\mathcal{S})$ such that the triangle
\begin{equation*}
\begin{tikzcd}
& \UU^X \arrow[dl,swap,"{\mathsf{cocone\usc{}map}_{\mathcal{S}}(i,j,H)}"] \arrow[dr,"{\mathsf{desc\usc{}fam}_{\mathcal{S}}(i,j,H)}"] \\
\mathsf{cocone}_{\mathcal{S}}(\UU) \arrow[rr,densely dotted,"\eqvsym","\varphi"'] & & \mathsf{Desc}(\mathcal{S})
\end{tikzcd}
\end{equation*}
commutes.

Since we have equivalences
\begin{equation*}
\mathsf{equiv\usc{}eq}:\eqv{\Big(P_A(f(x))=P_B(g(x))\Big)}{\Big(\eqv{P_A(f(x))}{P_B(g(x))}\Big)}
\end{equation*}
for all $x:S$, we obtain by \cref{ex:equiv_pi} an equivalence on the dependent products
\begin{equation*}
{\Big(\prd{x:S}P_A(f(x))=P_B(g(x))\Big)}\to{\Big(\prd{x:S}\eqv{P_A(f(x))}{P_B(g(x))}\Big)}.
\end{equation*}
We define $\varphi$ to be the induced map on total spaces. Explicitly, we have
\begin{equation*}
\varphi\defeq \lam{(P_A,P_B,K)}(P_A,P_B,\lam{x}\mathsf{equiv\usc{}eq}(K(x))).
\end{equation*}
Then $\varphi$ is an equivalence by \cref{thm:fib_equiv}, and the triangle commutes by \cref{ex:tr_ap}.
\end{proof}

\begin{cor}\label{cor:desc_fam}
Consider descent data $(P_A,P_B,P_S)$ for a pushout square as in \cref{thm:desc_fam}.
Then the type of quadruples $(P,e_A,e_B,e_S)$ consisting of a family $P:X\to\UU$ equipped with fiberwise equivalences
\begin{samepage}
\begin{align*}
e_A & : \prd{a:A}\eqv{P_A(a)}{P(i(a))} \\
e_B & : \prd{b:B}\eqv{P_B(a)}{P(j(b))}
\end{align*}
\end{samepage}%
and a homotopy $e_S$ witnessing that the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
P_A(f(x)) \arrow[r,"e_A(f(x))"] \arrow[d,swap,"P_S(x)"] & P(i(f(x))) \arrow[d,"\mathsf{tr}_P(H(x))"] \\
P_B(g(x)) \arrow[r,swap,"e_B(g(x))"] & P(j(g(x)))
\end{tikzcd}
\end{equation*}
commutes, is contractible.
\end{cor}

\begin{proof}
The fiber of this map at $(P_A,P_B,P_S)$ is equivalent to the type of quadruples $(P,e_A,e_B,e_S)$ as described in the theorem, which are contractible by \cref{thm:contr_equiv}.
\end{proof}

\subsubsection{The flattening lemma for pushouts}

In this section we consider a pushout square
\begin{equation*}
\begin{tikzcd}
S \arrow[r,"g"] \arrow[d,swap,"f"] & B \arrow[d,"j"] \\
A \arrow[r,swap,"i"] & X.
\end{tikzcd}
\end{equation*}
with $H:i\circ f\htpy j\circ g$, descent data
\begin{align*}
P_A & : A \to \UU \\
P_B & : B \to \UU \\
P_S & : \prd{x:S} \eqv{P_A(f(x))}{P_B(g(x))},
\end{align*}
and a family $P:X\to\UU$ equipped with 
\begin{align*}
e_A & : \prd{a:A}\eqv{P_A(a)}{P(i(a))} \\
e_B & : \prd{b:B}\eqv{P_B(a)}{P(j(b))}
\end{align*}
and a homotopy $e_S$ witnessing that the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
P_A(f(x)) \arrow[r,"e_A(f(x))"] \arrow[d,swap,"P_S(x)"] & P(i(f(x))) \arrow[d,"\mathsf{tr}_P(H(x))"] \\
P_B(g(x)) \arrow[r,swap,"e_B(g(x))"] & P(j(g(x)))
\end{tikzcd}
\end{equation*}
commutes.

\begin{defn}
We define a commuting square
\begin{equation*}
\begin{tikzcd}
\sm{x:S}P_A(f(x)) \arrow[d,swap,"{f'}"] \arrow[r,"{g'}"] & \sm{b:B}P_B(b) \arrow[d,"{j'}"] \\
\sm{a:A}P_A(a) \arrow[r,swap,"{i'}"] & \sm{x:X}P(x)
\end{tikzcd}
\end{equation*}
with a homotopy $H':i'\circ f'\htpy j'\circ g'$.
\end{defn}

\begin{constr}
We define
\begin{align*}
f' & \defeq \total[f]{\lam{x}\idfunc[P_A(f(x))]} \\
g' & \defeq \total[g]{e_S} \\
i' & \defeq \total[i]{e_A} \\
j' & \defeq \total[j]{e_B}.
\end{align*}
The remaining goal is to construct a homotopy $H':i'\circ f'\htpy j'\circ g'$. Thus, we have to show that
\begin{equation*}
(i(f(x)),e_A(y))=(j(g(x)),e_B(e_S(y)))
\end{equation*}
for any $x:S$ and $y:P_A(f(x))$. We have he identification
\begin{equation*}
\mathsf{eq\usc{}pair}(H(x),e_S(x,y)^{-1})
\end{equation*}
of this type.
\end{constr}

\begin{defn}
We will write $\mathcal{S'}$ for the span
\begin{equation*}
\begin{tikzcd}
\sm{a:A}P_A(a) & \sm{x:S}P_A(f(x)) \arrow[l,swap,"{f'}"] \arrow[r,"{g'}"] & \sm{b:B}P_B(b).
\end{tikzcd}
\end{equation*}
\end{defn}

\begin{lem}[The flattening lemma]\label{lem:flattening}
The commuting square\index{flattening lemma!for pushouts|textit}
\begin{equation*}
\begin{tikzcd}
\sm{x:S}P_A(f(x)) \arrow[d,swap,"{f'}"] \arrow[r,"{g'}"] & \sm{b:B}P_B(b) \arrow[d,"{j'}"] \\
\sm{a:A}P_A(a) \arrow[r,swap,"{i'}"] & \sm{x:X}P(x)
\end{tikzcd}
\end{equation*}
is a pushout square.
\end{lem}

\begin{proof}
We will show that the map
\begin{equation*}
\mathsf{cocone\usc{}map}_{\mathcal{S}'}(i',j',H'): \Big(\Big(\sm{x:X}P(x)\Big)\to Y\Big)\to \mathsf{cocone}_{\mathcal{S}'}(Y)
\end{equation*}
is an equivalence for any type $Y$.
Let $Y$ be a type. Note that the type $\mathsf{cocone}_{\mathcal{S}'}$ is equivalent to the type of triples $(u,v,w)$ consisting of
\begin{align*}
u & : \prd{a:A} P_A(a)\to Y \\
v & : \prd{b:B} P_B(b)\to Y \\
w & : \prd{x:S}{y:P_A(f(x))} u(f(x),y)=v(g(x),e_S(x,y)).
\end{align*}
Now observe that there is an equivalence
\begin{align*}
& \Big(\prd{y:P_A(f(x))} u(f(x),y)=v(g(x),e_S(x,y))\Big) \\
& \qquad \qquad \eqvsym \mathsf{tr}_{(t\mapsto P(t)\to Y)}(H(x),u'(f(x)))=v'(g(x))
\end{align*}
for any $u$ and $v$ as above, and any $x:S$. 
By this equivalence we obtain a commuting square
\begin{equation*}
\begin{tikzcd}
\Big(\Big({\sm{x:X}P(x)}\Big)\to Y\Big) \arrow[r,"\ind{\Sigma}","\eqvsym"'] \arrow[d,swap,"{\mathsf{cocone\usc{}map}_{\mathcal{S}'}(i',j',H')}"] & \prd{x:X}(P(x)\to Y) \arrow[d,"\mathsf{dgen}_{\mathcal{S}}"] \\
\mathsf{cocone}_{\mathcal{S}'}(Y) \arrow[r,"\eqvsym"] & \Psi
\end{tikzcd}
\end{equation*}
where $\Psi$ is the type of triples $(u',v',w')$ consisting of
\begin{align*}
u' & : \prd{a:A} P(i(a))\to Y \\
v' & : \prd{b:B} P(j(b))\to Y \\
w' & : \prd{x:S} \mathsf{tr}_{(t\mapsto P(t)\to Y)}(H(x),u'(f(x)))=v'(g(x)),
\end{align*}
Since the dependent action on generators $\mathsf{dgen}_{\mathcal{S}}$ is an equivalence it follows by the 3-for-2 property of equivalences that $\mathsf{cocone\usc{}map}_{\mathcal{S}'}(i',j',H')$ is an equivalence, as desired.
\end{proof}

\subsubsection{Commuting cubes}
\begin{defn}\label{defn:cube}
A \define{commuting cube}\index{commuting cube|textbf}
\begin{equation*}
\begin{tikzcd}
& A_{111} \arrow[dl] \arrow[dr] \arrow[d] \\
A_{110} \arrow[d] & A_{101} \arrow[dl] \arrow[dr] & A_{011} \arrow[dl,crossing over] \arrow[d] \\
A_{100} \arrow[dr] & A_{010} \arrow[d] \arrow[from=ul,crossing over] & A_{001} \arrow[dl] \\
& A_{000},
\end{tikzcd}
\end{equation*}
consists of 
\begin{enumerate}
\item types
\begin{equation*}
A_{111},A_{110},A_{101},A_{011},A_{100},A_{010},A_{001},A_{000},
\end{equation*}
\item \begin{samepage}%
maps
\begin{align*}
f_{11\check{1}} & : A_{111}\to A_{110} & f_{\check{1}01} & : A_{101}\to A_{001} \\
f_{1\check{1}1} & : A_{111}\to A_{101} & f_{01\check{1}} & : A_{011}\to A_{010} \\
f_{\check{1}11} & : A_{111}\to A_{011} & f_{0\check{1}1} & : A_{011}\to A_{001} \\
f_{1\check{1}0} & : A_{110}\to A_{100} & f_{\check{1}00} & : A_{100}\to A_{000} \\
f_{\check{1}10} & : A_{110}\to A_{010} & f_{0\check{1}0} & : A_{010}\to A_{000} \\
f_{10\check{1}} & : A_{101}\to A_{100} & f_{00\check{1}} & : A_{001}\to A_{000},
\end{align*}
\end{samepage}%
\item homotopies
\begin{align*}
H_{1\check{1}\check{1}} & : f_{1\check{1}0}\circ f_{11\check{1}} \htpy f_{10\check{1}}\circ f_{1\check{1}1} & H_{0\check{1}\check{1}} & : f_{0\check{1}0}\circ f_{01\check{1}} \htpy f_{00\check{1}}\circ f_{0\check{1}1} \\
H_{\check{1}1\check{1}} & : f_{\check{1}10}\circ f_{11\check{1}} \htpy f_{01\check{1}}\circ f_{\check{1}11} & H_{\check{1}0\check{1}} & : f_{\check{1}00}\circ f_{10\check{1}} \htpy f_{00\check{1}}\circ f_{\check{1}01} \\
H_{\check{1}\check{1}1} & : f_{\check{1}01}\circ f_{1\check{1}1} \htpy f_{0\check{1}1}\circ f_{\check{1}11} & H_{\check{1}\check{1}0} & : f_{\check{1}00}\circ f_{1\check{1}0} \htpy f_{0\check{1}0}\circ f_{\check{1}10},
\end{align*}
\item and a homotopy 
\begin{align*}
C & : \ct{(f_{\check{1}00}\cdot H_{1\check{1}\check{1}})}{(\ct{(H_{\check{1}0\check{1}}\cdot f_{1\check{1}1})}{(f_{00\check{1}}\cdot H_{\check{1}\check{1}1})})} \\
& \qquad \htpy \ct{(H_{\check{1}\check{1}0}\cdot f_{11\check{1}})}{(\ct{(f_{0\check{1}0}\cdot H_{\check{1}1\check{1}})}{(H_{0\check{1}\check{1}}\cdot f_{\check{1}11})})}
\end{align*}
filling the cube.
\end{enumerate}
\end{defn}

\begin{lem}
Given a commuting cube as in \cref{defn:cube} we obtain a commuting square
\begin{equation*}
\begin{tikzcd}
\fib{f_{1\check{1}1}}{x} \arrow[r] \arrow[d] & \fib{f_{0\check{1}1}}{f_{\check{1}01}(x)} \arrow[d] \\
\fib{f_{1\check{1}0}}{f_{10\check{1}}(x)} \arrow[r] & \fib{f_{0\check{1}0}}{f_{00\check{1}}(x)}
\end{tikzcd}
\end{equation*}
for any $x:A_{101}$. 
\end{lem}

\begin{lem}
Consider a commuting cube
\begin{equation*}
\begin{tikzcd}
& A_{111} \arrow[dl] \arrow[dr] \arrow[d] \\
A_{110} \arrow[d] & A_{101} \arrow[dl] \arrow[dr] & A_{011} \arrow[dl,crossing over] \arrow[d] \\
A_{100} \arrow[dr] & A_{010} \arrow[d] \arrow[from=ul,crossing over] & A_{001} \arrow[dl] \\
& A_{000}.
\end{tikzcd}
\end{equation*}
If the bottom and front right squares are pullback squares, then the back left square is a pullback if and only if the top square is.
\end{lem}

\begin{rmk}
By rotating the cube we also obtain:
\begin{enumerate}
\item If the bottom and front left squares are pullback squares, then the back right square is a pullback if and only if the top square is.
\item If the front left and front right squares are pullback, then the back left square is a pullback if and only if the back right square is.
\end{enumerate}
By combining these statements it also follows that if the front left, front right, and bottom squares are pullback squares, then if any of the remaining three squares are pullback squares, all of them are. Cubes that consist entirely of pullback squares are sometimes called \define{strongly cartesian}\index{strongly cartesian cube}.
\end{rmk}

\subsubsection{The descent property for pushouts}

In the previous section there was a significant role for fiberwise equivalences, and we know by \cref{thm:pb_fibequiv,cor:pb_fibequiv}: fiberwise equivalences indicate the presence of pullbacks. In this section we reformulate the results of the previous section using pullbacks where we used fiberwise equivalences before, to obtain new and useful results. We begin by considering the type of descent data from the perspective of pullback squares.

\begin{defn}
Consider a span $\mathcal{S}$ from $A$ to $B$, and a span $\mathcal{S}'$ from $A'$ to $B'$. A \define{cartesian transformation}of spans\index{cartesian transformation!of spans|textbf} from $\mathcal{S}'$ to $\mathcal{S}$ is a diagram of the form
\begin{equation*}
\begin{tikzcd}
A' \arrow[d,swap,"h_A"]  & S' \arrow[l,swap,"{f'}"] \arrow[r,"{g'}"] \arrow[d,swap,"h_S"] & B' \arrow[d,"h_B"] \\
A & S \arrow[l,"f"] \arrow[r,swap,"g"] & B
\end{tikzcd}
\end{equation*}
with $F:f\circ h_S\htpy h_A\circ f'$ and $G:g\circ h_S\htpy h_B\circ g'$, where both squares are pullback squares. 

The type $\mathsf{cart}(\mathcal{S}',\mathcal{S})$\index{cart(S,S')@{$\mathsf{cart}(\mathcal{S},\mathcal{S}')$}|textbf} of cartesian transformation is the type of tuples
\begin{equation*}
(h_A,h_S,h_B,F,G,p_f,p_g)
\end{equation*}
where $p_f:\mathsf{is\usc{}pullback}(h_S,h_A,F)$ and $p_g:\mathsf{is\usc{}pullback}(h_S,h_B,G)$, and we write
\begin{equation*}
\mathsf{Cart}(\mathcal{S}) \defeq \sm{A',B':\UU}{\mathcal{S}':\mathsf{span}(A',B')}\mathsf{cart}(\mathcal{S}',\mathcal{S}).
\end{equation*}
\end{defn}

\begin{lem}\label{lem:cart_desc}
There is an equivalence\index{cart_desc@{$\mathsf{cart\usc{}desc}_{\mathcal{S}}$}|textit}
\begin{equation*}
\mathsf{cart\usc{}desc}_{\mathcal{S}}:\mathsf{Desc}(\mathcal{S})\to \mathsf{Cart}(\mathcal{S}).
\end{equation*}
\end{lem}

\begin{proof}
Note that by \cref{thm:pb_fibequiv_complete} it follows that the types of triples $(f',F,p_f)$ and $(g',G,p_g)$ are equivalent to the types of fiberwise equivalences
\begin{align*}
& \prd{x:S}\eqv{\fib{h_S}{x}}{\fib{h_A}{f(x)}} \\
& \prd{x:S}\eqv{\fib{h_S}{x}}{\fib{h_B}{g(x)}}
\end{align*} 
respectively. Furthermore, by \cref{thm:fam_proj} the types of pairs $(S',h_S)$, $(A',h_A)$, and $(B',h_B)$ are equivalent to the types $S\to \UU$, $A\to \UU$, and $B\to \UU$, respectively. Therefore it follows that the type $\mathsf{Cart}(\mathcal{S})$ is equivalent to the type of tuples $(Q,P_A,\varphi,P_B,P_S)$ consisting of
\begin{align*}
Q & : S\to \UU \\
P_A & : A \to \UU \\
P_B & : B \to \UU \\
\varphi & : \prd{x:S}\eqv{Q(x)}{P_A(f(x))} \\
P_S & : \prd{x:S}\eqv{Q(x)}{P_B(g(x))}.
\end{align*}
However, the type of $\varphi$ is equivalent to the type $P_A\circ f=Q$. Thus we see that the type of pairs $(Q,\varphi)$ is contractible, so our claim follows.
\end{proof}

\begin{defn}
We define an operation\index{cart map!{$\mathsf{cart\usc{}map}_{\mathcal{S}}$}|textbf}
\begin{equation*}
\mathsf{cart\usc{}map}_{\mathcal{S}}:{\Big(\sm{X':\UU}X'\to X\Big)}\to \mathsf{Cart}(\mathcal{S}).
\end{equation*}
\end{defn}

\begin{constr}
Let $X':\UU$ and $h_X:X'\to X$. Then we define the types
\begin{align*}
A' & \defeq A\times_X X' \\
B' & \defeq B\times_X X'.
\end{align*}
Next, we define a span $\mathcal{S'}\defeq(S',f',g')$ from $A'$ to $B'$. We take
\begin{align*}
S' & \defeq S\times_A A' \\
f' & \defeq \pi_2.
\end{align*}
To define $g'$, let $s:S$, let $(a,x',p):A\times_X X'$, and let $q:f(s)=a$. Our goal is to construct a term of type $B\times_X X'$. We have $g(s):B$ and $x':X'$, so it remains to show that $j(g(s))=h_X(x')$. We construct such an identification as a concatenation
\begin{equation*}
\begin{tikzcd}
j(g(s)) \arrow[r,equals,"H(s)^{-1}"] &[1ex] i(f(s)) \arrow[r,equals,"\ap{i}{q}"] &[1ex] i(a) \arrow[r,equals,"p"] & h_X(x').
\end{tikzcd}
\end{equation*}
To summaze, the map $g'$ is defined as
\begin{equation*}
g' \defeq \lam{(s,(a,x',p),q)}(g(s),x',\ct{H(s)^{-1}}{(\ct{\ap{i}{q}}{p})}).
\end{equation*}
Then we have commuting squares
\begin{equation*}
\begin{tikzcd}
A\times_X X' \arrow[d] & S\times_A A' \arrow[d] \arrow[l] \arrow[r] & B\times_X X' \arrow[d] \\
A & S \arrow[l] \arrow[r] & B.
\end{tikzcd}
\end{equation*}
Moreover, these squares are pullback squares by \cref{thm:pb_pasting}.
\end{constr}

The following theorem is analogous to \cref{thm:desc_fam}.

\begin{thm}[The descent theorem for pushouts]\label{thm:cart_map}\index{descent theorem!for pushouts|textit}
The operation $\mathsf{cart\usc{}map}_{\mathcal{S}}$\index{cart map!{$\mathsf{cart\usc{}map}_{\mathcal{S}}$}!is an equivalence|textit} is an equivalence
\begin{equation*}
\eqv{\Big(\sm{X':\UU}X'\to X\Big)}{\mathsf{Cart}(\mathcal{S})}
\end{equation*}
\end{thm}

\begin{proof}
It suffices to show that the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
X\to \UU \arrow[r,"{\mathsf{desc\usc{}fam}_{\mathcal{S}}(i,j,H)}"] \arrow[d,swap,"\mathsf{map\usc{}fam}_X"] & \mathsf{Desc}(\mathcal{S}) \arrow[d,"\mathsf{cart\usc{}desc}_{\mathcal{S}}"] \\
\sm{X':\UU}X'\to X \arrow[r,swap,"\mathsf{cart\usc{}map}_{\mathcal{S}}"] & \mathsf{Cart}(\mathcal{S})
\end{tikzcd}
\end{equation*}
commutes. To see that this suffices, note that the operation $\mathsf{map\usc{}fam}_X$ is an equivalence by \cref{thm:fam_proj}, the operation $\mathsf{desc\usc{}fam}_{\mathcal{S}}(i,j,H)$ is an equivalence by \cref{thm:desc_fam}, and the operation $\mathsf{cart\usc{}desc}_{\mathcal{S}}$ is an equivalence by \cref{lem:cart_desc}.

To see that the square commutes, note that the composite
\begin{equation*}
\mathsf{cart\usc{}map}_{\mathcal{S}}\circ \mathsf{map\usc{}fam}_X
\end{equation*}
takes a family $P:X\to \UU$ to the cartesian transformation of spans
\begin{equation*}
\begin{tikzcd}
A\times_X\tilde{P} \arrow[d,swap,"\pi_1"] & S\times_A\Big(A\times_X\tilde{P}\Big) \arrow[l] \arrow[r] \arrow[d,swap,"\pi_1"] & B\times_X\tilde{P} \arrow[d,"\pi_1"] \\
A & S \arrow[l] \arrow[r] & B,
\end{tikzcd}
\end{equation*}
where $\tilde{P}\defeq\sm{x:X}P(x)$.

The composite 
\begin{equation*}
\mathsf{cart\usc{}desc}_{\mathcal{S}}\circ \mathsf{desc\usc{}fam}_X
\end{equation*}
takes a family $P:X\to \UU$ to the cartesian transformation of spans
\begin{equation*}
\begin{tikzcd}
\sm{a:A}P(i(a)) \arrow[d] & \sm{s:S}P(i(f(s))) \arrow[l] \arrow[r] \arrow[d] & \sm{b:B}P(j(b)) \arrow[d] \\
A & S \arrow[l] \arrow[r] & B
\end{tikzcd}
\end{equation*}
These cartesian natural transformations are equal by \cref{lem:pb_subst}
\end{proof}

Since $\mathsf{cart\usc{}map}_{\mathcal{S}}$ is an equivalence it follows that its fibers are contractible. This is essentially the content of the following corollary.

\begin{cor}
Consider a diagram of the form 
\begin{equation*}
\begin{tikzcd}
& S' \arrow[d,swap,"h_S"] \arrow[dl,swap,"{f'}"] \arrow[dr,"{g'}"] \\
A' \arrow[d,swap,"h_A"] & S \arrow[dl,swap,"f"] \arrow[dr,"g"] & B' \arrow[d,"{h_B}"] \\
A \arrow[dr,swap,"i"] & & B \arrow[dl,"j"] \\
& X
\end{tikzcd}
\end{equation*}
with homotopies
\begin{align*}
F & : f\circ h_S \htpy h_A\circ f' \\
G & : g\circ h_S \htpy h_B\circ g' \\
H & : i\circ f \htpy j\circ g,
\end{align*}
and suppose that the bottom square is a pushout square, and the top squares are pullback squares.
Then the type of tuples $((X',h_X),(i',I,p),(j',J,q),(H',C))$ consisting of
\begin{enumerate}
\item A type $X':\UU$ together with a morphism
\begin{equation*}
h_X : X'\to X,
\end{equation*}
\item A map $i':A'\to X'$, a homotopy $I:i\circ h_A\htpy h_X\circ i'$, and a term $p$ witnessing that the square
\begin{equation*}
\begin{tikzcd}
A' \arrow[d,swap,"h_A"] \arrow[r,"{i'}"] & X' \arrow[d,"h_X"] \\
A \arrow[r,swap,"i"] & X
\end{tikzcd}
\end{equation*}
is a pullback square.
\item A map $j':B'\to X'$, a homotopy $J:j\circ h_B\htpy h_X\circ j'$, and a term $q$ witnessing that the square
\begin{equation*}
\begin{tikzcd}
B' \arrow[d,swap,"h_B"] \arrow[r,"{j'}"] & X' \arrow[d,"h_X"] \\
B \arrow[r,swap,"j"] & X
\end{tikzcd}
\end{equation*}
is a pullback square,
\item A homotopy $H':i'\circ f'\htpy j'\circ g'$, and a homotopy
\begin{equation*}
C : \ct{(i\cdot F)}{(\ct{(I\cdot f')}{(h_X\cdot H')})} \htpy \ct{(H\cdot h_S)}{(\ct{(j\cdot G)}{(J\cdot g')})}
\end{equation*}
witnessing that the cube
\begin{equation*}
\begin{tikzcd}
& S' \arrow[dl] \arrow[dr] \arrow[d] \\
A' \arrow[d] & S \arrow[dl] \arrow[dr] & B' \arrow[dl,crossing over] \arrow[d] \\
A \arrow[dr] & X' \arrow[d] \arrow[from=ul,crossing over] & B \arrow[dl] \\
& X,
\end{tikzcd}
\end{equation*}
commutes,
\end{enumerate}
is contractible.
\end{cor}

The following theorem should be compared to the flattening lemma, \cref{lem:flattening}.\index{flattening lemma!for pushouts}

\begin{thm}
Consider a commuting cube
\begin{equation*}
\begin{tikzcd}
& S' \arrow[dl,swap,"{f'}"] \arrow[dr,"{g'}"] \arrow[d,"h_S"] \\
A' \arrow[d,swap,"h_A"] & S \arrow[dl,swap,"f" near start] \arrow[dr,"g" near start] & B' \arrow[dl,crossing over,"{j'}" near end] \arrow[d,"h_B"] \\
A \arrow[dr,swap,"i"] & X' \arrow[d,"h_X" near start] \arrow[from=ul,crossing over,"{i'}"' near end] & B \arrow[dl,"j"] \\
& X.
\end{tikzcd}
\end{equation*}
If each of the vertical squares is a pullback, and the bottom square  is a pushout, then the top square is a pushout.
\end{thm}

\begin{proof}
By \cref{cor:pb_fibequiv} we have fiberwise equivalences
\begin{align*}
F & : \prd{x:S}\eqv{\fib{h_S}{x}}{\fib{h_A}{f(x)}} \\
G & : \prd{x:S}\eqv{\fib{h_S}{x}}{\fib{h_B}{g(x)}} \\
I & : \prd{a:A}\eqv{\fib{h_A}{a}}{\fib{h_X}{i(a)}} \\
J & : \prd{b:B}\eqv{\fib{h_B}{b}}{\fib{h_X}{j(b)}}. 
\end{align*}
Moreover, since the cube commutes we obtain a fiberwise homotopy
\begin{equation*}
K : \prd{x:S} I(f(x))\circ F(x) \htpy J(g(x))\circ G(x).
\end{equation*}
We define the descent data $(P_A,P_B,P_S)$ consisting of $P_A:A\to\UU$, $P_B:B\to\UU$, and $P_S:\prd{x:S}\eqv{P_A(f(x))}{P_B(g(x))}$ by
\begin{align*}
P_A(a) & \defeq \fib{h_A}{a} \\
P_B(b) & \defeq \fib{h_B}{b} \\
P_S(x) & \defeq G(x)\circ F(x)^{-1}.
\end{align*}
We have
\begin{align*}
P & \defeq \fibf{h_X} \\
e_A & \defeq I \\
e_B & \defeq J \\
e_S & \defeq K.
\end{align*}
Now consider the diagram
\begin{equation*}
\begin{tikzcd}
\sm{s:S}\fib{h_S}{s} \arrow[r] \arrow[d] & \sm{s:S}\fib{h_A}{f(s)} \arrow[r] \arrow[d] & \sm{b:B}\fib{h_B}{b} \arrow[d] \\
\sm{a:A}\fib{h_A}{a} \arrow[r] & \sm{a:A}\fib{h_A}{a} \arrow[r] & \sm{x:X}\fib{h_X}{x}
\end{tikzcd}
\end{equation*}
Since the top and bottom map in the left square are equivalences, we obtain from \cref{ex:pushout_equiv} that the left square is a pushout square. Moreover, the right square is a pushout by \cref{lem:flattening}. Therefore it follows by \cref{thm:pushout_pasting} that the outer rectangle is a pushout square.

Now consider the commuting cube
\begin{equation*}
\begin{tikzcd}
& \sm{s:S}\fib{h_S}{s} \arrow[dl] \arrow[dr] \arrow[d] \\
\sm{a:A}\fib{h_A}{a} \arrow[d] & S' \arrow[dl] \arrow[dr] & \sm{b:B}\fib{h_B}{b} \arrow[dl,crossing over] \arrow[d] \\
A' \arrow[dr,swap] & \sm{x:X}\fib{h_X}{x} \arrow[d] \arrow[from=ul,crossing over] & B' \arrow[dl] \\
& X'.
\end{tikzcd}
\end{equation*}
We have seen that the top square is a pushout. The vertical maps are all equivalences, so the vertical squares are all pushout squares. Thus it follows from one more application of \cref{thm:pushout_pasting} that the bottom square is a pushout.
\end{proof}

%\begin{cor}
%For any map $f:A\sqcup^S B\to X$, and any $x:X$, the square
%\begin{equation*}
%\begin{tikzcd}
%\fib{f_S}{x} \arrow[r] \arrow[d] & \fib{f_B}{x} \arrow[d] \\
%\fib{f_A}{x} \arrow[r] & \fib{f}{x}
%\end{tikzcd}
%\end{equation*}
%is a pushout square.
%\end{cor}

\begin{thm}\label{thm:pb_pushout}
Consider a commuting cube of types 
\begin{equation*}\label{eq:cube}
\begin{tikzcd}
& S' \arrow[dl] \arrow[dr] \arrow[d] \\
A' \arrow[d] & S \arrow[dl] \arrow[dr] & B' \arrow[dl,crossing over] \arrow[d] \\
A \arrow[dr] & X' \arrow[d] \arrow[from=ul,crossing over] & B \arrow[dl] \\
& X,
\end{tikzcd}
\end{equation*}
and suppose the vertical squares are pullback squares. Then the commuting square
\begin{equation*}
\begin{tikzcd}
A' \sqcup^{S'} B' \arrow[r] \arrow[d] & X' \arrow[d] \\
A\sqcup^{S} B \arrow[r] & X
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{thm}

\begin{proof}
It suffices to show that the pullback 
\begin{equation*}
(A\sqcup^{S} B)\times_{X}X'
\end{equation*}
has the universal property of the pushout. This follows by the descent theorem, since the vertical squares in the cube
\begin{equation*}
\begin{tikzcd}
& S' \arrow[dl] \arrow[dr] \arrow[d] \\
A' \arrow[d] & S \arrow[dl] \arrow[dr] & B' \arrow[dl,crossing over] \arrow[d] \\
A \arrow[dr] & (A\sqcup^{S} B)\times_{X}X' \arrow[d] \arrow[from=ul,crossing over] & B \arrow[dl] \\
& A\sqcup^{S} B
\end{tikzcd}
\end{equation*}
are pullback squares by \cref{thm:pb_pasting}.
\end{proof}

\begin{eg}
We list the following applications of \cref{thm:pb_pushout}:
\begin{enumerate}
\item Using the characterization of the circle as a pushout given in \cref{eg:circle_pushout} we see that the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
\sphere{1}+\sphere{1} \arrow[r,"{[\idfunc,\idfunc]}"] \arrow[d,swap,"{[\idfunc,\idfunc]}"] & \sphere{1} \arrow[d,"{\lam{t}(t,\base)}"] \\
\sphere{1} \arrow[r,swap,"{\lam{t}(t,\base)}"] & \sphere{1}\times\sphere{1}
\end{tikzcd}
\end{equation*}
is a pushout square.
\item Let $f:A\to B$ be a map. The \define{codiagonal}\index{codiagonal}\index{nabla@{$\nabla_f$}} $\nabla_f$ of $f$ is the map obtained from the universal property of the pushout, as indicated in the diagram
\begin{equation*}
\begin{tikzcd}
A \arrow[d,swap,"f"] \arrow[r,"f"] \arrow[dr, phantom, "\ulcorner", very near end] & B \arrow[d,"\inr"] \arrow[ddr,bend left=15,"{\idfunc[B]}"] \\
A \arrow[r,"\inl"] \arrow[drr,bend right=15,swap,"{\idfunc[B]}"] & B\sqcup^{A} B \arrow[dr,densely dotted,near start,swap,"\nabla_f"] \\
& & B
\end{tikzcd}
\end{equation*}
There is an equivalence $\fib{\nabla_f}{b}\eqvsym \susp(\fib{f}{b})$ for any $b:B$.
\item \label{ex:fib_join}Consider two maps $f:A\to X$ and $g:B\to X$. The \define{fiberwise join}\index{fiberwise join} $\join{f}{g}$ is defined by the universal property of the pushout as the unique map rendering the diagram
\begin{equation*}
\begin{tikzcd}
A\times_X B \arrow[d,"\pi_1"] \arrow[r,"\pi_2"] \arrow[dr, phantom, "\ulcorner", very near end] & B \arrow[d,"\inr"] \arrow[ddr,bend left=15,"g"] \\
A \arrow[r,"\inl"] \arrow[drr,bend right=15,swap,"f"] & \join[X]{A}{B} \arrow[dr,densely dotted,near start,swap,"\join{f}{g}"] \\
& & X
\end{tikzcd}
\end{equation*}
commutative, where $\join[X]{A}{B}$ is defined as a pushout, as indicated.
Construct an equivalence
\begin{equation*}
\eqv{\fib{\join{f}{g}}{x}}{\join{\fib{f}{x}}{\fib{g}{x}}}
\end{equation*}
for any $x:X$. 
\item Consider two maps $f:A\to B$ and $g:C\to D$.
The \define{pushout-product}\index{pushout-product}
\begin{equation*}
f\square g : (A\times D)\sqcup^{A\times C} (B\times C)\to B\times D
\end{equation*}
of $f$ and $g$ is defined by the universal property of the pushout as the unique map rendering the diagram
\begin{equation*}
\begin{tikzcd}
A\times C \arrow[r,"{f\times \idfunc[C]}"] \arrow[d,swap,"{\idfunc[A]\times g}"] & B\times C \arrow[d,"\inr"] \arrow[ddr,bend left=15,"{\idfunc[B]\times g}"] \\
A\times D \arrow[r,"\inl"] \arrow[drr,bend right=15,swap,"{f\times\idfunc[D]}"] & (A\times D)\sqcup^{A\times C} (B\times C) \arrow[dr,densely dotted,swap,near start,"f\square g"] \\
& & B\times D
\end{tikzcd}
\end{equation*}
commutative. Construct an equivalence
\begin{equation*}
\eqv{\fib{f\square g}{b,d}}{\join{\fib{f}{b}}{\fib{g}{d}}}
\end{equation*}
for all $b:B$ and $d:D$.
\item Let $A$ and $B$ be pointed types with base points $a_0:A$ and $b_0:B$. The \define{wedge inclusion}\index{wedge inclusion} is defined as follows by the universal property of the wedge:
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\unit \arrow[r] \arrow[d] & B \arrow[d,"\inr"] \arrow[ddr,bend left=15,"{\lam{b}(a_0,b)}"] \\
A \arrow[r,"\inl"] \arrow[drr,bend right=15,swap,"{\lam{a}(a,b_0)}"] & A\vee B \arrow[dr,densely dotted,swap,"{\mathsf{wedge\usc{}in}_{A,B}}"{near start,xshift=1ex}] \\
& & A\times B
\end{tikzcd}
\end{equation*}
The fiber of the wedge inclusion $A\vee B\to A\times B$ is equivalent to $\join{\loopspace{B}}{\loopspace{A}}$.
\item Let $f:X\vee X\to X$ be the map defined by the universal property of the wedge as indicated in the diagram
\begin{equation*}
\begin{tikzcd}
\unit \arrow[d,swap,"x_0"] \arrow[r,"x_0"] \arrow[dr, phantom, "\ulcorner", very near end] & X \arrow[d,"\inr"] \arrow[ddr,bend left=15,"{\idfunc[X]}"] \\
X \arrow[r,"\inl"] \arrow[drr,bend right=15,swap,"{\idfunc[X]}"] & X\vee X \arrow[dr,densely dotted,near start,swap,"f"] \\
& & X.
\end{tikzcd}
\end{equation*}
Show that $\eqv{\fib{f}{x_0}}{\susp\loopspace{X}}$. 
\end{enumerate}
\end{eg}

\subsection{Descent for sequential colimits}

\begin{defn}
The type of \define{descent data} on a type sequence $\mathcal{A}\jdeq (A,f)$ is defined to be
\begin{equation*}
\mathsf{Desc}(\mathcal{A}) \defeq \sm{B:\prd{n:\N}A_n\to\UU}\prd{n:\N}{x:A_n}\eqv{B_n(x)}{B_{n+1}(f_n(x))}.
\end{equation*}
\end{defn}

\begin{defn}
We define a map
\begin{equation*}
\mathsf{desc\usc{}fam} : (A_\infty\to\UU)\to\mathsf{Desc}(\mathcal{A})
\end{equation*}
by $B\mapsto (\lam{n}{x}B(\mathsf{seq\usc{}in}(n,x)),\lam{n}{x}\mathsf{tr}_B(\mathsf{seq\usc{}glue}(n,x)))$.
\end{defn}

\begin{thm}
The map 
\begin{equation*}
\mathsf{desc\usc{}fam} : (A_\infty\to\UU)\to\mathsf{Desc}(\mathcal{A})
\end{equation*}
is an equivalence.
\end{thm}

\begin{defn}
A \define{cartesian transformation} of type sequences from $\mathcal{A}$ to $\mathcal{B}$ is a pair $(h,H)$ consisting of
\begin{align*}
h & : \prd{n:\N} A_n\to B_n \\
H & : \prd{n:\N} g_n\circ h_n \htpy h_{n+1}\circ f_n,
\end{align*}
such that each of the squares in the diagram
\begin{equation*}
\begin{tikzcd}
A_0 \arrow[d,swap,"h_0"] \arrow[r,"f_0"] & A_1 \arrow[d,swap,"h_1"] \arrow[r,"f_1"] & A_2 \arrow[d,swap,"h_2"] \arrow[r,"f_2"] & \cdots \\
B_0 \arrow[r,swap,"g_0"] & B_1 \arrow[r,swap,"g_1"] & B_2 \arrow[r,swap,"g_2"] & \cdots
\end{tikzcd}
\end{equation*}
is a pullback square. We define
\begin{align*}
\mathsf{cart}(\mathcal{A},\mathcal{B}) & \defeq\sm{h:\prd{n:\N}A_n\to B_n} \\
& \qquad\qquad \sm{H:\prd{n:\N}g_n\circ h_n\htpy h_{n+1}\circ f_n}\prd{n:\N}\mathsf{is\usc{}pullback}(h_n,f_n,H_n),
\end{align*}
and we write
\begin{equation*}
\mathsf{Cart}(\mathcal{B}) \defeq \sm{\mathcal{A}:\mathsf{Seq}}\mathsf{cart}(\mathcal{A},\mathcal{B}).
\end{equation*}
\end{defn}

\begin{defn}
We define a map
\begin{equation*}
\mathsf{cart\usc{}map}(\mathcal{B}) : \Big(\sm{X':\UU}X'\to X\Big)\to\mathsf{Cart}(\mathcal{B}).
\end{equation*}
which associates to any morphism $h:X'\to X$ a cartesian transformation of type sequences into $\mathcal{B}$.
\end{defn}

\begin{thm}
The operation $\mathsf{cart\usc{}map}(\mathcal{B})$ is an equivalence.
\end{thm}

\subsection{The flattening lemma for sequential colimits}

The flattening lemma for sequential colimits essentially states that sequential colimits commute with $\Sigma$. 

\begin{lem}
Consider
\begin{align*}
B & : \prd{n:\N}A_n\to\UU \\
g & : \prd{n:\N}{x:A_n}\eqv{B_n(x)}{B_{n+1}(f_n(x))}.
\end{align*}
and suppose $P:A_\infty\to\UU$ is the unique family equipped with
\begin{align*}
e & : \prd{n:\N}\eqv{B_n(x)}{P(\mathsf{seq\usc{}in}(n,x))}
\end{align*}
and homotopies $H_n(x)$ witnessing that the square
\begin{equation*}
\begin{tikzcd}[column sep=7em]
B_n(x) \arrow[r,"g_n(x)"] \arrow[d,swap,"e_n(x)"] & B_{n+1}(f_n(x)) \arrow[d,"e_{n+1}(f_n(x))"] \\
P(\mathsf{seq\usc{}in}(n,x)) \arrow[r,swap,"{\mathsf{tr}_P(\mathsf{seq\usc{}glue}(n,x))}"] & P(\mathsf{seq\usc{}in}(n+1,f_n(x)))
\end{tikzcd}
\end{equation*}
commutes. Then $\sm{t:A_\infty}P(t)$ satisfies the universal property of the sequential colimit of the type sequence
\begin{equation*}
\begin{tikzcd}
\sm{x:A_0}B_0(x) \arrow[r,"{\total[f_0]{g_0}}"] & \sm{x:A_1}B_1(x) \arrow[r,"{\total[f_1]{g_1}}"] & \sm{x:A_2}B_2(x) \arrow[r,"{\total[f_2]{g_2}}"] & \cdots.
\end{tikzcd}
\end{equation*}
\end{lem}

In the following theorem we rephrase the flattening lemma in using cartesian transformations of type sequences.

\begin{thm}
Consider a commuting diagram of the form
\begin{equation*}
\begin{tikzcd}[column sep=small,row sep=small]
A_0 \arrow[rr] \arrow[dd] & & A_1 \arrow[rr] \arrow[dr] \arrow[dd] &[-.9em] &[-.9em] A_2 \arrow[dl] \arrow[dd] & & \cdots \\
& & & X \arrow[from=ulll,crossing over] \arrow[from=urrr,crossing over] \arrow[from=ur,to=urrr] \\
B_0 \arrow[rr] \arrow[drrr] & & B_1 \arrow[rr] \arrow[dr] & & B_2 \arrow[rr] \arrow[dl] & & \cdots \arrow[dlll] \\
& & & Y \arrow[from=uu,crossing over] 
\end{tikzcd}
\end{equation*}
If each of the vertical squares is a pullback square, and $Y$ is the sequential colimit of the type sequence $B_n$, then $X$ is the sequential colimit of the type sequence $A_n$. 
\end{thm}

\begin{cor}
Consider a commuting diagram of the form
\begin{equation*}
\begin{tikzcd}[column sep=small,row sep=small]
A_0 \arrow[rr] \arrow[dd] & & A_1 \arrow[rr] \arrow[dr] \arrow[dd] &[-.9em] &[-.9em] A_2 \arrow[dl] \arrow[dd] & & \cdots \\
& & & X \arrow[from=ulll,crossing over] \arrow[from=urrr,crossing over] \arrow[from=ur,to=urrr] \\
B_0 \arrow[rr] \arrow[drrr] & & B_1 \arrow[rr] \arrow[dr] & & B_2 \arrow[rr] \arrow[dl] & & \cdots \arrow[dlll] \\
& & & Y \arrow[from=uu,crossing over] 
\end{tikzcd}
\end{equation*}
If each of the vertical squares is a pullback square, then the square
\begin{equation*}
\begin{tikzcd}
A_\infty \arrow[r] \arrow[d] & X \arrow[d] \\
B_\infty \arrow[r] & Y
\end{tikzcd}
\end{equation*} 
is a pullback square.
\end{cor}

\subsection{Descent for reflexive coequalizers}
